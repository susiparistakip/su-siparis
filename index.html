<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Su SipariÅŸ Takip (Telefon)</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’§</text></svg>">

    <style>
        :root {
            --bg: #020617;
            --panel: rgba(15, 23, 42, 0.96);
            --stroke: rgba(148, 163, 184, 0.35);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --cyan1: #22d3ee;
            --cyan2: #0ea5e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI';
        }

        /* === Global: metin imleci & seÃ§imi kapat === */
        body,
        .app,
        .page,
        .card,
        div,
        span,
        p,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            user-select: none;
            /* yazÄ± seÃ§ilmesin */
            -webkit-user-select: none;
            -ms-user-select: none;
            cursor: default;
            /* I-beam Ã§Ä±kmasÄ±n */
        }

        /* === Form alanlarÄ±: normal davranÄ±ÅŸ === */
        input,
        textarea,
        select {
            user-select: text !important;
            -webkit-user-select: text !important;
            -ms-user-select: text !important;
            cursor: text;
        }
        /* âœ… Select aÃ§Ä±lÄ±r liste gri olmasÄ±n (mÃ¼mkÃ¼n olduÄŸunca koyu tema) */
        select{
        color-scheme: dark;              /* tarayÄ±cÄ±ya "dark" kullan" */
        -webkit-color-scheme: dark;      /* bazÄ± WebKitâ€™lerde iÅŸe yarar */
        }

        select option{
        background: #0b1220;             /* dropdown satÄ±rlarÄ±nÄ±n arka planÄ± */
        color: #e5e7eb;                  /* yazÄ± rengi */
        }

        /* seÃ§ili/hover olan satÄ±r biraz belirgin olsun (destekleyenlerde) */
        select option:checked{
        background: #0f1e35;
        }

        /* TÄ±klanabilir alanlar */
        button,
        .nav-item,
        .action-card,
        .mini-btn,
        .acc>summary {
            cursor: pointer;
        }


        body {
            min-height: 100vh;
            background:
                radial-gradient(circle at 20% 15%, rgba(56, 189, 248, .18), transparent 55%),
                radial-gradient(circle at 80% 35%, rgba(244, 114, 182, .16), transparent 55%),
                radial-gradient(circle at 50% 85%, rgba(34, 197, 94, .10), transparent 60%),
                radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
            color: var(--text);
            padding: 16px;
              display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow-x: hidden;
        }

        .app{
  width: min(430px, 100%);   /* âœ… her ekranda otomatik oturur */
  max-width: 430px;
  margin: 0 auto;            /* âœ… ekstra garanti */

  padding: 35px 19px 180px;  /* sende zaten vardÄ± */
  border-radius: 26px;
  background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.26), var(--panel));
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.85);
  border: 1px solid rgba(148, 163, 184, 0.15);
}


        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        header h1 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: .03em;
        }

        .subtitle {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* ===== Auth (Login/Sign-up) ===== */
        .user-chip {
        border: 1px solid rgba(148,163,184,.22);
        background: rgba(2,6,23,.25);
        color: rgba(226,232,240,.92);
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 900;
        font-size: 11px;
        cursor: pointer;
        white-space: nowrap;
        }

        .auth-tabs{
        display:flex;
        gap:8px;
        margin-bottom:10px;
        }
        .auth-tab{
        flex:1;
        padding:8px 10px;
        border-radius: 999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(2,6,23,.25);
        color: rgba(226,232,240,.9);
        font-weight: 900;
        font-size: 12px;
        }
        .auth-tab.active{
        background: linear-gradient(135deg, var(--cyan1), var(--cyan2));
        color:#06121a;
        border:none;
        }

        .auth-row{
        display:grid;
        gap:10px;
        }
        .auth-note{
        font-size: 11px;
        color: rgba(156,163,175,.95);
        line-height: 1.25;
        }
/* ===== HEADER USER CHIP â€“ PREMIUM ===== */
.user-chip{
  display: inline-flex;
  align-items: center;
  gap: 8px;

  padding: 7px 12px;
  border-radius: 999px;

  border: 1px solid rgba(148,163,184,.28);
  background:
    linear-gradient(135deg,
      rgba(56,189,248,.18),
      rgba(99,102,241,.18)
    ),
    rgba(2,6,23,.35);

  color: rgba(226,232,240,.95);
  font-weight: 900;
  font-size: 11px;

  box-shadow:
    0 8px 20px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.12);

  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}

.user-chip:hover{
  filter: brightness(1.08);
  box-shadow:
    0 10px 26px rgba(0,0,0,.45),
    inset 0 1px 0 rgba(255,255,255,.18);
}

.user-chip:active{
  transform: scale(.97);
}

/* avatar */
.user-chip .user-avatar{
  width: 22px;
  height: 22px;
  border-radius: 999px;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  background: rgba(2,6,23,.45);
  border: 1px solid rgba(148,163,184,.25);

  font-size: 13px;
  line-height: 1;
}

/* isim */
.user-chip .user-name{
  white-space: nowrap;
  letter-spacing: .02em;
}

/* admin iÃ§in minik vurgu */
.user-chip.admin{
  border-color: rgba(34,197,94,.45);
  box-shadow:
    0 0 0 1px rgba(34,197,94,.25),
    0 10px 26px rgba(0,0,0,.45);
}

        /* ===== Ã–zet ===== */
        .summary-section {
            margin: 6px 0 10px;

        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 8px;
            color: #cbd5e1;
            background: rgba(15, 23, 42, .55);

        }

        .summary-panel {
            display: grid;
            grid-template-columns: 1.15fr 1fr;
            gap: 0;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, .28);
            background:
                radial-gradient(circle at 0% 0%, rgba(56, 189, 248, .18), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(248, 113, 113, .16), transparent 55%),
                rgba(15, 23, 42, .58);
            box-shadow: 0 18px 45px rgba(0, 0, 0, .55);
            min-height: 138px;
            /* âœ… kÄ±saltÄ±ldÄ± */
        }

        .sum-left {
            padding: 16px;
            border-right: 1px solid rgba(148, 163, 184, .18);
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .sum-sub {
            font-size: 10px;
            color: #9ca3af;
            margin-top: -4px;
        }

        .sum-right {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: flex-start;
        }

        .sum-item {
            padding: 7px 9px;
            border-radius: 14px;
            background: rgba(2, 6, 23, .28);
            border: 1px solid rgba(148, 163, 184, .16);
        }

        .sum-item.danger {
            background: rgba(185, 28, 28, .12);
            border-color: rgba(248, 113, 113, .35);
        }

        /* ===== Kalan BorÃ§: seviye renkleri ===== */
        .sum-item.danger.debt-ok {
            background: rgba(34, 197, 94, .12);
            border-color: rgba(34, 197, 94, .38);
        }

        .sum-item.danger.debt-ok .sum-val {
            color: rgba(187, 247, 208, .95);
        }

        .sum-item.danger.debt-warn {
            background: rgba(250, 204, 21, .12);
            border-color: rgba(250, 204, 21, .42);
        }

        .sum-item.danger.debt-warn .sum-val {
            color: rgba(254, 240, 138, .95);
        }

        .sum-item.danger.debt-alarm {
            background: rgba(185, 28, 28, .16);
            border-color: rgba(248, 113, 113, .55);
            animation: debtBlink 1.05s ease-in-out infinite;
        }

        .sum-item.danger.debt-alarm .sum-val {
            color: rgba(254, 202, 202, .98);
        }

        @keyframes debtBlink {

            0%,
            100% {
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            }

            50% {
                filter: brightness(1.18);
                box-shadow: 0 0 18px rgba(248, 113, 113, .22);
            }
        }

        /* ===== Kalan BorÃ§: seviye renkleri ===== */
        .sum-item.danger.debt-ok {
            background: rgba(34, 197, 94, .12);
            border-color: rgba(34, 197, 94, .38);
        }

        .sum-item.danger.debt-ok .sum-val {
            color: rgba(187, 247, 208, .95);
        }

        .sum-item.danger.debt-warn {
            background: rgba(250, 204, 21, .12);
            border-color: rgba(250, 204, 21, .42);
        }

        .sum-item.danger.debt-warn .sum-val {
            color: rgba(254, 240, 138, .95);
        }

        .sum-item.danger.debt-alarm {
            background: rgba(185, 28, 28, .16);
            border-color: rgba(248, 113, 113, .55);
            animation: debtBlink 1.05s ease-in-out infinite;
        }

        .sum-item.danger.debt-alarm .sum-val {
            color: rgba(254, 202, 202, .98);
        }

        @keyframes debtBlink {

            0%,
            100% {
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            }

            50% {
                filter: brightness(1.18);
                box-shadow: 0 0 18px rgba(248, 113, 113, .22);
            }
        }



        .sum-left .sum-item.danger {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 16px;
        }

        .sum-val {
            font-size: 12px;
            font-weight: 900;
            line-height: 1.15;
            white-space: nowrap;
        }

        .sum-item.danger .sum-val {
            color: #fca5a5;
            font-size: 17px;
        }

        .sum-lbl {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .sum-right .sum-item {
            padding: 6px 8px;
        }

        .sum-right .sum-val {
            font-size: 11px;
        }

        .pill {
            margin-top: 0px;
            width: fit-content;
            display: flex;
            align-items: center;
            gap: 1px;
            padding: 5px 9px;
            /* daha ince */
            border-radius: 999px;
            font-weight: 800;
            font-size: 9px;
            line-height: 1;
            /* kapsÃ¼l yÃ¼ksekliÄŸi sabit */
            border: 1px solid rgba(148, 163, 184, .22);
            /* daha soft */
            background: rgba(2, 6, 23, .25);
            /* daha koyu, daha uyumlu */
            box-shadow: none;
            /* âœ… aÄŸÄ±r gÃ¶lgeyi kaldÄ±r */
        }

        .pill-ico {
            font-size: 15px;
            /* ikon net dursun */
            opacity: .9;
        }

        .pill-money {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            line-height: 1;
        }

        .pill-money .cur {
            display: inline-block;
            line-height: 1;
            transform: translateY(-0.5px);
            /* minicik yukarÄ± al, tam hizalar */
            font-size: .92em;
            /* â‚º biraz daha kÃ¼Ã§Ã¼k dursun */
            opacity: .95;
        }

        /* â‚º karakteri baseline fix */
        #toplamBorc {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            line-height: 1;
        }

        #toplamBorc {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        #toplamBorc .cur {
            font-size: .9em;
        }


        /* ===== Action Kartlar ===== */
        .action-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
        }

        .action-card {
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border-radius: 18px;
            padding: 12px 12px 10px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(15, 23, 42, 0.55);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            min-height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .action-card::before {
            content: "";
            position: absolute;
            inset: -40%;
            background:
                radial-gradient(circle at 20% 20%, rgba(56, 189, 248, .25), transparent 55%),
                radial-gradient(circle at 80% 35%, rgba(129, 140, 248, .18), transparent 55%),
                radial-gradient(circle at 20% 90%, rgba(34, 197, 94, .14), transparent 60%);
            opacity: .9;
            pointer-events: none;
        }

        .action-card>* {
            position: relative;
            z-index: 1;
        }

        .action-title {
            font-size: 15px;
            font-weight: 800;
            letter-spacing: .02em;
        }

        .action-desc {
            margin-top: 6px;
            font-size: 12px;
            color: #cbd5e1;
            line-height: 1.25;
        }

        .action-card:active {
            transform: scale(0.99);
            filter: brightness(1.05);
        }

        .card-order {
            background:
                radial-gradient(circle at 10% 0%, rgba(56, 189, 248, .22), transparent 55%),
                radial-gradient(circle at 90% 90%, rgba(14, 165, 233, .18), transparent 55%),
                rgba(15, 23, 42, .55);
            border-color: rgba(56, 189, 248, 0.30);
        }

        .card-order::after {
            content: "ðŸ’§";
            position: absolute;
            right: 0px;
            bottom: 20px;
            font-size: 130px;
            line-height: 1;
            opacity: 0.18;
            filter: blur(0.2px);
            transform: rotate(-10deg);
            pointer-events: none;
            z-index: 0;
        }

        .card-payment {
            background:
                radial-gradient(circle at 15% 0%, rgba(34, 197, 94, .22), transparent 55%),
                radial-gradient(circle at 90% 90%, rgba(250, 204, 21, .18), transparent 55%),
                rgba(15, 23, 42, .55);
            border-color: rgba(34, 197, 94, 0.30);
        }

        .card-payment::after {
            content: "ðŸ’°";
            position: absolute;
            right: -20px;
            bottom: 20px;
            font-size: 130px;
            line-height: 1;
            opacity: 0.18;
            filter: blur(0.2px);
            transform: rotate(-10deg);
            pointer-events: none;
            z-index: 0;
        }

        /* ===== Bottom Nav ===== */
        .bottom-nav {
            position: fixed;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 430px;
            padding: 8px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.88);
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: space-between;
            gap: 4px;
            z-index: 999;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .nav-item {
            flex: 1;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 0;
            border-radius: 999px;
            cursor: pointer;
        }

        .nav-icon {
            font-size: 16px;
            line-height: 1;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #22d3ee, #0ea5e9);
            color: #06121a;
            font-weight: 700;
            box-shadow: 0 10px 24px rgba(8, 145, 178, 0.45);
        }
/* ===== Bottom Nav Transition ===== */

.bottom-nav button{
  position: relative;
  transition: color .18s ease, transform .18s ease;
}

/* ikon / yazÄ± bÃ¼yÃ¼mesi */
.bottom-nav button.active{
  transform: translateY(-2px) scale(1.06);
}

/* alt highlight (Ã§izgi / pill) */
.bottom-nav button::after{
  content: "";
  position: absolute;
  left: 50%;
  bottom: -6px;
  width: 0;
  height: 3px;
  border-radius: 999px;
  background: linear-gradient(90deg,#22c55e,#38bdf8);
  transform: translateX(-50%);
  opacity: 0;
  transition: width .22s ease, opacity .22s ease;
}

.bottom-nav button.active::after{
  width: 24px;
  opacity: 1;
}

        /* ===== Sayfa & Kart ===== */
        .page.hidden {
            display: none;
        }

        .card {
            border-radius: 18px;
            padding: 14px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(15, 23, 42, 0.55);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
        }

        /* Ayarlar - genel alanlar */
        .field label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .field input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(2, 6, 23, 0.35);
            color: var(--text);
            outline: none;
        }

        .hint {
            margin-top: 6px;
            font-size: 7px;
            color: rgba(156, 163, 175, 0.9);
        }

        .save-btn {
            width: 100%;
            padding: 12px 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 800;
            background: linear-gradient(135deg, var(--cyan1), var(--cyan2));
            color: #06121a;
            box-shadow: 0 14px 28px rgba(8, 145, 178, 0.35);
        }

        .save-btn:active {
            transform: scale(0.99);
        }

        .danger-btn {
            width: 100%;
            padding: 12px 12px;
            border-radius: 999px;
            border: 1px solid rgba(248, 113, 113, 0.40);
            cursor: pointer;
            font-weight: 900;
            background: rgba(185, 28, 28, 0.18);
            color: #fecaca;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.35);
        }

        .danger-btn:active {
            transform: scale(0.99);
        }

        /* === Ayarlar sayfasÄ± ULTRA kompakt (mobil) === */
        #page-ayarlar .card{ padding: 10px; }

        .settings-grid{
        display:grid;
        grid-template-columns: minmax(0,1fr) minmax(0,1fr);
        gap: 8px;               /* 10 -> 8 */
        }

        #page-ayarlar .field label{
        font-size: 10px;        /* 11 -> 10 */
        margin-bottom: 4px;     /* 5 -> 4 */
        }

        #page-ayarlar .field input{
        padding: 7px 9px;       /* 9 10 -> 7 9 */
        border-radius: 10px;    /* 12 -> 10 */
        font-size: 12px;        /* okunur kalsÄ±n */
        }

        /* Kaydet + Tehlike butonlarÄ± daha kÄ±sa */
        #page-ayarlar .save-btn,
        #page-ayarlar .danger-btn{
        padding: 9px 10px;      /* 10 12 -> 9 10 */
        font-size: 12px;
        }

        /* Ayarlar sayfasÄ± mÃ¼mkÃ¼n olduÄŸunca tek ekranda kalsÄ±n */
        #page-ayarlar{
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        max-height: calc(100dvh - 170px);  /* 210 -> 170 (daha Ã§ok alan) */
        padding-bottom: 90px;              /* 110 -> 90 */
        }
        /* === Ayarlar: JSON/EXCEL aÃ§Ä±lÄ±r menÃ¼ler daha kÃ¼Ã§Ã¼k === */
        #page-ayarlar .backup-row{
        gap: 6px;          /* 10 -> 6 */
        margin-top: 8px;   /* 10 -> 8 */
        }

        #page-ayarlar .drop{
            flex: 1 1 180px;
            } /* 160 -> 140: daha derli toplu */

        #page-ayarlar .drop-btn{
        padding: 6px 8px;  /* buton kÄ±salÄ±r */
        font-size: 11px;
        width: 100%;
        }

        /* MenÃ¼: kocaman uzamasÄ±n, belli yÃ¼kseklikten sonra iÃ§inde scroll olsun */
        #page-ayarlar .drop-menu{
        top: calc(100% + 6px);   /* 8px -> 6px */
        padding: 4px;            /* 6 -> 4 */
        border-radius: 12px;     /* 14 -> 12 */
        max-height: 180px;       /* âœ… bÃ¼yÃ¼mesini kes */
        overflow: auto;          /* âœ… iÃ§inden kaydÄ±r */
        -webkit-overflow-scrolling: touch;
        }

        /* MenÃ¼ itemâ€™larÄ± daha kÄ±sa */
        #page-ayarlar .drop-item{
        padding: 7px 9px;        /* 10 12 -> 7 9 */
        border-radius: 10px;     /* 12 -> 10 */
        font-size: 11px;         /* 12 -> 11 */
        line-height: 1.15;
        }

        /* === EXCEL/JSON menÃ¼: ultra kompakt liste === */
        #page-ayarlar .drop-menu{
        max-height: 220px;       /* biraz daha kÄ±sa */
        padding: 3px;
        }

        #page-ayarlar .drop-item{
        padding: 6px 8px;        /* daha kÄ±sa */
        font-size: 10.5px;       /* biraz daha kÃ¼Ã§Ã¼k */
        line-height: 1.05;
        border-radius: 9px;

        /* âœ… tek satÄ±r */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        }

        /* MenÃ¼ iÃ§indeki ayÄ±rÄ±cÄ± Ã§izgi de incelsin */
        #page-ayarlar #menuExcel hr,
        #page-ayarlar #menuJson hr{
        margin: 5px 0 !important;
        }


        /* Accordion */
        .acc {
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-radius: 16px;
            background: rgba(15, 23, 42, 0.45);
            overflow: hidden;
            margin-top: 12px;
            width: 100%;
        }

        .acc>summary {
            list-style: none;
            cursor: pointer;
            padding: 12px 12px;
            font-weight: 900;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
        }

        .acc>summary::-webkit-details-marker {
            display: none;
        }

        .acc .acc-body {
            padding: 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.14);
            display: grid;
            gap: 10px;
        }
        /* === Ayarlar: Accordion daha kompakt === */
        #page-ayarlar .acc{
        border-radius: 14px;  /* 16 -> 14 */
        margin-top: 10px;     /* 12 -> 10 */
        }

        #page-ayarlar .acc > summary{
        padding: 10px 10px;   /* 12 -> 10 */
        font-size: 11px;      /* 12 -> 11 */
        }

        #page-ayarlar .acc .acc-body{
        padding: 10px;        /* 12 -> 10 */
        gap: 8px;             /* 10 -> 8 */
        }

        /* Accordion iÃ§indeki mini butonlar da kÃ¼Ã§Ã¼lsÃ¼n */
        #page-ayarlar .mini-btn{
        padding: 5px 7px;     /* 6 8 -> 5 7 */
        font-size: 10px;      /* 11 -> 10 */
        border-radius: 9px;   /* 10 -> 9 */
        }

        /* ===== Modal ===== */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
        }

        #uiDialog {
            z-index: 3000 !important;
        }

        #payModal {
            z-index: 2100;
        }

        .modal-card {
            position: relative;
            width: calc(100% - 32px);
            max-width: 430px;
            margin: 10vh auto 0;
            border-radius: 20px;
            padding: 14px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(15, 23, 42, 0.92);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
        }

        /* âœ… payModal taÅŸma fix (tekleÅŸtirildi) */
        #payModal .modal-card {
            max-height: 86vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-x {
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 10px;
        }

        .modal-x:active {
            transform: scale(0.98);
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(2, 6, 23, 0.35);
            color: var(--text);
            outline: none;
        }

        /* Confirm popup butonlarÄ± */
        .confirm-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        /* TÃ¼m popup butonlarÄ± */
        .confirm-actions button {
            min-height: 30px;
            /* ðŸ”¥ ÅŸiÅŸiren ana kÄ±sÄ±m */
            padding: 0 18px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 14px;
        }

        .confirm-actions {
            grid-template-columns: 1fr 1fr;
        }

        .confirm-actions .ghost-btn {
            background: linear-gradient(180deg, #b91c1c, #7f1d1d);
            color: #fff;
            box-shadow:
                0 6px 18px rgba(220, 38, 38, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        /* Tamam / Kaydet butonu */
        .confirm-actions .save-btn {
            background: linear-gradient(135deg, #22d3ee, #0ea5e9);
            color: #001018;
        }

        .confirm-actions .ghost-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(196, 0, 0, 0.733) !important;
            border: 1px solid rgba(148, 163, 184, 0.28) !important;
            border-radius: 20px;
            color: #ffffff !important;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
        }

        .confirm-actions .ghost-btn:hover {
            filter: brightness(1.08);
        }

        .confirm-actions .ghost-btn:active {
            transform: scale(0.99);
        }

        #uiSubtitle {
            margin-bottom: 8px;
        }

        .confirm-preview {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            max-height: 45vh;
            overflow: auto;
            padding-right: 6px;
            line-height: 1.35;
        }

        /* ===== SipariÅŸ Tablo (MINI / NAV UYUMLU) ===== */

/* SipariÅŸler sayfasÄ±: alt menÃ¼ iÃ§in boÅŸluk bÄ±rak */
#page-siparisler{
  padding-bottom: 92px; /* bottom-nav Ã¼stÃ¼ne binmesin */
}

/* Wrap: tablo alanÄ± esneyebilsin */
.orders-wrap{
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}

/* Senkron bar (varsa) daha kompakt kalsÄ±n */
.orders-syncbar{
  padding: 10px 12px;
  border-radius: 16px;
}

/* Tablo kutusu: altta sayfa geÃ§iÅŸi + nav iÃ§in gÃ¼venli scroll alanÄ± */
.table-wrap{
  flex: 1 1 auto;
  min-height: 0;

  border-radius: 16px;
  border: 1px solid rgba(148,163,184,0.18);
  background: rgba(2,6,23,0.20);

  overflow: auto;
  -webkit-overflow-scrolling: touch;

  /* eski max-height yerine daha gÃ¼venli: nav + Ã¼st alanlar dÃ¼ÅŸÃ¼nÃ¼lmÃ¼ÅŸ */
  max-height: calc(100dvh - 300px);
  padding-bottom: 8px; /* en alttaki iÃ§erik kesilmesin */
}

/* Tablo: daha sÄ±kÄ± */
.orders-table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;        /* sÃ¼tunlar kontrol altÄ±nda */
  min-width: 750px;           /* yatay kaydÄ±rma gerektiÄŸinde dÃ¼zgÃ¼n olsun */
}

/* Sticky header */
.orders-table thead th{
  position: sticky;
  top: 0;
  z-index: 2;

  background: rgba(2,6,23,0.92);
  backdrop-filter: blur(10px);

  padding: 6px 8px;
  font-size: 10.5px;
  line-height: 1.1;
  text-align: left;
  border-bottom: 1px solid rgba(148,163,184,0.12);
}

/* HÃ¼creler */
.orders-table tbody td{
  padding: 6px 8px;
  font-size: 10.8px;
  line-height: 1.1;
  border-bottom: 1px solid rgba(148,163,184,0.08);
  vertical-align: middle;
}

.orders-table tbody tr:hover td{
  background: rgba(148,163,184,0.06);
}

/* SayÄ±sal kolonlar */
.orders-table .td-num{ text-align: right; }

/* âœ… TL / fiyat / tutar asla alt satÄ±ra dÃ¼ÅŸmesin */
.orders-table td:nth-child(4),
.orders-table td:nth-child(5){
  white-space: nowrap;
  text-align: right;
}

/* Not kolonu: tek satÄ±r + taÅŸarsa ... */
.orders-table td:nth-child(6){
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Aksiyon kolonunu dar tut */
.orders-table td:nth-child(8){
  width: 64px;
}

/* Durum ikonu kolonunu dar tut */
.orders-table td:nth-child(9){
  width: 10px;
  text-align: center;
}

/* Kolon geniÅŸlikleri (istenen minimal gÃ¶rÃ¼nÃ¼m) */
.orders-table th:nth-child(1), .orders-table td:nth-child(1){ width: 70px; }  /* Tarih */
.orders-table th:nth-child(2), .orders-table td:nth-child(2){ width: 40px; text-align: center  }  /* Adet */
.orders-table th:nth-child(3), .orders-table td:nth-child(3){ width: 180px; } /* Ã–denen */
.orders-table th:nth-child(4), .orders-table td:nth-child(4){ width: 65px; }  /* Birim */
.orders-table th:nth-child(5), .orders-table td:nth-child(5){ width: 88px; }  /* Tutar */
.orders-table th:nth-child(7), .orders-table td:nth-child(7){ width: 95px; }  /* KullanÄ±cÄ± */
/* ===== FIX: HÃ¼cre taÅŸmalarÄ±nÄ± kontrol et ===== */
.orders-table th,
.orders-table td{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;   /* default tek satÄ±r */
}

/* Kaydeden kolonu: ikon + isim yan yana dÃ¼zgÃ¼n dursun */
.orders-table td:nth-child(7){
  white-space: nowrap;
}

/* Kaydeden hÃ¼cresindeki iÃ§erik (span/div vs) ne olursa olsun yan yana gelsin */
.orders-table td:nth-child(7) > *{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  max-width: 100%;
}

/* Ä°ÅŸlem kolonu: butonlar yan yana, taÅŸma yok */
.orders-table td:nth-child(8){
  white-space: nowrap;
}

.orders-table td:nth-child(8) button,
.orders-table td:nth-child(8) .btn,
.orders-table td:nth-child(8) .icon-btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  padding: 0;
  margin: 0 2px;
}

/* Durum kolonu: tek ikon ortada */
.orders-table td:nth-child(9){
  white-space: nowrap;
}


        /* === Yeni SipariÅŸ modal: 2 sÃ¼tun dÃ¼zen === */
        .order-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .order-grid-2 .field {
            margin-top: 0 !important;
        }

        .order-grid-2 input,
        .order-grid-2 select {
            width: 100%;
            min-width: 0;
        }



        .td-right {
            text-align: right;
        }

        .td-strong,
        .td-num {
            font-weight: 900;
        }

        .td-num {
            font-variant-numeric: tabular-nums;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(15, 23, 42, 0.35);
            font-weight: 800;
            font-size: 11px;
        }

        .badge.dam {
            border-color: rgba(56, 189, 248, 0.30);
        }

        .badge.pet {
            border-color: rgba(34, 197, 94, 0.30);
        }

        .row-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            white-space: nowrap;
        }

        .mini-btn {
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(15, 23, 42, 0.35);
            color: #e5e7eb;
            padding: 6px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 900;
            font-size: 11px;
        }

        .mini-btn:active {
            transform: scale(0.98);
        }

        .mini-btn.edit {
            border-color: rgba(56, 189, 248, 0.35);
        }

        .mini-btn.del {
            border-color: rgba(248, 113, 113, 0.40);
            background: rgba(185, 28, 28, 0.12);
            color: #fecaca;
        }

        .pager {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .pager-info {
            font-size: 12px;
            color: rgba(156, 163, 175, 0.95);
            font-weight: 800;
        }

        .mini-btn:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        /* ===== Ã–denen adet mini progress ===== */
        .paid-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            border-radius: 8px;
            border: 1px solid rgba(250, 204, 21, .40);
            background: rgba(250, 204, 21, .12);
            color: rgba(254, 240, 138, .95);
            font-weight: 900;
            font-size: 11px;
            white-space: nowrap;
        }

        .paid-chip.ok {
            border-color: rgba(34, 197, 94, .45);
            background: rgba(34, 197, 94, .14);
            color: rgba(187, 247, 208, .95);
        }

        .paid-chip.warn {
            border-color: rgba(250, 204, 21, .45);
            background: rgba(250, 204, 21, .12);
            color: rgba(254, 240, 138, .95);
        }

        .paid-chip.no {
            border-color: rgba(248, 113, 113, .45);
            background: rgba(248, 113, 113, .12);
            color: rgba(254, 202, 202, .95);
        }

        .paid-chip .tri {
            font-size: 11px;
            line-height: 1;
        }

        .paid-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .pbar {
            width: 78px;
            height: 8px;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, .20);
            background: rgba(2, 6, 23, .35);
        }

        .pbar-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
        }

        .pbar-fill.no {
            background: rgba(248, 113, 113, .85);
        }

        .pbar-fill.warn {
            background: rgba(250, 204, 21, .85);
        }

        .pbar-fill.ok {
            background: rgba(34, 197, 94, .85);
        }

        /* ikon butonlar */
        .icon-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            white-space: nowrap;
        }

        .ico-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 6px;
            border-radius: 10px;
        }

        .ico-btn:active {
            transform: scale(0.98);
        }

        .ico-edit {
            color: rgba(34, 197, 94, .95);
        }

        .ico-del {
            color: rgba(248, 113, 113, .95);
        }

        .ico-btn:hover {
            background: rgba(148, 163, 184, .10);
        }

        /* ===== BorÃ§ Modal ===== */
        .debt-card {
            max-width: 900px;
            width: calc(100% - 24px);
            margin: 6vh auto 0;
            max-height: 82vh;
            display: flex;
            flex-direction: column;
        }

        .debt-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin: 8px 0 12px;
        }

        .debt-meta {
            font-weight: 900;
            color: rgba(226, 232, 240, .92);
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .22);
            background: rgba(2, 6, 23, .25);
        }

        #btnDebtWhatsapp {
            border-color: rgba(34, 197, 94, .35);
            background: rgba(34, 197, 94, .12);
            color: rgba(187, 247, 208, .95);
        }

        #btnDebtWhatsapp:active {
            transform: scale(.98);
        }

        #debtTableHost {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            /* âœ… yatay scroll */
            -webkit-overflow-scrolling: touch;
            padding-right: 6px;
        }
        

        #debtTableHost::-webkit-scrollbar {
            width: 8px;
        }

        #debtTableHost::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, .25);
            border-radius: 999px;
        }

        .debt-headrow {
            display: grid;
            grid-template-columns: 1.1fr .7fr 1fr 1.1fr .9fr;
            gap: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, .18);
            background: rgba(2, 6, 23, .35);
            color: rgba(148, 163, 184, .95);
            font-weight: 900;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 3;
            min-width: 520px;
        }

        .debt-line {
            display: grid;
            grid-template-columns: 1.1fr .7fr 1fr 1.1fr .9fr;
            gap: 10px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(15, 23, 42, 0.45);
            min-width: 520px;
        }

        .debt-line+.debt-line {
            margin-top: 10px;
        }

        .debt-val {
            font-weight: 900;
            font-size: 12px;
            color: rgba(226, 232, 240, .95);
            overflow-x: auto;
            white-space: nowrap;
        }

        .debt-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            white-space: nowrap;
        }

        /* ===== Ã–deme geÃ§miÅŸi ===== */
        .pay-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: auto;
            /* ðŸ”¥ Ä°Ã‡ERÄ°ÄžE GÃ–RE GENÄ°ÅžLÄ°K */
        }



        .pay-table th,
        .pay-table td {
            padding: 8px 10px;
            font-size: 9px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.10);
            white-space: nowrap;
            /* satÄ±r kÄ±rÄ±lmasÄ±n */
        }

        .pay-table td:nth-child(5),
        .pay-table th:nth-child(5) {
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pay-table td:last-child,
        .pay-table th:last-child {
            width: 40px;
            text-align: center;
        }


        .pay-table th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: rgba(15, 23, 42, 0.92);
            color: rgba(226, 232, 240, .92);
            font-weight: 900;
            text-align: left;
        }

        .pay-table td.note {
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #payHistoryHost {
            max-height: 240px;
            overflow-x: auto;
            /* âœ… yatay kaydÄ±rma */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-right: 6px;
        }

        #payHistoryHost::-webkit-scrollbar {
            width: 8px;
        }

        #payHistoryHost::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, .25);
            border-radius: 999px;
        }

        #payHistoryHost .pay-table th {
            top: 0;
            z-index: 5;
        }

        .mini-battery {
            height: 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.22);
            overflow: hidden;
            margin-top: 8px;
        }

        .mini-battery-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: rgba(34, 197, 94, 0.85);
            transition: width .25s ease;
        }

        /* Kalan BorÃ§ pili renkleri */
        .mini-battery-fill.ok {
            background: rgba(34, 197, 94, 0.85);
        }

        .mini-battery-fill.warn {
            background: rgba(250, 204, 21, 0.85);
        }

        .mini-battery-fill.alarm {
            background: rgba(248, 113, 113, 0.9);
            animation: batteryBlink 1.05s ease-in-out infinite;
        }

        .mini-battery-fill.ok {
            background: rgba(34, 197, 94, 0.85);
        }

        .mini-battery-fill.warn {
            background: rgba(250, 204, 21, 0.85);
        }

        .mini-battery-fill.alarm {
            background: rgba(248, 113, 113, 0.9);
            animation: batteryBlink 1.05s ease-in-out infinite;
        }

        @keyframes batteryBlink {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.2);
            }
        }

        @keyframes batteryBlink {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.2);
            }
        }


        .mini-battery-text {
            margin-top: 6px;
            font-size: 11px;
            color: rgba(226, 232, 240, .75);
        }



        /* ===== Toast ===== */
        #toastHost {
            position: fixed;
            bottom: 86px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 220px;
            max-width: 320px;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
            animation: toastIn .25s ease, toastOut .25s ease 2.6s forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toast.info {
            background: linear-gradient(135deg, #38bdf8, #0284c7);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(.96);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(10px) scale(.96);
            }
        }

        /* âœ… Kalan BorÃ§ popup: daha sÄ±kÄ± satÄ±rlar (sende bÃ¶yleydi, korudum) */
        #debtTableHost .debt-table th,
        #debtTableHost .debt-table td {
            padding: 7px 10px !important;
            line-height: 1.15 !important;
            font-size: 9px !important;
        }

        #debtTableHost .debt-table tbody tr {
            height: auto !important;
        }

        /* ===== Trash satÄ±rlarÄ± ===== */
        .trash-row {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(15, 23, 42, 0.45);
            margin-bottom: 10px;
        }

        .trash-meta {
            font-size: 13px;
            font-weight: 900;
        }

        .trash-sub {
            font-size: 11px;
            color: rgba(156, 163, 175, .95);
            margin-top: 6px;
            white-space: normal;
        }

        .trash-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-self: center;
            white-space: nowrap;
        }

        .trash-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(2, 6, 23, 0.25);
            font-size: 11px;
            font-weight: 900;
        }

        /* ===== Responsive (tekleÅŸtirildi) ===== */
        @media (max-width:420px) {
            body {
                padding: 10px;
            }

          

            header h1 {
                font-size: 19px;
            }

            .subtitle {
                font-size: 11px;
                margin-top: 2px;
            }

            .right {
                gap: 8px;
            }

            .chip {
                padding: 5px 10px;
                font-size: 11px;
                margin-bottom: 6px;
            }

            .summary-panel {
                grid-template-columns: 1.35fr 1fr;
                min-height: 135px;
                /* âœ… mobil daha kÄ±sa */
            }

            .card {
                padding: 12px !important;
            }

            .sum-left {
                padding: 12px;
                border-right: 1px solid rgba(148, 163, 184, .18);
                display: flex;
                flex-direction: column;
                gap: 8px;
                height: 100%;
            }

            .sum-left .sum-item.danger {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                padding: 12px;
            }

            .sum-right {
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 7px;
                justify-content: flex-start;
            }

            .sum-right .sum-item {
                padding: 6px 8px;
            }

            .sum-val {
                font-size: 14px;
            }

            .sum-lbl {
                font-size: 10px;
            }

            .sum-sub {
                font-size: 9px;
            }

            .pill {
                padding: 7px 10px;
                font-size: 12px;
            }

            .confirm-actions {
                flex-direction: column;
            }

            .confirm-actions .ghost-btn,
            .confirm-actions .save-btn {
                width: 100% !important;
            }

            /* rapor gridleri */
            /* ===== Raporlar (mobil taÅŸma) ===== */
            #page-raporlar #rptBestMonthLine {
                font-size: 11px;
            }
        }

        @media (max-width:360px) {
            .summary-panel {
                grid-template-columns: 1.25fr 1fr;
                min-height: 140px;
            }
        }

        @media (max-width:320px) {
            .settings-actions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width:380px) {
            .trash-row {
                flex-direction: column;
            }

            .trash-row .trash-actions {
                flex-direction: row;
                justify-content: flex-end;
            }
        }

        .dash-yearbar {
            display: flex;
            align-items: center;
            gap: 6px;

        }

        .dash-yeartext {
            font-weight: 900;
            font-size: 11px;
            color: #e5e7eb;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .22);
            background: rgba(2, 6, 23, .20);
            line-height: 1;
        }

        /* YÄ±l oklarÄ±: kÃ¼Ã§Ã¼k ikon buton */
        .year-btn {
            width: 28px;
            height: 28px;
            padding: 0 !important;
            border-radius: 999px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .year-all {
            width: 28px;
            height: 28px;
            padding: 0 !important;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 900;
            line-height: 1;
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* YÄ±l barÄ±nÄ± karttan baÄŸÄ±msÄ±z hizala */
        .year-float {
            align-self: flex-end;
            background: rgba(2, 6, 23, .35);
            border: 1px solid rgba(148, 163, 184, .22);
            border-radius: 999px;
            padding: 4px 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: max-content;
        }

        /* YÄ±l yazÄ±sÄ± daha dar */
        .dash-yeartext {
            font-size: 11px;
            font-weight: 900;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, .6);
        }

        /* Oklar ve âˆž TAM mini */
        .year-btn,
        .year-all {
            width: 24px;
            height: 24px;
            font-size: 11px;
        }

        /* YÄ±l seÃ§ili gÃ¶rÃ¼nÃ¼mÃ¼ */
        .dash-yeartext {
            outline: none;
            transition: box-shadow .18s ease, transform .18s ease, border-color .18s ease;
        }

        /* Her seÃ§ili durumda hafif parlama */
        .dash-yeartext.is-selected {
            border-color: rgba(56, 189, 248, .35);
            box-shadow:
                0 0 0 1px rgba(56, 189, 248, .18),
                0 10px 18px rgba(0, 0, 0, .22);
        }

        /* SeÃ§ili + mevcut yÄ±l ise daha gÃ¼Ã§lÃ¼ parlama */
        .dash-yeartext.is-current {
            border-color: rgba(56, 189, 248, .55);
            box-shadow:
                0 0 0 2px rgba(56, 189, 248, .22),
                0 0 18px rgba(56, 189, 248, .18),
                0 14px 26px rgba(0, 0, 0, .28);
            transform: translateY(-1px);
        }

        /* TÃ¼mÃ¼ seÃ§iliyse ayrÄ± bir vurgu (istersen kaldÄ±rÄ±rÄ±z) */
        .dash-yeartext.is-all {
            border-color: rgba(148, 163, 184, .35);
            box-shadow:
                0 0 0 1px rgba(148, 163, 184, .18),
                0 10px 18px rgba(0, 0, 0, .22);
        }

        /* =========================
   KALAN BORÃ‡ TABLOSU â€“ DAR
   ========================= */

        .debt-table.compact{
  table-layout: auto;
  width: max-content;
  min-width: 100%;
}


        #debtTableHost .debt-table th,
#debtTableHost .debt-table td{
  padding: 5px 5px !important;
  line-height: 1.15 !important;
  font-size: 9px !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

        /* =========================
   KALAN BORÃ‡ MODAL â€“ DARALT
   ========================= */

        .debt-card {
            max-width: 720px;
            /* ðŸ‘ˆ modal geniÅŸliÄŸi */
            padding: 12px 14px;
            /* ðŸ‘ˆ iÃ§ boÅŸluk azaltÄ±ldÄ± */
        }

        /* Ãœst baÅŸlÄ±k */
        .debt-card .modal-head {
            padding: 6px 0 10px 0;
        }

        /* Ãœst Ã¶zet alanÄ± */
        .debt-card .debt-top {
            margin-bottom: 8px;
            gap: 8px;
        }

        /* 39 adet â€¢ 4.680 â‚º */
        .debt-card .debt-meta {
            font-size: 13px;
        }

        /* WhatsApp butonu */
        .debt-card .mini-btn {
            padding: 4px 10px;
            font-size: 12px;
        }

        .debt-card .table-wrap {
            overflow-x: auto;
            padding: 0;
            /* ðŸ‘ˆ Ã¶nemli */

        }

        .table-wrap table {
            margin: 0 auto;
        }

        .debt-card .table-wrap table {
            margin: 0;
        }

        #ordUnitPrice[readonly] {
            opacity: .7;
            cursor: not-allowed;
            pointer-events: none;
            /* tÄ±klamayÄ± da tamamen kapatÄ±r */
        }

        input[type="text"],
        textarea {
            text-transform: uppercase;
        }

        .today-card {
            position: relative;
            top: -10px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 9px;
            border-radius: 14px;
            background: linear-gradient(135deg,
                    rgba(34, 211, 238, 0.15),
                    rgba(99, 102, 241, 0.15));
            border: 1px solid rgba(148, 163, 184, 0.25);
            backdrop-filter: blur(10px);
            transform: perspective(600px) translateZ(0);
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.12);
                  opacity: 0.92;
        }

        .today-icon {
            font-size: 22px;
            line-height: 1;
        }

        .today-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .today-label {
            font-size: 10px;
            letter-spacing: 1px;
            color: var(--muted);
              opacity: 0.92;
        }

        .today-date {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        @keyframes softGlow {
            0% {
                box-shadow:
                    0 6px 18px rgba(0, 0, 0, 0.25),
                    0 0 0 rgba(34, 211, 238, 0);
            }

            50% {
                box-shadow:
                    0 8px 22px rgba(0, 0, 0, 0.3),
                    0 0 12px rgba(34, 211, 238, 0.35);
            }

            100% {
                box-shadow:
                    0 6px 18px rgba(0, 0, 0, 0.25),
                    0 0 0 rgba(34, 211, 238, 0);
            }
        }

        .today-card {
            transform: perspective(600px);
            animation-duration: 6s;
            /* 4s â†’ 6s */
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.12);
        }

        .backup-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .drop {
            position: relative;
            flex: 1 1 160px;
        }

        .drop-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .drop-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 14px;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
            display: none;
            z-index: 50;
        }

        .drop-menu.open {
            display: block;
        }

        .drop-item {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            background: rgba(2, 6, 23, 0.35);
            color: var(--text);
            font-size: 12px;
        }

        .drop-item:active {
            transform: scale(0.99);
        }

        /* Field bloklarÄ± arasÄ± boÅŸluk (popup formlarÄ±) */
        .modal-card .field {
            margin-bottom: 12px;
        }

        /* Input altÄ±ndaki aÃ§Ä±klama yazÄ±sÄ± (hint) yapÄ±ÅŸmasÄ±n */
        .modal-card .field .hint {
            display: block;
            margin-top: 8px;
            font-size: 11px;
            line-height: 1.25;
            opacity: 0.85;
        }
        
/* ===== Header user chip ===== */
.user-chip{
  border: 1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.22);
  font-weight: 900;
  font-size: 11px;
  padding: 6px 10px;
}

/* ===== AUTH UI ===== */
.auth-card{
  padding: 1px solid rgba(148,163,184,.22);
  gap: 0;
  background:
    radial-gradient(circle at 10% 0%, rgba(56,189,248,.18), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(249,115,22,.14), transparent 55%),
    rgba(15,23,42,.94);
    justify-items: center;
}

.auth-top{
  display:flex;
  align-items:center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.auth-title{
  font-weight: 900;
  font-size: 14px;
  letter-spacing: .02em;
}

.auth-avatar{
  width: 56px;
  height: 56px;
  margin: 8px auto 10px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(2,6,23,.30);
  border: 1px solid rgba(148,163,184,.25);
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
  font-size: 22px;
}

.auth-box{
  display:grid;
  gap: 10px;
}

.auth-field{
  display:flex;
  align-items:center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.24);
}

.auth-field .ico{
  opacity:.85;
  font-size: 14px;
}

.auth-field input{
  border: none;
  outline: none;
  background: transparent;
  color: var(--text);
  width: 100%;
  padding: 0;
  font-size: 12px;
}

.auth-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}

.auth-check{
  display:flex;
  align-items:center;
  gap: 8px;
  font-size: 12px;
  color: rgba(226,232,240,.95);
}

.auth-btn{
  width: 100%;
  border: none;
  border-radius: 12px;
  padding: 11px 12px;
  font-weight: 900;
  cursor: pointer;
  background: linear-gradient(135deg, #f97316, #fb7185);
  color: #071018;
  box-shadow: 0 12px 24px rgba(0,0,0,.35);
}

.auth-btn:active{ transform: scale(.99); }

.auth-btn.ghost{
  width: auto;
  flex: 1;
  background: rgba(2,6,23,.18);
  color: rgba(226,232,240,.92);
  border: 1px solid rgba(148,163,184,.22);
  box-shadow: none;
}

.auth-subtitle{
  font-size: 10px;
  font-weight: 900;
  opacity: .9;
}

.auth-hint{
  font-size: 11px;
  color: rgba(156,163,175,.95);
  line-height: 1.25;
}

.auth-msg{
  font-size: 11px;
  color: rgba(253,230,138,.95);
  min-height: 14px;
}

/* Password toggle (mini switch) */
.pw-toggle{
  position: relative;
  width: 38px;
  height: 20px;
  flex: 0 0 auto;
}

.pw-toggle input{ display:none; }

.pw-toggle .slider{
  position:absolute;
  inset:0;
  border-radius: 999px;
  background: rgba(148,163,184,.25);
  border: 1px solid rgba(148,163,184,.22);
}

.pw-toggle .slider:before{
  content:"";
  position:absolute;
  width: 16px;
  height: 16px;
  left: 2px;
  top: 1px;
  border-radius: 999px;
  background: rgba(226,232,240,.95);
  transition: transform .18s ease;
}

.pw-toggle input:checked + .slider:before{
  transform: translateX(18px);
}

        /* ===== Pay Modal Tabs ===== */
        .modal-tabs {
            display: flex;
            gap: 8px;
            margin: 8px 0 12px;
            padding: 4px;
            border: 1px solid rgba(148, 163, 184, .18);
            border-radius: 14px;
            background: rgba(2, 6, 23, .25);
        }

        .modal-tabs .tab-btn {
            flex: 1;
            height: 40px;
            border: 0;
            border-radius: 12px;
            background: transparent;
            color: rgba(226, 232, 240, .85);
            font-weight: 800;
            cursor: pointer;
        }

        .modal-tabs .tab-btn.active {
            background: rgba(34, 211, 238, .18);
            border: 1px solid rgba(34, 211, 238, .25);
            color: #e2e8f0;
        }

        .tab-panel.hidden {
            display: none;
        }

        /* GeÃ§miÅŸ baÅŸlÄ±ÄŸÄ± + host boÅŸluk */
        .history-title {
            margin-top: 4px;
            font-weight: 900;
            font-size: 12px;
            color: rgba(226, 232, 240, .92);
        }

        #payHistoryHost {
            margin-top: 10px;
        }

        /* Kalan borÃ§ info'yu chip gibi gÃ¶sterelim */
        #payAfterInfo {
            display: inline-block;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(15, 23, 42, .55);
            border: 1px solid rgba(148, 163, 184, .18);
        }

        /* payCalcInfo daha soluk */
        #payCalcInfo {
            opacity: .85;
        }

        /* ===================== RAPORLAR COMPACT (FORCE) ===================== */
        #page-raporlar.reports-compact .card {
            padding: 10px !important;
        }

        #page-raporlar.reports-compact .card[style*="padding:14px"] {
            padding: 10px !important;
        }

        #page-raporlar.reports-compact .card[style*="margin-top:12px"] {
            margin-top: 10px !important;
        }

        #page-raporlar.reports-compact .hint {
            font-size: 11px !important;
            line-height: 1.25 !important;
            margin-top: 8px !important;
        }

        /* BaÅŸlÄ±k â€œRaporlarâ€ */
        #page-raporlar.reports-compact div[style*="font-size:16px"] {
            font-size: 14px !important;
        }

        /* KÃ¼Ã§Ã¼k baÅŸlÄ±klar (10px / 9px yazÄ±lanlar) */
        #page-raporlar.reports-compact div[style*="font-size: 10px"],
        #page-raporlar.reports-compact div[style*="font-size:10px"],
        #page-raporlar.reports-compact div[style*="font-size: 9px"],
        #page-raporlar.reports-compact div[style*="font-size:9px"] {
            font-size: 12px !important;
        }

        /* Select + mini-btnâ€™ler (inline paddingâ€™leri ez) */
        #page-raporlar.reports-compact .mini-btn {
            min-height: 38px !important;
            padding: 8px 10px !important;
            border-radius: 12px !important;
            font-size: 12px !important;
        }

        /* ===== RAPORLAR â€“ FINAL COMPACT ===== */
        #page-raporlar.reports-compact .card {
            padding: 10px !important;
        }

        #page-raporlar.reports-compact .card+.card {
            margin-top: 10px !important;
        }

        /* Ãœst baÅŸlÄ±k */
        #page-raporlar.reports-compact [style*="font-size:16px"] {
            font-size: 14px !important;
        }

        /* KÃ¼Ã§Ã¼k baÅŸlÄ±klar */
        #page-raporlar.reports-compact [style*="font-size: 10px"],
        #page-raporlar.reports-compact [style*="font-size:10px"],
        #page-raporlar.reports-compact [style*="font-size: 9px"],
        #page-raporlar.reports-compact [style*="font-size:9px"] {
            font-size: 12px !important;
        }

        /* Mini buton / select */
        #page-raporlar.reports-compact .mini-btn {
            min-height: 36px !important;
            padding: 7px 10px !important;
            font-size: 12px !important;
        }

        /* KPI kutularÄ± */
        #page-raporlar.reports-compact .sum-item {
            padding: 10px !important;
        }

        #page-raporlar.reports-compact .sum-val {
            font-size: 14px !important;
        }

        #page-raporlar.reports-compact .sum-lbl {
            font-size: 11px !important;
        }

        /* Grafik satÄ±rlarÄ± */
        #page-raporlar.reports-compact #rptBarsHost {
            gap: 8px !important;
        }

        /* Hint yazÄ±larÄ± */
        #page-raporlar.reports-compact .hint {
            font-size: 11px !important;
            margin-top: 8px !important;
            line-height: 1.25;
        }

        /* Reports - SeÃ§ili Ay Ã–zeti Detay Toggle */
        .details-wrap.is-hidden {
            display: none;
        }

        .details-wrap {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--stroke);
        }

        /* Ä°stersen butonu kompakt yap */
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--stroke);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-ghost:active {
            transform: scale(0.98);
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        body {
            text-size-adjust: 100%;
        }

        body {
            min-height: 100dvh;
        }
        
html, body{
  height: 100%;
  margin: 0;
  overflow: hidden;          /* âœ… sayfa ASLA kaymasÄ±n */
  overscroll-behavior: none; /* âœ… bounce kapat */
}
.pill-btn{
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.25);
  background: rgba(2,6,23,0.35);
  color: rgba(229,231,235,0.95);
  font-size: 12px;
  font-weight: 700;
}
.pill-btn.active{
  background: rgba(34,197,94,0.9);
  border-color: transparent;
  color: #052e1a;
}


body{
  /* padding'i body'den kaldÄ±rÄ±yoruz ki scroll Ã¼retmesin */
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;

  background:
    radial-gradient(circle at 20% 15%, rgba(56, 189, 248, .18), transparent 55%),
    radial-gradient(circle at 80% 35%, rgba(244, 114, 182, .16), transparent 55%),
    radial-gradient(circle at 50% 85%, rgba(34, 197, 94, .10), transparent 60%),
    radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);

  color: var(--text);
}


/* Header saÄŸ taraf: tarih Ã¼stte, giriÅŸ altta */
header .right{
  display: flex;
  flex-direction: column;   /* âœ… alt alta */
  align-items: flex-end;    /* saÄŸa yasla */
  gap: 8px;
}

header .right .today-card{
  width: auto;
}

/* âœ… btnAccount: sabit geniÅŸlik yok, sÄ±ÄŸmazsa Ã¼Ã§ nokta */
header .right #btnAccount{
  width: auto !important;           /* 96px/100pxâ€™i ez */
  max-width: 150px;                /* Ã§ok uzamasÄ±n */
  justify-content: center;

  overflow: hidden;                /* taÅŸanÄ± kes */
  white-space: nowrap;             /* alt satÄ±ra geÃ§mesin */
  text-overflow: ellipsis;         /* ... */
}

/* Ä°Ã§teki yazÄ± da ellipsis yesin */
#btnAccount #userChipText{
  display: inline-block;
  max-width: 110px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#btnAccount.user-chip{
  padding: 7px 12px;
  border-radius: 999px;
}
@media (max-width: 380px){
  header .right #btnAccount{ max-width: 120px; }
  #btnAccount #userChipText{ max-width: 86px; }
}
/* Header dÃ¼zeni toparla */
header{
  align-items: flex-start;     /* sol baÅŸlÄ±k yukarÄ±da kalsÄ±n */
  gap: 12px;
}

header > div:first-child{
  min-width: 0;
}

header .right{
  margin-left: auto;           /* saÄŸ bloÄŸu tam saÄŸa iter */
  display: flex;
  flex-direction: column;      /* tarih Ã¼stte, giriÅŸ altta */
  align-items: flex-end;
  gap: 8px;
}

header .right .today-card{
  min-width: 120px;
}

header .right #btnAccount{
  width: 96px;
  justify-content: center;
}
.account-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: #0f1b2d;
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 6px;
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
  z-index: 9999;
}

.account-anchor{
  position: relative;
  display: inline-block;
  width: fit-content;
}

.account-wrap { 
position: absolute; 
}
.account-menu.hidden {
  display: none;
}
.account-menu-item {
  width: 100%;
  background: transparent;
  border: 0;
  color: #fff;
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
}
.account-menu-item:hover {
  background: rgba(255,255,255,.08);
}
.action-card.opacity-50 {
  pointer-events: none;
}
.tbl th { text-align:left; padding:10px; font-size:12px; opacity:.75; }
.tbl td { border-top: 1px solid rgba(255,255,255,.08); }

.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}
.badge.pending{ background: rgba(255,193,7,.15); }
.badge.active{ background: rgba(76,175,80,.15); }
.badge.passive{ background: rgba(244,67,54,.12); }

.btn.btn-ok{ border:1px solid rgba(76,175,80,.5); }
.btn.btn-warn{ border:1px solid rgba(255,193,7,.5); }
.mini-btn {
  background: transparent;
  color: #9fb4ff;
  border: 1px solid rgba(255,255,255,0.15);
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
}
.mini-btn:hover {
  background: rgba(255,255,255,0.05);
}
.btn {
  background: transparent;
  color: #9fb4ff;
  border: 1px solid rgba(255,255,255,0.15);
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
}
.btn:hover {
  background: rgba(255,255,255,0.05);
}
.btn-danger {
  background: linear-gradient(135deg, #ff5f5f, #d94444);
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  cursor: pointer;
}
.btn-danger:hover {
  opacity: 0.9;
}

.btn-success {
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  cursor: pointer;
}
/* =========================
   USERS PAGE - COMPACT MODE
   ========================= */
#page-users.users-compact{
  font-size: 12.5px;
}

/* Header: baÅŸlÄ±k + toolbar aynÄ± satÄ±r */
#page-users.users-compact .users-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

/* Toolbar */
#page-users.users-compact .users-toolbar{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;        /* kesin tek satÄ±r */
  white-space:nowrap;
}

/* BaÅŸlÄ±klar */
#page-users.users-compact .page-title{
  font-size: 15px !important;
  line-height: 1.15;
  margin:0 !important;
}
#page-users.users-compact .page-subtitle{
  font-size: 9px !important;
  line-height: 1.15;
  margin-top:4px !important;
  opacity:.85;
}

/* Kart/alan boÅŸluklarÄ± (sayfanda card yoksa sorun deÄŸil) */
#page-users.users-compact .card{
  padding: 10px !important;
}

/* Butonlar */
#page-users.users-compact .btn,
#page-users.users-compact .save-btn{
  min-height: 30px !important;
  padding: 6px 10px !important;
  font-size: 11.5px !important;
  border-radius: 10px !important;
}
#page-users.users-compact .mini-btn{
  min-height: 30px !important;
  padding: 6px 9px !important;
  font-size: 11.5px !important;
  border-radius: 10px !important;
}

/* Info yazÄ±sÄ± */
#page-users.users-compact #usersInfo{
  font-size: 7px !important;
  opacity: .9;
}

/* Tablo */
#page-users.users-compact .tbl th{
  font-size: 10.5px !important;
  padding: 7px 6px !important;
  letter-spacing: .2px;
}
#page-users.users-compact .tbl td{
  font-size: 11.5px !important;
  padding: 9px 6px !important;
}

/* Durum pill/badge */
#page-users.users-compact .badge,
#page-users.users-compact .pill{
  font-size: 10.5px !important;
  padding: 3px 9px !important;
}

/* Aksiyon butonlarÄ± */
#page-users.users-compact .btn-danger,
#page-users.users-compact .btn-success{
  font-size: 10.5px !important;
  padding: 5px 9px !important;
  border-radius: 10px !important;
}
#page-users.users-compact .tbl th,
#page-users.users-compact .tbl td{
  line-height: 1.1;
}
/* ==== KullanÄ±cÄ± YÃ¶netimi: tabloyu kart gibi gÃ¶ster ==== */
#page-users .tbl thead,
#page-passive .tbl thead { display: none; }

#page-users .tbl,
#page-passive .tbl { width: 100%; border-collapse: separate; border-spacing: 0 10px; }

#page-users .tbl tbody tr,
#page-passive .tbl tbody tr {
  display: block;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  overflow: hidden;
}

#page-users .tbl td,
#page-passive .tbl td {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

#page-users .tbl tr td:last-child,
#page-passive .tbl tr td:last-child { border-bottom: none; }

#page-users .tbl td::before,
#page-passive .tbl td::before {
  content: attr(data-label);
  font-weight: 700;
  font-size: 12px;
  color: rgba(255,255,255,0.65);
  flex: 0 0 auto;
}

.u-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.user-link{
  background: transparent;
  border: none;
  color: #fff;
  font-weight: 800;
  text-decoration: underline;
  padding: 0;
  cursor: pointer;
}

.u-td { min-width: 0; }

/* ===== PROFÄ°L â€“ mobil kompakt ===== */
#pageProfil {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  max-height: calc(100dvh - 170px);
  padding-bottom: 90px;
}

#pageProfil .profil-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
  
}

#pageProfil .page-title{
  font-size: 16px;
}

#pageProfil .page-subtitle{
  font-size: 12px;
}

#pageProfil .profil-card{
  margin-top: 10px;
  padding: 10px;
}

#pageProfil .profil-card div{
  font-size: 13px;
  line-height: 1.35;
}

#pageProfil .profil-admin-actions{
  margin-top: 10px;
}

#pageProfil .profil-admin-actions .btn{
  width: 100%;
}


/* ===== PASÄ°F KULLANICILAR: ekran sÄ±ÄŸdÄ±r + kaydÄ±r ===== */
#page-passive{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  max-height: calc(100dvh - 170px);
  padding-bottom: 90px; /* alttaki nav bar Ã¼stÃ¼ne binmesin */
}

/* tablo kendi iÃ§inde de kayabilsin */
#page-passive .table-wrap{
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  max-height: calc(100dvh - 300px);
}

/* tabloyu kompaktlaÅŸtÄ±r (JS inline padding:10pxâ€™i de ezer) */
#page-passive .table th,
#page-passive .table td{
  padding: 6px 6px !important;
  font-size: 11px !important;
  line-height: 1.1 !important;
}

/* â€œAktif Yapâ€ butonu da kÃ¼Ã§Ã¼lsÃ¼n */
#page-passive .table .btn,
#page-passive .table .mini-btn{
  padding: 6px 8px !important;
  min-height: 32px !important;
  font-size: 11px !important;
}
.user-link{
  border:none;
  background:transparent;
  color: rgba(226,232,240,.95);
  font-weight: 900;
  padding: 0;
  text-decoration: underline;
  text-underline-offset: 3px;
}
.user-link:active{ transform: scale(.98); }
/* === GiriÅŸ yokken uygulamayÄ± tamamen kilitle === */
body.is-locked .app{
    
  pointer-events: none;
  user-select: none;
}


/* auth modal her zaman gÃ¶rÃ¼nÃ¼r kalsÄ±n */
body.is-locked #authModal{
    
  opacity: 1 !important;
  pointer-events: auto !important;
}


/* karartma katmanÄ± */
/* === GiriÅŸ yokken ekranÄ± kilitle (overlay body Ã¼stÃ¼nde) === */
body.is-locked::after{
    
  content:"";
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, .35);

}

#authModal{
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, .75);
  z-index: 9999 !important;
  
}
.history-head{
    
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
}
.history-head{
    
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
}

.mini-refresh{
    background: rgba(56,189,248,.15);
    color:#38bdf8;
    border:none;
    border-radius:999px;
    width:34px;
    height:34px;
    font-size:18px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:.15s;
}

.mini-refresh:hover{
    background: rgba(56,189,248,.28);
    transform: rotate(90deg);
}
.sync-meta{
  margin-top:4px;
  font-size:12px;
  opacity:.75;
}

/* refresh butonu dÃ¶nerken */
.mini-refresh.is-spinning{
  pointer-events:none;
  opacity:.85;
  animation: spin .8s linear infinite;
}

@keyframes spin{
  from{ transform: rotate(0deg); }
  to{ transform: rotate(360deg); }
}
@media (max-width: 640px){
  .orders-syncbar{ align-items:flex-start; }
  .orders-syncbar .mini-refresh{ margin-left:auto; }
}
.orders-syncbar .mini-refresh{
  background: rgba(56,189,248,.15) !important;
  color:#38bdf8 !important;
  border:none !important;
  border-radius:999px !important;
  width:34px !important;
  height:34px !important;
  font-size:18px !important;
  cursor:pointer !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  transition:.15s !important;
}

.orders-syncbar .mini-refresh:hover{
  background: rgba(56,189,248,.28) !important;
  transform: rotate(90deg) !important;
}

.orders-syncbar .mini-refresh.is-spinning{
  pointer-events:none !important;
  opacity:.85 !important;
  animation: spin .8s linear infinite !important;
}

@keyframes spin{
  from{ transform: rotate(0deg); }
  to{ transform: rotate(360deg); }
}
.orders-syncbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.orders-sync-left{
  display:flex;
  flex-direction:column;
  gap:2px;
}

/* buton fazla bÃ¼yÃ¼yorsa bunu uygula */
.mini-refresh{
  width:32px;
  height:32px;
  padding:0;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  line-height:1;
  flex:0 0 auto;
}
/* KullanÄ±cÄ± yÃ¶netimi ekranÄ±nda kartlar sayfayÄ± taÅŸÄ±rmasÄ±n, iÃ§eride scroll olsun */
#page-users .users-scroll{
  max-height: calc(100vh - 260px); /* Ã¼st bar + baÅŸlÄ±k + alt menÃ¼ payÄ± */
  overflow-y: auto;
  padding-right: 6px;
  -webkit-overflow-scrolling: touch;
}

/* Scrollbar daha ÅŸÄ±k (Chrome) */
#page-users .users-scroll::-webkit-scrollbar{ width: 8px; }
#page-users .users-scroll::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border-radius: 999px;
}
#page-users .users-scroll::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
/* Rozetleri daha okunaklÄ± yap */
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:11px;
  letter-spacing:.02em;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
}

/* Aktif */
.badge.b-ok{
  border-color: rgba(34,197,94,.55);
  background: rgba(34,197,94,.16);
  color: rgba(220,252,231,.98);
}

/* Onay bekliyor */
.badge.b-warn{
  border-color: rgba(250,204,21,.65);
  background: rgba(250,204,21,.14);
  color: rgba(254,249,195,.98);
}

/* Pasif */
.badge.b-off{
  border-color: rgba(148,163,184,.45);
  background: rgba(148,163,184,.12);
  color: rgba(226,232,240,.95);
}

/* Butonlar net olsun */
.u-actions .btn,
.u-actions .mini-btn{
  padding:8px 12px;
  border-radius:12px;
  font-weight:900;
  font-size:12px;
  letter-spacing:.01em;
  min-width: 92px;
}

/* Onayla */
.u-actions .btn-ok{
  border:1px solid rgba(34,197,94,.55);
  background: rgba(34,197,94,.18);
  color: rgba(220,252,231,.98);
}

/* Pasif Yap */
.u-actions .mini-btn{
  border:1px solid rgba(248,113,113,.55);
  background: rgba(248,113,113,.14);
  color: rgba(254,202,202,.98);
}

/* Ä°ÅŸlem butonlarÄ± sÄ±kÄ± */
#page-users .u-actions{
  display:flex;
  justify-content:flex-end;
  gap:6px;
}
/* âœ… KullanÄ±cÄ± YÃ¶netimi: en alta kadar insin (bottom-nav Ã¶rtmesin) */
#page-users .users-scroll{
  max-height: calc(100dvh - 220px); /* biraz daha alan */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;

  padding-bottom: 110px;  /* ðŸ”¥ en kritik satÄ±r: nav altÄ±nda kalmasÄ±n */
  padding-right: 6px;
}


/* ===== Auth loading button ===== */
.auth-btn.loading{
  opacity: .9;
  pointer-events: none;
  filter: saturate(.95);
}
.auth-btn .spin{
  display:none;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  border: 2px solid rgba(2,6,23,.25);
  border-top-color: rgba(2,6,23,.75);
  animation: spn .7s linear infinite;
}
.auth-btn .spin{
      display:none;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  border: 2px solid rgba(2,6,23,.25);
  border-top-color: rgba(2,6,23,.75);
  animation: spn .7s linear infinite;
}
.auth-btn.loading .spin{ display:inline-block; }

@keyframes spn{ to{ transform: rotate(360deg); } }
/* ===== USERS: tabloyu mobil kart listeye Ã§evir ===== */
#page-users .tbl thead{ display:none; } /* baÅŸlÄ±k satÄ±rÄ± kalksÄ±n */

/* tablo yapÄ±sÄ±nÄ± blok yap */
#page-users .tbl,
#page-users .tbl tbody,
#page-users .tbl tr,
#page-users .tbl td{
  display: block;
  width: 100%;
}

#page-users .tbl tbody tr{
  margin: 0 0 10px 0;
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(148,163,184,.20);
  background: rgba(15,23,42,.42);
}

/* her hÃ¼cre: sol label, saÄŸ deÄŸer */
#page-users .tbl td.u-td{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 7px 0 !important;
  border-bottom: 1px solid rgba(148,163,184,.10);
  font-size: 12px;
  font-weight: 800;
}
#page-users .tbl td.u-td:last-child{ border-bottom: 0; }

/* labelâ€™Ä± data-label'dan Ã§ek */
#page-users .tbl td.u-td::before{
  content: attr(data-label);
  color: rgba(148,163,184,.95);
  font-size: 11px;
  font-weight: 900;
}

/* kullanÄ±cÄ± adÄ± saÄŸda premium */
#page-users .u-name{
  text-decoration: underline;
  text-underline-offset: 3px;
  letter-spacing: .02em;
}

/* iÅŸlem satÄ±rÄ±nda buton saÄŸda kalsÄ±n */
#page-users .u-actions{
  display:flex;
  justify-content:flex-end;
  gap: 8px;
  flex-wrap: wrap;
}

/* rozet + butonlar minik */
#page-users .badge{ padding:4px 8px; font-size:10px; }
#page-users .u-actions .btn,
#page-users .u-actions .mini-btn{
  padding: 6px 10px;
  font-size: 11px;
  min-width: 84px;
  border-radius: 12px;
}
.rpt-breakdown{
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid rgba(148,163,184,0.14);
  font-size: 12px;
  line-height: 1.35;
  color: rgba(229,231,235,0.92);
}
.rpt-breakdown .title{
  font-weight: 900;
  letter-spacing: .3px;
  margin-bottom: 6px;
}
.rpt-breakdown .row{
  display: flex;
  position: relative;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 0;
  color: rgba(229,231,235,0.88);
}
.rpt-breakdown .row .y{
  opacity: .9;
}
.rpt-breakdown .row .v{
  font-weight: 800;
}
.rpt-breakdown .row:not(:last-child)::after{
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  bottom: -3px;
  height: 1px;
  background: linear-gradient(
    to right,
    rgba(148,163,184,0.00),
    rgba(148,163,184,0.18),
    rgba(148,163,184,0.00)
  );
}
/* En yÃ¼ksek yÄ±l (vurgu) */
.rpt-breakdown .row.max{
  color: #b13535; /* yeÅŸil */
  font-weight: 900;
}

/* En dÃ¼ÅŸÃ¼k yÄ±l (silik) */
.rpt-breakdown .row.min{
  color: rgba(35, 207, 49, 0.55);
}

/* Ok ikonlarÄ± */
/* SatÄ±r iÃ§inden ikon iÃ§in yer aÃ§ */
.rpt-breakdown .row{
  padding-left: 14px;   /* ikon iÃ§eride dursun */
}

/* Ok ikonlarÄ±: iÃ§eride, taÅŸma yok */
.rpt-breakdown .row.max::before,
.rpt-breakdown .row.min::before{
  position: absolute;
  left: 2px;            /* kartÄ±n iÃ§inde */
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  opacity: .9;
}


.rpt-breakdown .row.max::before{
  content: "â–²";
  color: #f30505;
}

.rpt-breakdown .row.min::before{
  content: "â–¼";
  color: rgba(35, 207, 49, 0.55);
}

    

/* ===== LoginNew UI (scoped) ===== */
#authModal .ln-card{ max-width: 520px; }
#authModal .ln-app{
  width: min(430px, 100%);
  border-radius: 22px;
  padding: 16px 16px 14px;
  background: radial-gradient(circle at top left, rgba(59,130,246,.26), rgba(15, 23, 42, 0.96));
  border: 1px solid rgba(148,163,184,.15);
  box-shadow: 0 24px 60px rgba(0,0,0,.55);
}
#authModal .ln-head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px; }
#authModal .ln-brand{ display:flex; gap:12px; align-items:center; }
#authModal .ln-logo{
  width:44px;height:44px;border-radius:14px;
  display:grid;place-items:center;
  background: linear-gradient(135deg, rgba(34,211,238,.18), rgba(14,165,233,.22));
  border: 1px solid rgba(148,163,184,.22);
}
#authModal .ln-h1{ font-weight:900; font-size:16px; line-height:1.2; }
#authModal .ln-sub{ font-size:11px; opacity:.78; margin-top:2px; }
#authModal .ln-mini{ font-size:11px; opacity:.7; user-select:none; }

#authModal .ln-tabs{
  display:grid; grid-template-columns:1fr 1fr; gap:10px; margin: 10px 0 8px;
  padding: 6px;
  border-radius: 999px;
  background: rgba(2,6,23,.22);
  border:1px solid rgba(148,163,184,.18);
}
#authModal .ln-tab{
  border:none; border-radius: 999px; padding: 10px 12px;
  font-weight: 900; cursor:pointer;
  background: transparent; color: rgba(226,232,240,.85);
}
#authModal .ln-tab.active{
  background: linear-gradient(135deg, #22d3ee, #0ea5e9);
  color:#06121a;
  box-shadow: 0 14px 28px rgba(8,145,178,.25);
}

#authModal .ln-msg{
  display:none;
  padding: 10px 12px;
  border-radius: 14px;
  margin: 6px 0 10px;
  background: rgba(34,211,238,.10);
  border:1px solid rgba(34,211,238,.22);
  color: rgba(226,232,240,.95);
  font-size: 12px;
}
#authModal .ln-msg:not(:empty){ display:block; }

#authModal .ln-msg.err{
  background: rgba(239,68,68,.10);
  border-color: rgba(239,68,68,.25);
}

#authModal .ln-box{ display:grid; gap:10px; }
#authModal .ln-field label{ display:block; font-size:12px; opacity:.86; margin: 2px 0 6px; }
#authModal .ln-input{
  display:flex; gap:10px; align-items:center;
  padding: 12px 12px;
  border-radius: 14px;
  background: rgba(2,6,23,.18);
  border: 1px solid rgba(148,163,184,.22);
}
#authModal .ln-input:focus-within{
  border-color: rgba(34,211,238,.40);
  background: rgba(34,211,238,.07);
  transform: translateY(-1px);
}
#authModal .ln-ico{ font-size: 14px; opacity:.9; user-select:none; }
#authModal .ln-input input{
  width:100%;
  border:none; outline:none;
  background: transparent;
  color: inherit;
  font-size: 13px;
  padding:0;
}
#authModal .ln-pin{ letter-spacing: .30em; font-variant-numeric: tabular-nums; }
#authModal .ln-row{ display:flex; justify-content:space-between; align-items:center; gap: 12px; margin-top:10px; }
#authModal .ln-muted{ opacity:.75; }
#authModal .ln-foot{ margin-top: 2px; font-size: 11px; opacity:.65; line-height:1.25; }
.ln-row{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  gap: 12px;
}

/* Admin linki â€“ compact */
#authModal .ln-admin-link{
  width: auto;
  padding: 0;
  background: transparent;
  border-radius: 0;
  font-size: 11px;
  font-weight: 600;
  color: #5fd4ff;
  opacity: .7;
  text-decoration: underline;
}

#authModal .ln-admin-link:hover{ opacity:1; }

/* YanlÄ±ÅŸ ÅŸifre olunca dikkat Ã§ekme */
#authModal .ln-admin-link.is-alert{
  opacity:1;
  text-decoration-thickness: 2px;
  animation: lnPulse 900ms ease-in-out 2;
}

@keyframes lnPulse{
  0%{ transform: translateY(0); }
  50%{ transform: translateY(-1px); }
  100%{ transform: translateY(0); }
}

/* Ä°stersen ÅŸifre input'u da sallasÄ±n */
#authModal .ln-input.is-shake{
  animation: lnShake 380ms ease-in-out 1;
}

@keyframes lnShake{
  0%,100%{ transform: translateX(0); }
  20%{ transform: translateX(-6px); }
  40%{ transform: translateX(6px); }
  60%{ transform: translateX(-4px); }
  80%{ transform: translateX(4px); }
}
#authModal .ln-btn{
  width:100%;
  border:none;
  border-radius: 999px;
  padding: 12px 12px;
  font-weight: 900;
  cursor:pointer;
}
#authModal .ln-primary{
  background: linear-gradient(135deg, #22d3ee, #0ea5e9);
  color:#06121a;
  box-shadow: 0 14px 28px rgba(8,145,178,.25);
}
#authModal .ln-ghost{
  background: rgba(2,6,23,.18);
  border: 1px solid rgba(148,163,184,.22);
  color: rgba(226,232,240,.95);
}
#authModal .ln-icon{
  width:auto;
  padding: 9px 12px;
  border-radius: 12px;
  background: rgba(2,6,23,.18);
  border: 1px solid rgba(148,163,184,.22);
  color: rgba(226,232,240,.95);
  white-space: nowrap;
  
}
/* Loading buton gÃ¶rÃ¼nÃ¼mÃ¼ */
#authModal .ln-btn.is-loading{
  opacity: .9;
  pointer-events: none;
  filter: saturate(.9);
}

#authModal .ln-btn .ln-spin{
  display: inline-block;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,.45);
  border-top-color: rgba(255,255,255,1);
  margin-right: 8px;
  vertical-align: -3px;
  animation: lnRotate .75s linear infinite;
}

@keyframes lnRotate{
  to { transform: rotate(360deg); }
}
/* Login buton loading */
#btnDoLogin{
  position: relative;
}

#btnDoLogin .spin{
  display: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,.45);
  border-top-color: #fff;
  margin-right: 8px;
  animation: lnRotate .75s linear infinite;
}

#btnDoLogin.loading .spin{
  display: inline-block;
}

#btnDoLogin.loading{
  pointer-events: none;
  opacity: .9;
}

@keyframes lnRotate{
  to { transform: rotate(360deg); }
}

</style>

</head>

<body>
   

    <div class="app">
        <header>
            <div>
                <h1>Su SipariÅŸ Takip</h1>
                <div class="subtitle">SipariÅŸ,borÃ§ ve Ã¶demeleri tek ekranda yÃ¶net</div>
            </div>
            
            <div class="right">
                <div class="today-card">
                    <div class="today-icon">ðŸ“…</div>
                    <div class="today-text">
                        <div class="today-label">BUGÃœN</div>
                        <div class="today-date" id="bugunTarih">--</div>
                       
                    </div>
                    <button id="btnRefresh" class="mini-refresh" title="Google'dan yenile">âŸ³</button>

                </div>
                
                <div class="account-anchor">
                    <button id="btnAccount" class="user-chip" type="button">
                        <span class="user-avatar">ðŸ‘¤</span>
                        <span id="userChipText" class="user-name">GiriÅŸ</span>
                    </button>
                
                    <div id="accountMenu" class="account-menu hidden">
                        <button id="btnLogout" class="account-menu-item">ðŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
                    </div>
                </div>


            </div>
        </header>
        <!-- Ã–ZET -->
        <div class="summary-section">
                   <div class="summary-panel">
                <div class="sum-left">
                    <div class="sum-item danger">
                        <div class="sum-val" id="kalanBorc">0 â‚º</div>
                        <div class="mini-battery">
                            <div class="mini-battery-fill" id="debtBatteryFill"></div>
                        </div>
                        <div class="mini-battery-text" id="debtBatteryText"></div>
                        <div class="sum-lbl">Kalan BorÃ§</div>
                    </div>
                </div>

                <div class="sum-right">
                    <div class="dash-yearbar year-float">

                        <button class="mini-btn year-btn" id="btnDashYearPrev" title="Ã–nceki yÄ±l">â—€</button>
                        <div class="dash-yeartext" id="dashYearText" tabindex="0" title="SeÃ§ili yÄ±l">2026</div>
                        <button class="mini-btn year-btn" id="btnDashYearNext" title="Sonraki yÄ±l">â–¶</button>

                        <button class="mini-btn year-all" id="btnDashYearAll" title="TÃ¼m YÄ±llar">âˆž</button>

                    </div>


                    <div class="sum-item">
                        <div class="sum-val" id="toplamBorcSag">0 â‚º</div>
                        <div class="sum-lbl">Toplam SipariÅŸ</div>
                    </div>

                    <div class="sum-left">
                        <div class="sum-big" id="toplamSiparis">0 Adet</div>
                        <div class="sum-sub">(12.09.2025 Tarihi Ä°tibariyle)</div>

                        <div class="pill pill-cyan">
                            <span class="pill-ico">ðŸ’§</span>

                            <span class="pill-money">
                                <span id="toplamBorc">0</span>
                                <span class="cur">â‚º</span>
                            </span>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div class="action-row">
            <div class="action-card card-order" data-perm="add">
                <div>
                    <div class="action-title">Yeni SipariÅŸ</div>
                    <div class="action-desc">Yeni damacana / pet su sipariÅŸi ver</div>
                </div>
            </div>

            <!-- KÄ±smi Ã–deme -->
            <div class="action-card card-payment" data-perm="admin">
                <div>
                    <div class="action-title">KÄ±smi Ã–deme</div>
                    <div class="action-desc">BorÃ§tan dÃ¼ÅŸÃ¼lecek su adedini gir</div>
                </div>
            </div>

        </div>
        <!-- ===== SAYFALAR (Screen/Page alanÄ±) ===== -->

        <!-- Dashboard zaten burada gÃ¶rÃ¼nÃ¼yor: summary-section + action-row -->
        <!-- ===== Profiller SAYFASI ===== -->
        <section id="pageProfil" class="page hidden">
            <div class="page-head profil-head">
                <div>
                    <div class="page-title">Profil</div>
                    <div class="page-subtitle">Hesap bilgileri</div>
                </div>
            </div>
        
            <!-- ðŸ‘¤ Hesap Bilgileri -->
            <div class="card profil-card">
                <div><b>KullanÄ±cÄ±:</b> <span id="profUsername"></span></div>
                <div><b>Rol:</b> <span id="profRole"></span></div>
                <div><b>Durum:</b> <span id="profStatus"></span></div>
            </div>
        
            <!-- ðŸ‘‘ Admin iÃ§in: KullanÄ±cÄ± YÃ¶netimi sayfasÄ±na geÃ§ -->
            <div data-perm="admin" class="profil-admin-actions">
                <button id="btnGoUsersPage" class="btn">KullanÄ±cÄ± YÃ¶netimi</button>
                <button id="btnGoPassivePage" class="btn" style="margin-top:10px;">Pasif KullanÄ±cÄ±lar</button>

            </div>
        </section>
          
        
        <!-- ===== KULLANICI YÃ–NETÄ°MÄ° SAYFASI ===== -->
        <section id="page-users" class="page hidden users-compact" data-perm="admin">
            <div class="page-head users-head">
                <div>
                    <div class="page-title">KullanÄ±cÄ± YÃ¶netimi</div>
                    <div class="page-subtitle">Ãœyelik onayÄ± / aktif-pasif</div>
                </div>
            
                <div class="users-toolbar">
                    <button id="btnUsersBack" class="mini-btn">â† Profil</button>
                    <button id="btnUsersRefresh" class="btn">Yenile</button>
                    <span id="usersInfo" class="subtitle"></span>
                </div>
            </div>


        
            <div class="users-scroll" style="margin-top:10px;">

                <table class="tbl" style="width:100%;">
                    <thead>
                        <tr>
                            <th>KullanÄ±cÄ±</th>
                            <th>Rol</th>
                            <th>Durum</th>
                            <th>Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody id="usersTbody"></tbody>
                </table>
                
            </div>

        </section>
        <!-- PASÄ°F KULLANICILAR -->
        <section id="page-passive" class="page hidden">
            <div class="page-head">
                <div>
                    <div class="page-title">Pasif KullanÄ±cÄ±lar</div>
                    <div class="page-subtitle">Pasife Ã§ekilen hesaplar</div>
                </div>
                <button class="mini-btn" id="btnPassiveRefresh">Yenile</button>
            </div>

            
            <div class="card" style="margin-top:12px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 2px;">
                    <div style="font-weight:900;">Pasif KullanÄ±cÄ±lar</div>
                    <div id="passiveInfo" style="opacity:.8; font-size:12px;">0</div>
                </div>

                <div class="table-wrap users-scroll">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>KullanÄ±cÄ±</th>
                                <th>Rol</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="passiveTbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ===== SÄ°PARÄ°ÅžLER SAYFASI ===== -->
        <section class="page hidden" id="page-siparisler">
            <div class="card">
                <div class="orders-wrap">

                    <div class="table-wrap" id="ordersList">
                        <!-- JS tabloyu buraya basacak -->
                    </div>
                </div>
            </div>
            <div class="pager" id="ordersPager">
                <button class="mini-btn" id="btnPrevPage">â—€</button>
                <div class="pager-info" id="pageInfo">Sayfa 1 / 1</div>
                <button class="mini-btn" id="btnNextPage">â–¶</button>
            </div>

        </section>
        <!-- ===== RAPORLAR SAYFASI ===== -->
        <section class="page hidden reports-compact" id="page-raporlar">

            <!-- Ãœst Bar: YÄ±l seÃ§ici -->
            <div class="card" style="padding:14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <div style="font-weight:900; font-size:16px;">Raporlar</div>
<button id="rptAllYearsBtn" class="pill-btn">TÃ¼mÃ¼</button>


                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="mini-btn" id="rptYearPrev" title="Ã–nceki YÄ±l">â—€</button>
                        <div id="rptYearLabel" style="min-width:72px; text-align:center; font-weight:900;">2026</div>
                        <button class="mini-btn" id="rptYearNext" title="Sonraki YÄ±l">â–¶</button>
                    </div>
                </div>
                <!-- YÄ±llÄ±k Mini Ã–zet -->
                <div class="sum-row">
                    <div class="card" style="margin-top:12px;">
                        <div class="rpt-grid-2" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div class="sum-item" style="margin:0;">
                                <div class="sum-val" id="rptYearTotalMoney">0 â‚º</div>
                                <div class="sum-lbl">YÄ±llÄ±k Toplam</div>
                            </div>

                            <div class="sum-item danger" style="margin:0;">
                                <div class="sum-val" id="rptYearRemainMoney">0 â‚º</div>
                                <div class="sum-lbl">YÄ±llÄ±k Kalan</div>
                            </div>
                        </div>
                    </div>

                    <!-- kÃ¼Ã§Ã¼k bilgi satÄ±rÄ± (kalabalÄ±k yapmaz) -->
                    <div class="hint" id="rptBestMonthLine" style="margin-top:10px;">--</div>
                </div>


                <div class="hint" style="margin-top:8px;">
                    YÄ±llara gÃ¶re aylÄ±k sipariÅŸ yoÄŸunluÄŸunu karÅŸÄ±laÅŸtÄ±r.
                </div>
            </div>


            <!-- KPI KartlarÄ±: seÃ§ili ayÄ±n Ã¶zeti -->
            <!-- KPI KartlarÄ±: seÃ§ili ayÄ±n Ã¶zeti -->
            <div class="card" style="margin-top:12px;">

                <!-- BaÅŸlÄ±k satÄ±rÄ± -->
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="font-weight:900;font-size:10px;">SeÃ§ili Ay Ã–zeti</div>

                    <button id="btnMonthDetailsToggle" class="btn-ghost" type="button" aria-expanded="false">
                        Detay
                    </button>
                </div>

                <!-- Detay alanÄ± (default gizli) -->
                <div id="monthDetailsWrap" class="details-wrap is-hidden" style="margin-bottom:10px;">
                    <select id="rptMonthSelect" class="mini-btn"
                        style="padding:10px 12px; border-radius:12px; width:100%;">
                        <option value="0">Ocak</option>
                        <option value="1">Åžubat</option>
                        <option value="2">Mart</option>
                        <option value="3">Nisan</option>
                        <option value="4">MayÄ±s</option>
                        <option value="5">Haziran</option>
                        <option value="6">Temmuz</option>
                        <option value="7">AÄŸustos</option>
                        <option value="8">EylÃ¼l</option>
                        <option value="9">Ekim</option>
                        <option value="10">KasÄ±m</option>
                        <option value="11">AralÄ±k</option>
                    </select>
                </div>

                <!-- Tek satÄ±r aylÄ±k Ã¶zet (minimal) -->
                <div id="rptMonthOneLine" class="hint" style="margin-bottom:8px; font-weight:600;">
                    --
                </div>
                    <div id="rptMonthYearBreakdown" class="rpt-breakdown" style="display:none;"></div>

                <div id="rptMonthKpiGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="sum-item" style="margin:0;">
                        <div class="sum-val" id="rptKpiQty">0 Adet</div>
                        <div class="sum-lbl">Toplam SipariÅŸ</div>
                    </div>

                    <div class="sum-item" style="margin:0;">
                        <div class="sum-val" id="rptKpiTotal">0 â‚º</div>
                        <div class="sum-lbl">Toplam Tutar</div>
                    </div>

                    <div class="sum-item" style="margin:0;">
                        <div class="sum-val" id="rptKpiPaid">0 â‚º</div>
                        <div class="sum-lbl">Ã–denen</div>
                    </div>

                    <div class="sum-item danger" style="margin:0;">
                        <div class="sum-val" id="rptKpiRemain">0 â‚º</div>
                        <div class="sum-lbl">Kalan BorÃ§</div>
                    </div>
                </div>

            </div>

            <!-- AylÄ±k Grafik AlanÄ± -->
            <div class="card" style="margin-top:12px;">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="font-weight:900;font-size: 9px;">AylÄ±k SipariÅŸ GrafiÄŸi</div>
                    <select id="rptChartMode" class="mini-btn" style="padding:10px 12px; border-radius:12px;">
                        <option value="qty">Adet</option>
                        <option value="total">Tutar (â‚º)</option>
                    </select>
                </div>

                <!-- Basit bar chart host (JS buraya bar basacak) -->
                <div id="rptBarsHost" style="display:grid; gap:10px;"></div>

                <div class="hint" style="margin-top:10px;">
                    Bir aya tÄ±klayÄ±nca â€œSeÃ§ili Ay Ã–zetiâ€ otomatik gÃ¼ncellenecek.
                </div>
            </div>


        </section>


        <!-- ================== SAYFALAR ================== -->

        <!-- AYARLAR SAYFASI -->
        <section class="page hidden" id="page-ayarlar">
            <!-- Damacana / Pet / Firma / WhatsApp -->
            <div class="settings-grid">

                <div class="field">
                    <label>Damacana Birim Fiyat (â‚º)</label>
                    <input id="inpPriceDamacana" type="number" min="0" step="1" placeholder="Ã–rn: 120">
                </div>

                <div class="field">
                    <label>0,5L Pet Birim Fiyat (â‚º)</label>
                    <input id="inpPricePet05" type="number" min="0" step="1" placeholder="Ã–rn: 5">
                </div>

                <div class="field span-2">
                    <label>Firma AdÄ±</label>
                    <input id="inpFirmaAdi" type="text" placeholder="Ã–rn: ABDULLAH Ã–ZER">
                    <div class="hint">SipariÅŸler/borÃ§ ekranÄ±nda isim burada yazan sabit firma adÄ± olur.</div>
                </div>

                <div class="field span-2">
                    <label>Firma WhatsApp NumarasÄ±</label>
                    <input id="inpWhatsapp" type="text" placeholder="Ã–rn: 90555XXXXXXX">
                    <div class="hint">BaÅŸÄ±nda Ã¼lke kodu olsun: 90 ile (boÅŸluksuz).</div>
                </div>

            </div>

            <div class="settings-actions">
                <button class="save-btn" id="btnSaveSettings">Kaydet</button>
                <!-- Accordion: Yedekleme -->
                <!-- Yedekleme: JSON / EXCEL -->
                
                <div class="backup-row">
                    <!-- JSON -->
                    <div class="drop">
                        <button class="mini-btn drop-btn" id="btnDropJson" type="button">
                            ðŸ§© JSON â–¾
                        </button>
                        <div class="drop-menu" id="menuJson">
                            <button class="drop-item" id="btnJsonExport" type="button">ðŸ“¥ DÄ±ÅŸa Aktar</button>
                            <button class="drop-item" id="btnJsonImport" type="button">ðŸ“¤ Ä°Ã§e Aktar</button>
                        </div>
                    </div>

                
                </div>

                
                <div class="hint">
                    JSON: tÃ¼m verileri taÅŸÄ±r. Excel: CSV formatÄ± (Excelâ€™de aÃ§Ä±lÄ±r).
                </div>
                            
                <!-- Accordion: Ã‡Ã¶p Kutusu -->
                <details class="acc">
                    <summary>
                        <span>ðŸ—‘ï¸ Ã‡Ã¶p Kutusu <span id="trashBadgeInline" style="opacity:.7;"></span></span>
                        <span style="opacity:.7;">AÃ§ / Kapat</span>
                    </summary>

                    <div class="acc-body">
                        <button class="save-btn" id="btnOpenTrash">ðŸ—‘ï¸ Ã‡Ã¶p Kutusu</button>
                        <div class="hint">Silinen sipariÅŸ/Ã¶demeleri buradan geri yÃ¼kleyebilirsin.</div>
                    </div>
                </details>

                <!-- Accordion: Verileri Sil -->
                <details class="acc">
                    <summary>
                        <span>âš ï¸ Verileri Sil</span>
                        <span style="opacity:.7;">AÃ§ / Kapat</span>
                    </summary>

                    <div class="acc-body">
                        <div class="hint" style="margin-bottom:6px;">
                            Dikkat: Bu iÅŸlem geri alÄ±namaz. â€œSipariÅŸlerâ€ silinirse Ã¶demeler de temizlenir (veri
                            tutarlÄ±lÄ±ÄŸÄ± iÃ§in).
                        </div>

                        <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;">
                            <input type="radio" name="clearDataType" value="payments" checked>
                            Sadece Ã–demeleri Sil
                        </label>

                        <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;">
                            <input type="radio" name="clearDataType" value="orders">
                            SipariÅŸleri Sil (Ã–demeler de silinir)
                        </label>

                        <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;">
                            <input type="radio" name="clearDataType" value="all">
                            Hepsini Sil (SipariÅŸ + Ã–deme)
                        </label>
                </details>

        </section>
        <!-- ================== AUTH MODAL (GÄ°RÄ°Åž / ÃœYE OL) ================== -->
            <!-- ================== AUTH MODAL (Login / Signup) ================== -->
            <div id="authModal" class="modal hidden" aria-hidden="true">
  <div class="modal-backdrop" id="authBg"></div>

  <div class="modal-card auth-card ln-card">
    <div class="auth-top">
      <div class="auth-title">Su SipariÅŸ Takip</div>
    </div>

    <div class="ln-app">
      <header class="ln-head">
        <div class="ln-brand">
          <div class="ln-logo" aria-hidden="true">ðŸ’§</div>
          <div>
            <div class="ln-h1">GiriÅŸ</div>
            <div class="ln-sub">Google Sheets senkronu: giriÅŸten sonra aktif.</div>
          </div>
        </div>
        <div class="ln-mini">vLogin</div>
      </header>

      <div class="ln-tabs" role="tablist" aria-label="GiriÅŸ sekmeleri">
        <button class="ln-tab active" id="tabLogin" type="button" role="tab" aria-selected="true">GiriÅŸ</button>
        <button class="ln-tab" id="tabSignup" type="button" role="tab" aria-selected="false">Ãœye Ol</button>
      </div>

      <div id="authMsg" class="ln-msg auth-msg" aria-live="polite"></div>

      <!-- LOGIN -->
      <div id="authLoginBox" class="ln-box">
        <div class="ln-field">
          <label for="loginUser">KullanÄ±cÄ± AdÄ±</label>
          <div class="ln-input">
            <span class="ln-ico" aria-hidden="true">ðŸ‘¤</span>
            <input id="loginUser" type="text" placeholder="Ã¶r: MUSTAFA" autocomplete="username" />
          </div>
        </div>

        <div class="ln-field">
          <label for="loginPass">Åžifre / PIN</label>
          <div class="ln-input">
            <span class="ln-ico" aria-hidden="true">ðŸ”’</span>
            <input id="loginPass" class="ln-pin" type="password" placeholder="â€¢â€¢â€¢â€¢" autocomplete="current-password" />
            <button class="ln-btn ln-icon" type="button" id="btnShowLogin" aria-label="Åžifre gÃ¶ster/gizle">ðŸ‘ï¸</button>
          </div>
          <div class="ln-row">
            <div class="ln-mini ln-muted">4 haneli PIN kullanÄ±yorsan: sadece rakam.</div>
           <button class="ln-btn ln-admin-link" type="button" id="btnWaReset">
  ðŸ’¬ Åžifre sÄ±fÄ±rlamak iÃ§in admine mesaj at
</button>


          </div>
        </div>

        <button id="btnDoLogin" class="ln-btn ln-primary" type="button">
          <span class="spin"></span>
          <span class="txt">GiriÅŸ Yap</span>
        </button>

        <div class="ln-foot">Not: GiriÅŸ baÅŸarÄ±lÄ± olunca uygulama otomatik olarak Google Sheetsâ€™ten verileri senkronlar.</div>
      </div>

      <!-- SIGNUP -->
      <div id="authSignupBox" class="ln-box" style="display:none;">
        <div class="ln-field">
          <label for="signUser">KullanÄ±cÄ± AdÄ±</label>
          <div class="ln-input">
            <span class="ln-ico" aria-hidden="true">ðŸªª</span>
            <input id="signUser" type="text" placeholder="Ã¶r: MUSTAFA" />
          </div>
          <div class="ln-mini ln-muted">Ä°pucu: TÃ¼rkÃ§e harf + boÅŸluk kullanabilirsin.</div>
        </div>

        <div class="ln-field">
          <label for="signPass">Åžifre / PIN</label>
          <div class="ln-input">
            <span class="ln-ico" aria-hidden="true">ðŸ”¢</span>
            <input id="signPass" class="ln-pin" type="password" placeholder="â€¢â€¢â€¢â€¢" />
            <button class="ln-btn ln-icon" type="button" id="btnShowSign" aria-label="Åžifre gÃ¶ster/gizle">ðŸ‘ï¸</button>
          </div>
        </div>

        <div class="ln-field">
          <label for="signPass2">Åžifre / PIN Tekrar</label>
          <div class="ln-input">
            <span class="ln-ico" aria-hidden="true">âœ…</span>
            <input id="signPass2" class="ln-pin" type="password" placeholder="â€¢â€¢â€¢â€¢" />
          </div>
        </div>

        <button id="btnDoSignup" class="ln-btn ln-primary" type="button">Ãœye Ol</button>
        <button id="btnBackLogin" class="ln-btn ln-ghost" type="button">GiriÅŸe DÃ¶n</button>

        <div class="ln-foot">KayÄ±t sonrasÄ± admin onayÄ± gerekebilir (status: pending/passive/active).</div>
        <div id="authMsg2" class="ln-msg auth-msg" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>



        <nav class="bottom-nav">
            <button class="nav-item active" data-page="dashboard">
                <div class="nav-icon">ðŸ </div>
                <div>AnaSayfa</div>
            </button>

            <button class="nav-item" data-page="siparisler">
                <div class="nav-icon">ðŸ§¾</div>
                <div>SipariÅŸler</div>
            </button>

            <button class="nav-item" data-page="raporlar">
                <div class="nav-icon">ðŸ“Š</div>
                <div>Raporlar</div>
            </button>
            <button class="nav-item" data-page="profil">
                <div class="nav-icon">ðŸ‘¤</div>
                <div>Profil</div>
            </button>

            <button class="nav-item" data-page="ayarlar">
                <div class="nav-icon">âš™ï¸</div>
                <div>Ayarlar</div>
            </button>
        </nav>
        <!-- ================== KALAN BORÃ‡ MODAL ================== -->
        <div id="debtModal" class="modal hidden" aria-hidden="true">
            <div class="modal-backdrop" id="closeDebtBg"></div>

            <div class="modal-card debt-card">
                <div class="modal-head">
                    <div style="font-weight:900;">Kalan BorÃ§ DetayÄ±</div>
                    <button class="modal-x" id="closeDebtX">âœ•</button>
                </div>

                <div class="debt-top">
                    <div class="debt-meta" id="debtTotals">0 adet â€¢ 0 â‚º</div>
                    <button class="mini-btn" id="btnDebtWhatsapp">WhatsApp ile GÃ¶nder</button>
                </div>

                <div class="table-wrap" id="debtTableHost"></div>
            </div>
        </div>

    </div>
    <!-- ================== YENÄ° SÄ°PARÄ°Åž MODAL ================== -->
    <div id="orderModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="closeModalBg"></div>

        <div class="modal-card">
            <div class="modal-head">
                <div style="font-weight:800;">Yeni SipariÅŸ</div>
                <button class="modal-x" id="closeModalX">âœ•</button>
            </div>

            <div class="order-grid-2">
                <div class="field">
                    <label>ÃœrÃ¼n</label>
                    <select id="ordProduct">
                        <option value="damacana">Damacana</option>
                        <option value="pet05">0,5L Pet ÅžiÅŸe</option>
                    </select>
                </div>

                <div class="field">
                    <label>Tarih</label>
                    <input id="ordDate" type="date">
                </div>
            </div>

            <div class="order-grid-2" style="margin-top:12px;">
                <div class="field">
                    <label>Adet</label>
                    <input id="ordQty" type="number" min="1" step="1" placeholder="Adet gir">
                </div>

                <div class="field">
                    <label>Birim Fiyat (â‚º)</label>
                    <input id="ordUnitPrice" type="number" min="0" step="1" value="0" readonly tabindex="-1">

                </div>
            </div>


            <button class="save-btn" id="btnSendWhatsapp" style="margin-top:14px;">
                SipariÅŸi Kaydet
            </button>

            <div class="subtitle" id="orderInfo" style="margin-top:10px;"></div>
        </div>
    </div>
    <!-- ================== EVRENSEL POPUP (UI DIALOG) ================== -->
    <div id="uiDialog" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="uiCloseBg"></div>

        <div class="modal-card">
            <div class="modal-head">
                <div id="uiTitle" style="font-weight:800;">BaÅŸlÄ±k</div>
                <button class="modal-x" id="uiCloseX">âœ•</button>
            </div>

            <div class="confirm-box">
                <div class="confirm-title" id="uiSubtitle">Bilgi</div>
                <div class="confirm-preview" id="uiBody"></div>
            </div>

            <div class="confirm-actions">
                <button class="ghost-btn" id="uiCancelBtn">VazgeÃ§</button>
                <button class="save-btn" id="uiOkBtn">Tamam</button>
            </div>
        </div>
    </div>
    <div class="modal hidden" id="trashModal" aria-hidden="true">
        <div class="modal-backdrop" id="trashBg"></div>

        <div class="modal-card" style="max-height:82vh; overflow:hidden; display:flex; flex-direction:column;">
            <div class="modal-head">
                <div>
                    <div style="font-weight:900; font-size:16px;">ðŸ—‘ï¸ Ã‡Ã¶p Kutusu</div>
                    <div style="font-size:11px; color:rgba(156,163,175,.95); margin-top:4px;">
                        Silinenleri geri yÃ¼kleyebilir veya kalÄ±cÄ± silebilirsin.
                    </div>
                </div>
                <button class="modal-x" id="trashX">âœ•</button>
            </div>

            <div id="trashHost" style="flex:1; overflow:auto; padding-right:6px; -webkit-overflow-scrolling:touch;">
            </div>

            <div style="display:flex; gap:10px; margin-top:12px;">
                <button class="danger-btn" id="btnTrashEmpty" style="flex:1;">KalÄ±cÄ± Olarak Temizle</button>
                <button class="save-btn" id="btnTrashClose" style="flex:1;">Kapat</button>
            </div>
        </div>
    </div>

    <!-- ================== KISMI Ã–DEME MODAL (YENÄ°) ================== -->
    <div id="payModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="closePayBg"></div>

        <div class="modal-card" style="max-width: 560px;">
            <div class="modal-head">
                <div style="font-weight:800;">Ã–deme Ekle</div>
                <button class="modal-x" id="closePayX">âœ•</button>
            </div>
            <div class="modal-tabs" id="payTabs">
                <button type="button" class="tab-btn active" data-tab="pay">Ã–deme</button>
                <button type="button" class="tab-btn" data-tab="history">GeÃ§miÅŸ</button>
            </div>
            <div class="tab-panel" id="tabPay">
                <div class="field">
                    <label>Tarih</label>
                    <input id="payDate" type="date">
                </div>

                <div id="payGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">

                    <div class="field">
                        <label>Ã–denen Su Adeti</label>
                        <input id="payQty" type="number" min="0" step="1" placeholder="Ã–rn: 3">
                        <div class="hint">Adet girince tutar FIFOâ€™ya gÃ¶re hesaplanÄ±r.</div>
                    </div>

                    <div class="field">
                        <label>Ã–denen Tutar (â‚º)</label>
                        <input id="payAmount" type="number" min="0" step="0.01" placeholder="Ã–rn: 360">
                        <div class="hint">Tutar girince alÄ±nabilecek adet FIFOâ€™ya gÃ¶re hesaplanÄ±r.</div>
                    </div>
                </div>

                <div class="subtitle" id="payCalcInfo" style="margin-top:10px;"></div>
                <div class="subtitle" id="payAfterInfo"
                    style="margin-top:6px; color: rgba(226,232,240,.92); font-weight:800;"></div>


                <div class="field" style="margin-top:12px;">
                    <input id="payNote" type="text" placeholder="AÃ§Ä±klama (opsiyonel)">
                </div>

                <div class="confirm-actions" style="margin-top:12px;">
                    <button class="ghost-btn" id="btnPayCancel">VazgeÃ§</button>
                    <button class="save-btn" id="btnPayApply">Ã–deme Yap</button>
                </div>
            </div>
            
            <div class="tab-panel hidden" id="tabHistory">
                <div class="history-head">
                    <div>
                        <div class="history-title">Ã–deme GeÃ§miÅŸi</div>
                        <div class="sync-meta" id="payLastSync">Son senkron: -</div>
                    </div>
                
                    <button id="btnPayRefresh" class="mini-refresh" title="Google'dan tekrar Ã§ek">âŸ³</button>
                </div>
           
                <div class="table-wrap" id="payHistoryHost"></div>
            </div>

        </div>
    </div>

    <script>
        
const ADMIN_WHATSAPP_E164 = "905311012925"; 
// Ã–rnek: TÃ¼rkiye iÃ§in baÅŸÄ±nda + yok: "905551112233"
function getLoginIdentifier() {
  // Buraya senin login ekranÄ±ndaki kullanÄ±cÄ± input id'lerini yazdÄ±m.
  // Hangisi varsa onu alacak.
  const el =
    document.getElementById("loginUser") ||     // varsa
    document.getElementById("loginName") ||     // varsa
    document.getElementById("loginEmail") ||    // varsa
    document.getElementById("username") ||      // varsa
    document.getElementById("user") ||          // varsa
    null;

  const v = (el?.value || "").trim();
  return v || "Bilinmiyor";
}

function buildResetMessage() {
  const typedUser = getLoginIdentifier();
  const when = new Date().toLocaleString("tr-TR");

  const passVal = (document.getElementById("loginPass")?.value || "").trim();
  const pinHint = (/^\d{4}$/.test(passVal)) ? " (4 haneli PIN denedi)" : "";

  return (
    `Merhaba, ÅŸifre/PIN sÄ±fÄ±rlama talep ediyorum.\n` +
    `KullanÄ±cÄ±: ${typedUser}${pinHint}\n` +
    `Tarih/Saat: ${when}\n` +
    `Not: GiriÅŸ ekranÄ±ndan yÃ¶nlendirildim.`
  );
}


function openWhatsAppToAdmin() {
  if (!ADMIN_WHATSAPP_E164 || ADMIN_WHATSAPP_E164.includes("X")) {
    alert("Admin WhatsApp numarasÄ± ayarlanmadÄ±. app.js -> ADMIN_WHATSAPP_E164");
    return;
  }

  const text = buildResetMessage();
  const url = `https://wa.me/${ADMIN_WHATSAPP_E164}?text=${encodeURIComponent(text)}`;
  window.open(url, "_blank", "noopener,noreferrer");
}


document.getElementById("btnWaReset")?.addEventListener("click", openWhatsAppToAdmin);

        function showToast(message, type = "info", duration = 2600) {
            const host = document.getElementById("toastHost");
            if (!host) return;

            const toast = document.createElement("div");
            toast.className = `toast ${type}`;

            const icon =
                type === "success" ? "âœ…" :
                    type === "error" ? "âš ï¸" :
                        "â„¹ï¸";

            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            host.appendChild(toast);

            setTimeout(() => toast.remove(), duration);
        }
   function nudgeAdminResetLink() {
  const link = document.getElementById("btnWaReset");
  const inputWrap = document.querySelector("#authModal .ln-input");

  link?.classList.remove("is-alert");
  inputWrap?.classList.remove("is-shake");

  // reflow trick (anim tekrar oynasÄ±n diye)
  void link?.offsetWidth;
  void inputWrap?.offsetWidth;

  link?.classList.add("is-alert");
  inputWrap?.classList.add("is-shake");

  setTimeout(() => {
    link?.classList.remove("is-alert");
    inputWrap?.classList.remove("is-shake");
  }, 1200);
}

    /* ================== AUTH (Login / Signup) ================== */
    const USERS_KEY = "su_users_v1";
    const SESSION_KEY = "su_session_v1";
        function applyPermissions() {
                const adminOk = isAdminActive();
                const addOk = canAddOrder();

                // ---- SipariÅŸ ekleme (admin + active user)
                document.querySelectorAll("[data-perm='add']").forEach(el => {
                    el.classList.toggle("opacity-50", !addOk);
                    el.style.pointerEvents = addOk ? "" : "none";
                });

                // ---- Admin-only (ayarlar, silme, kÄ±smi Ã¶deme)
                document.querySelectorAll("[data-perm='admin']").forEach(el => {
                    el.style.display = adminOk ? "" : "none";
                });

                // ---- Pending / passive uyarÄ±sÄ±
                const warn = document.getElementById("pendingWarn");
                if (warn) {
                    warn.style.display = (!adminOk && !addOk) ? "block" : "none";
                }
            }


    function loadUsers() {
        try { return JSON.parse(localStorage.getItem(USERS_KEY) || "[]") || []; }
        catch { return []; }
    }
    function saveUsers(list) {
        localStorage.setItem(USERS_KEY, JSON.stringify(list || []));
    }
const SESSION_TTL_MS = 15 * 60 * 1000; // 15 dk: kullanÄ±lmayÄ±nca otomatik dÃ¼ÅŸÃ¼r (istersen deÄŸiÅŸtir)

function getSessionRaw() {
  try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "null"); }
  catch { return null; }
}

function getSession() {
  const s = getSessionRaw();
  if (!s) return null;

  // expire kontrol
  if (s.expiresAt && Date.now() > Number(s.expiresAt)) {
    localStorage.removeItem(SESSION_KEY);
    return null;
  }
  return s;
}

function setSession(user) {
  if (!user) { localStorage.removeItem(SESSION_KEY); return; }
  const now = Date.now();
  const s = {
    ...user,
    issuedAt: now,
    lastActiveAt: now,
    expiresAt: now + SESSION_TTL_MS
  };
  localStorage.setItem(SESSION_KEY, JSON.stringify(s));
}

function touchSession() {
  const s = getSessionRaw();
  if (!s?.username) return;
  const now = Date.now();
  s.lastActiveAt = now;
  s.expiresAt = now + SESSION_TTL_MS;
  localStorage.setItem(SESSION_KEY, JSON.stringify(s));
}

function clearSession() {
  localStorage.removeItem(SESSION_KEY);
}

    function doLogout() {
            clearSession();        // su_session_v1 silinir
            currentUser = null;
            updateUserChip();
            location.reload();     // temiz sayfa
        }


    function openAuth() {
    
        setAppLocked(true);
        const m = document.getElementById("authModal");
        if (!m) return;
        m.classList.remove("hidden");
        m.setAttribute("aria-hidden", "false");
    }
    function closeAuth() {
    if (!currentUser?.username) return; // giriÅŸ yokken auth kapanmasÄ±n

        const m = document.getElementById("authModal");
        if (!m) return;
        m.classList.add("hidden");
        m.setAttribute("aria-hidden", "true");
    }

    function setAuthMsg(txt, which = 1) {
        const el = document.getElementById(which === 1 ? "authMsg" : "authMsg2");
        if (el) el.textContent = txt || "";
    }
    let currentUser = getSession(); // { username, role, status }
    function bindAutoLogout() {
  const logoutNow = () => {
    if (currentUser?.username) doLogout();
  };

  // âœ… arka plan / uygulama baÅŸka yere geÃ§ince
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) logoutNow();
    else touchSession(); // geri dÃ¶ndÃ¼yse session tazele (zaten logout olduysa bir ÅŸey yapmaz)
  });

  // âœ… iOS/Safariâ€™de visibility bazen kaÃ§Ä±rÄ±r, garanti:
  window.addEventListener("pagehide", logoutNow);

  // âœ… kullanÄ±m takibi (idle logout)
  let idleTimer = null;
  const resetIdle = () => {
    if (!currentUser?.username) return;
    touchSession();
    clearTimeout(idleTimer);
    idleTimer = setTimeout(logoutNow, SESSION_TTL_MS);
  };

  ["click","touchstart","keydown","scroll"].forEach(ev => {
    document.addEventListener(ev, resetIdle, { passive: true });
  });

  resetIdle();
}

bindAutoLogout();

    function isAdminActive() {
            return currentUser && (currentUser.role === "admin") && (currentUser.status === "active");
        }

        function canAddOrder() {
                return !!currentUser; // giriÅŸ yapan herkes sipariÅŸ verebilir
            }


        function canAccessSettings() {
            return isAdminActive(); // sadece admin
        }

    function canAddOrder() {
            return (
                currentUser &&
                (currentUser.status || "passive") === "active" &&
                ((currentUser.role || "user") === "admin" || (currentUser.role || "user") === "user")
            );
        }

    function updateUserChip() {
        const t = document.getElementById("userChipText");
        if (!t) return;
        if (currentUser?.username) {
            t.textContent = currentUser.username + (currentUser.role === "admin" ? " (A)" : "");
        } else {
            t.textContent = "GiriÅŸ";
        }
    }
    // ðŸ”’ App lock/unlock (minimum fix)
        let __appLocked = false;

    function setAppLocked(locked) {
            document.body.classList.toggle("is-locked", !!locked);

            const app = document.querySelector(".app");
            if (!app) return;

            app.style.pointerEvents = locked ? "none" : "";
        }

    function requireLoginOrOpenAuth() {
            // giriÅŸ varsa devam
            if (currentUser?.username && currentUser.status !== "passive") return true;

            // giriÅŸ yoksa auth aÃ§
            openAuth();
            return false;
        }

    function initAuthUI() {
        // backdrop / X
        document.getElementById("authBg")?.addEventListener("click", closeAuth);
        document.getElementById("authX")?.addEventListener("click", closeAuth);

    
        
// show/hide password (yeni: gÃ¶z butonu, eski: switch)
const _pw = document.getElementById("loginPass");
const _btnShow = document.getElementById("btnShowLogin");
const _chkShow = document.getElementById("loginShowPw");

if (_btnShow && _pw) {
    _btnShow.addEventListener("click", () => {
        _pw.type = (_pw.type === "password") ? "text" : "password";
        _pw.focus({ preventScroll: true });
    });
} else if (_chkShow) {
    _chkShow.addEventListener("change", (e) => {
        const inp = document.getElementById("loginPass");
        if (inp) inp.type = e.target.checked ? "text" : "password";
    });
}

 // Signup ÅŸifre gÃ¶ster/gizle (opsiyonel)
const _btnShowSign = document.getElementById("btnShowSign");
const _sp = document.getElementById("signPass");
if (_btnShowSign && _sp) {
    _btnShowSign.addEventListener("click", () => {
        _sp.type = (_sp.type === "password") ? "text" : "password";
        _sp.focus({ preventScroll: true });
    });
}

 // Tabs (LoginNew) varsa onu kullan, yoksa checkboxâ€™Ä± kullan (geriye uyumlu)
const tabLogin = document.getElementById("tabLogin");
const tabSignup = document.getElementById("tabSignup");
const loginBox = document.getElementById("authLoginBox");
const signupBox = document.getElementById("authSignupBox");

function setAuthTab(which) {
    const isLogin = which === "login";
    if (tabLogin && tabSignup) {
        tabLogin.classList.toggle("active", isLogin);
        tabSignup.classList.toggle("active", !isLogin);
        tabLogin.setAttribute("aria-selected", String(isLogin));
        tabSignup.setAttribute("aria-selected", String(!isLogin));
    }
    if (loginBox) loginBox.style.display = isLogin ? "grid" : "none";
    if (signupBox) signupBox.style.display = isLogin ? "none" : "grid";
    setAuthMsg("", 1); setAuthMsg("", 2);
}

if (tabLogin && tabSignup) {
    tabLogin.addEventListener("click", () => setAuthTab("login"));
    tabSignup.addEventListener("click", () => setAuthTab("signup"));
    document.getElementById("btnBackLogin")?.addEventListener("click", () => setAuthTab("login"));
    setAuthTab("login");
} else {
    // Ãœye ol checkbox => signup aÃ§ (eski UI)
    document.getElementById("goSignup")?.addEventListener("change", (e) => {
        const on = !!e.target.checked;
        document.getElementById("authLoginBox").style.display = on ? "none" : "grid";
        document.getElementById("authSignupBox").style.display = on ? "grid" : "none";
        setAuthMsg("", 1); setAuthMsg("", 2);
    });

    document.getElementById("btnBackLogin")?.addEventListener("click", () => {
        const c = document.getElementById("goSignup");
        if (c) c.checked = false;
        document.getElementById("authLoginBox").style.display = "grid";
        document.getElementById("authSignupBox").style.display = "none";
        setAuthMsg("", 1); setAuthMsg("", 2);
    });
}

// Login

        // TR uyumlu normalize: Ä°/i/Ä±/I sorunlarÄ±nÄ± azaltÄ±r + boÅŸluklarÄ± temizler
        function normUser(s) {
            return (s || "")
                .trim()
                .toUpperCase()
                .replaceAll("Ä°", "I")
                .replaceAll("Ä±", "I");
        }

        document.getElementById("btnDoLogin")?.addEventListener("click", async () => {
            const btn = document.getElementById("btnDoLogin");
            const btnTxt = btn?.querySelector(".txt");

            const setBtnLoading = (on, text) => {
                if (!btn) return;
                btn.classList.toggle("loading", !!on);
                btn.disabled = !!on;

                // .txt varsa onu yaz
                if (btnTxt) btnTxt.textContent = text || (on ? "Kontrol ediliyor..." : "GiriÅŸ Yap");
                else btn.textContent = text || (on ? "Kontrol ediliyor..." : "GiriÅŸ Yap");
                };


            // BaÅŸta kullanÄ±cÄ±ya hÄ±zlÄ± feedback ver
            setBtnLoading(true, "Kontrol ediliyor...");

            // 250ms sonra hÃ¢lÃ¢ devam ediyorsa â€œSunucuya baÄŸlanÄ±lÄ±yorâ€¦â€ yazsÄ±n
            const loadingDelay = setTimeout(() => {
                setBtnLoading(true, "Oturum aÃ§Ä±lÄ±yor...");
                setAuthMsg("Oturum aÃ§Ä±lÄ±yorâ€¦", 0);
            }, 250);

            let loginOk = false;

            try {
                const uRaw = document.getElementById("loginUser")?.value || "";
                const p = (document.getElementById("loginPass")?.value || "").trim();
                const u = normUser(uRaw);

                // 1) boÅŸ kontrol
                if (!u || !p) {
                    setAuthMsg("KullanÄ±cÄ± adÄ± ve ÅŸifre gerekli.", 1);
                    return;
                }

                // 2) Google URL kontrol
                if (typeof GS_URL === "undefined" || !String(GS_URL).trim() || String(GS_URL).trim().length < 20) {
                    setAuthMsg("Google baÄŸlantÄ±sÄ± tanÄ±mlÄ± deÄŸil. (GS_URL yok)", 1);
                    return;
                }


                // 3) Googleâ€™dan kullanÄ±cÄ±larÄ± Ã§ek
                const ok = await syncUsersFromSheet({ silent: true }).catch(() => false);
                if (!ok) {
                    setAuthMsg("Googleâ€™a baÄŸlanÄ±lamadÄ±. Ä°nternet/URL kontrol et.", 1);
                    return;
                }

                // 4) Cacheâ€™ten oku ve kullanÄ±cÄ±yÄ± bul
                const users = loadUsers() || [];
                const found = users.find(x => normUser(x.username) === u);

                if (!found) {
                    setAuthMsg("Bu kullanÄ±cÄ± tanÄ±mlÄ± deÄŸil.", 1);
                    return;
                }

                // 5) status kontrol (TEK YER)
                const st = String(found.status || "pending"); // active | passive | pending
                if (st !== "active") {
                    const msg = (st === "passive")
                        ? "HesabÄ±nÄ±z pasife alÄ±nmÄ±ÅŸtÄ±r. LÃ¼tfen admin ile gÃ¶rÃ¼ÅŸÃ¼nÃ¼z."
                        : "HesabÄ±nÄ±z onay bekliyor. Admin onayÄ± olmadan giriÅŸ yapÄ±lamaz.";

                    setAuthMsg(msg, 1);
                    uiOpen({
                        title: (st === "passive") ? "Hesap Pasif" : "Onay Bekliyor",
                        subtitle: found.username,
                        body: msg,
                        okText: "Tamam",
                        showCancel: false
                    });
                    return;
                }

                // 6) ÅŸifre kontrol
                if (String(found.pass || "") !== String(p)) {
                    setAuthMsg("Åžifre hatalÄ±.", 1);
                    nudgeAdminResetLink();

                    return;
                }

                // âœ… BAÅžARI NOKTASI (loginOk burada TRUE olmalÄ±)
                loginOk = true;

                currentUser = { username: found.username, role: found.role, status: "active" };
                setSession(currentUser);
                updateUserChip();

                setBtnLoading(true, "Oturum aÃ§Ä±lÄ±yor...");
                setAuthMsg("Oturum aÃ§Ä±lÄ±yorâ€¦", 0);

                // settingsâ€™i sadece 1 kez Ã§ek
                await syncSettingsFromSheet({ silent: true });
                setBtnLoading(true, "BaÄŸlandÄ± âœ…");
                setAuthMsg("GiriÅŸ baÅŸarÄ±lÄ± âœ…", 1);
                applyPermissions();
                

                // admin deÄŸilse Ayarlar nav gizle
                const navAyar = document.querySelector('.nav-item[data-page="ayarlar"]');
                if (navAyar) navAyar.style.display = isAdminActive() ? "" : "none";

                setAppLocked(false);
                startAutoRefresh();
                startIdleTimer();

                setTimeout(closeAuth, 250);
                
            } finally {
  clearTimeout(loadingDelay);

  if (!loginOk) {
    // baÅŸarÄ±sÄ±zsa butonu normale dÃ¶ndÃ¼r
    setBtnLoading(false, "GiriÅŸ Yap");
  } else {
    // baÅŸarÄ±lÄ±ysa "BaÄŸlandÄ± âœ“" zaten gÃ¶rÃ¼nsÃ¼n, modal kapanacak
    // burada hiÃ§bir ÅŸey yapma
  }
}

        });


        // âœ… Enter'a basÄ±nca login yap (PC + mobil klavye "Go/Done")
        ["loginUser", "loginPass"].forEach(id => {
            document.getElementById(id)?.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    document.getElementById("btnDoLogin")?.click();
                }
            });
        });

        // Signup (herkes user)
        document.getElementById("btnDoSignup")?.addEventListener("click", () => {
            const u = (document.getElementById("signUser")?.value || "").trim();
            const p1 = (document.getElementById("signPass")?.value || "").trim();
            const p2 = (document.getElementById("signPass2")?.value || "").trim();

            if (!u || !p1 || !p2) { setAuthMsg("TÃ¼m alanlarÄ± doldur.", 2); return; }
            if (p1 !== p2) { setAuthMsg("Åžifreler aynÄ± deÄŸil.", 2); return; }
            if (u.length < 3) { setAuthMsg("KullanÄ±cÄ± adÄ± en az 3 karakter olsun.", 2); return; }

            const users = loadUsers();
            const exists = users.some(x => x.username.toLowerCase() === u.toLowerCase());
            if (exists) { setAuthMsg("Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.", 2); return; }

            const newUser = {
                id: Date.now(),
                username: u,
                pass: p1,
                role: "user",          // ðŸ”’ herkes user
                status: "pending",     // â³ herkes onay bekler
                createdAt: Date.now()
            };


            users.push(newUser);
            saveUsers(users);

            // âœ… Google Sheet'e de yaz
            addUserToSheet(newUser);

            saveUsers(users);
            
            setAuthMsg("Ãœyelik alÄ±ndÄ± âœ… (Admin onayÄ± bekliyor)", 2);

        });

        updateUserChip();
    }
    
    function toggleAccountMenu(force) {
        const m = document.getElementById("accountMenu");
        if (!m) return;

        if (typeof force === "boolean") {
            m.classList.toggle("hidden", !force);
        } else {
            m.classList.toggle("hidden"); // toggle
        }
    }

    document.getElementById("btnAccount").onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();

        // giriÅŸ yoksa login aÃ§
        if (!currentUser?.username) {
            
            openAuth();
            

            return;
        }

        // giriÅŸ varsa menÃ¼yÃ¼ aÃ§/kapat
        toggleAccountMenu();
    };

    document.getElementById("btnLogout").onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
              doLogoutConfirm();

        toggleAccountMenu(false); // logoutâ€™a basÄ±nca menÃ¼ kapansÄ±n

            uiConfirm({
                title: "Ã‡Ä±kÄ±ÅŸ YapÄ±lsÄ±n mÄ±?",
                body: "Oturum kapatÄ±lacak.",
                okText: "Ã‡Ä±kÄ±ÅŸ Yap",
                cancelText: "VazgeÃ§",
                onOk: () => {
                    clearSession();
                    currentUser = null;
                    location.reload();
                    applyPermissions();
                    stopIdleTimer();

                }
            });
        };

    // dÄ±ÅŸarÄ± tÄ±klayÄ±nca menÃ¼yÃ¼ kapat
    document.addEventListener("click", () => toggleAccountMenu(false));


        /* ================== NAV + SAYFA GEÃ‡Ä°ÅžÄ° ================== */
    function renderProfile() {
            const u = currentUser || {};
            const username = u.username || "-";
            const role = u.role || "-";
            const status = u.status || "-";

            document.getElementById("profUsername").textContent = username;
            document.getElementById("profRole").textContent = role === "admin" ? "Admin" : "KullanÄ±cÄ±";
            document.getElementById("profStatus").textContent =
                status === "active" ? "Aktif" : (status === "pending" ? "Onay Bekliyor" : "Pasif");

            // admin ise tabloyu Ã§iz
            if (isAdminActive()) renderUsersTable();
        }
        function badgeClass(status) {
                status = status || "pending";
                return status === "active" ? "active" : (status === "passive" ? "passive" : "pending");
            }
    function renderUsersTable() {
            if (!isAdminActive()) return;

            const users = loadUsers();

            const tbody = document.getElementById("usersTbody");
            document.getElementById("passiveTbody")?.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-act]");
            if (!btn) return;
            if (!isAdminActive()) return;

            const act = btn.dataset.act;
            const username = btn.dataset.user;

            const users = loadUsers();
            const u = users.find(x => x.username === username);
            if (!u) return;

            if (act === "activate") u.status = "active";
            setUserStatusOnSheet(username, "active")
                    .then(() => syncUsersFromSheet({ silent: true }))
                    .catch(console.warn);


            saveUsers(users);
            renderUsersTable();
        });

            const info = document.getElementById("usersInfo");

            const passiveTbody = document.getElementById("passiveTbody");
            const passiveInfo = document.getElementById("passiveInfo");

            if (!tbody) return;

            tbody.innerHTML = "";
            if (passiveTbody) passiveTbody.innerHTML = "";

            const pendingCount = users.filter(u => (u.status || "pending") === "pending").length;
            const passiveCount = users.filter(u => (u.status || "pending") === "passive").length;

            if (info) info.textContent = `Toplam: ${users.length} â€¢ Bekleyen: ${pendingCount}`;
            if (passiveInfo) passiveInfo.textContent = `${passiveCount}`;

            // 1) Ana tablo: passive OLMAYANLAR (active + pending)
            const mainUsers = users.filter(u => (u.status || "pending") !== "passive");

            mainUsers.forEach(u => {
                const username = u.username || "";
                const roleText = (u.role || "user") === "admin" ? "Admin" : "KullanÄ±cÄ±";
                const status = u.status || "pending";

                const tr = document.createElement("tr");
                tr.innerHTML = `
  <td data-label="KullanÄ±cÄ±" class="u-td">
    <button type="button" class="user-link" data-act="pw" data-user="${username}">${username}</button>
  </td>

  <td data-label="Rol" class="u-td">${roleText}</td>

  <td data-label="Durum" class="u-td">
    <span class="badge ${badgeClass(status)}">${statusLabel(status)}</span>
  </td>

  <td data-label="Ä°ÅŸlem" class="u-td">
    <div class="u-actions">
      ${(status === "pending")
                        ? `<button class="btn btn-ok" data-act="approve" data-user="${username}">Onayla</button>`
                        : ``}
      ${(roleText === "Admin")
                        ? ``
                        : `<button class="mini-btn" data-act="passive" data-user="${username}">Pasif Yap</button>`}
    </div>
  </td>
`;

                tbody.appendChild(tr);
            });

            // 2) Pasif tablo: sadece passive olanlar
            const passives = users.filter(u => (u.status || "pending") === "passive");

            passives.forEach(u => {
                const username = u.username || "";
                const roleText = (u.role || "user") === "admin" ? "Admin" : "KullanÄ±cÄ±";
                const status = u.status || "passive";

                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td data-label="KullanÄ±cÄ±" class="u-td u-name">${username}</td>
            <td data-label="Rol" class="u-td">${roleText}</td>
            <td data-label="Durum" class="u-td">
                <span class="badge ${badgeClass(status)}">${statusLabel(status)}</span>
            </td>
            <td data-label="Ä°ÅŸlem" class="u-td">
                <div class="u-actions">
                <button class="btn btn-ok" data-act="activate" data-user="${username}">Aktif Yap</button>
                </div>
            </td>
            `;

                passiveTbody?.appendChild(tr);
            });
        }
    function renderPassiveUsers() {
        if (!isAdminActive()) return;

        const users = loadUsers();
        const passives = users.filter(u => (u.status || "pending") === "passive");

        const passiveInfo = document.getElementById("passiveInfo");
        const passiveTbody = document.getElementById("passiveTbody");

        if (passiveInfo) passiveInfo.textContent = String(passives.length);
        if (!passiveTbody) return;

        passiveTbody.innerHTML = "";

        passives.forEach(u => {
            const username = u.username || "";
            const roleText = (u.role || "user") === "admin" ? "Admin" : "KullanÄ±cÄ±";

            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td style="padding:10px; font-weight:700;">${username}</td>
      <td style="padding:10px;">${roleText}</td>
      <td style="padding:10px;"><span class="badge ${badgeClass("passive")}">${statusLabel("passive")}</span></td>
      <td style="padding:10px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-ok" data-act="activate" data-user="${username}">Aktif Yap</button>
        </div>
      </td>
    `;
            passiveTbody.appendChild(tr);
        });
    }
    document.getElementById("btnPassiveRefresh")?.addEventListener("click", () => {
        renderPassiveUsers();
    });

    document.getElementById("passiveTbody")?.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        if (!isAdminActive()) return;

        const act = btn.dataset.act;
        const username = btn.dataset.user;

        if (act !== "activate") return;

        const users = loadUsers();
        const u = users.find(x => x.username === username);
        if (!u) return;

        u.status = "active";
        setUserStatusOnSheet(username, "active")
            .then(() => syncUsersFromSheet({ silent: true }))
            .catch(console.warn);

        saveUsers(users);

        renderPassiveUsers();
        if (typeof renderUsersTable === "function") renderUsersTable(); // kullanÄ±cÄ± yÃ¶netimini de gÃ¼ncellesin
    });

    // Profil > KullanÄ±cÄ± YÃ¶netimi sayfasÄ±na geÃ§
        document.getElementById("btnGoUsersPage")?.addEventListener("click", () => {
                if (!isAdminActive()) return;
                showPage("users");
                if (typeof renderUsersTable === "function") renderUsersTable();
            });

            document.getElementById("btnGoPassivePage")?.addEventListener("click", () => {
                if (!isAdminActive()) return;
                showPage("passive");
                if (typeof renderPassiveUsers === "function") renderPassiveUsers();
            });

        // KullanÄ±cÄ± YÃ¶netimi > Profile dÃ¶n
        document.getElementById("btnUsersBack")?.addEventListener("click", () => {
            showPage("profil");
        });

        // Yenile butonu
        document.getElementById("btnUsersRefresh")?.addEventListener("click", () => {
            renderUsersTable();
        });


            function statusLabel(status) {
                status = status || "pending";
                return status === "active" ? "Aktif" : (status === "passive" ? "Pasif" : "Onay Bekliyor");
            }

    document.getElementById("usersTbody")?.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        if (!isAdminActive()) return;

        const act = btn.dataset.act;
        const username = btn.dataset.user;

        const users = loadUsers();
        const u = users.find(x => x.username === username);
        if (!u) return;

        // admin kendi hesabÄ±nÄ± pasif yapamasÄ±n
        if (currentUser?.username === username && act === "passive") {
            uiOpen({
                title: "UyarÄ±",
                subtitle: "Kendi hesabÄ±nÄ± pasif yapamazsÄ±n",
                body: "Admin hesabÄ± pasife Ã§ekilemez.",
                okText: "Tamam",
                showCancel: false
            });
            return;
        }

        // --- Åžifre deÄŸiÅŸtir (username'e tÄ±klayÄ±nca) ---
        if (act === "pw") {
            uiOpen({
                title: "Åžifre DeÄŸiÅŸtir",
                subtitle: `KullanÄ±cÄ±: ${username}`,
                body: `
        <div class="field" style="margin-top:6px;">
            <label>Yeni Åžifre</label>
            <input id="adminPwNew" type="password" placeholder="Yeni ÅŸifre">
        </div>
        <label style="display:flex;align-items:center;gap:8px;margin-top:10px;font-size:12px;color:rgba(156,163,175,.95);">
            <input id="adminPwShow" type="checkbox"> Åžifreyi gÃ¶ster
        </label>
        <div class="hint" style="margin-top:8px;">Not: Eski ÅŸifre gÃ¶sterilmez, admin yeni ÅŸifre atar.</div>
        `,
                okText: "Kaydet",
                cancelText: "VazgeÃ§",
                onOk: () => {
                    const newPass = (document.getElementById("adminPwNew")?.value || "").trim();
                    if (!newPass) { showToast?.("Åžifre boÅŸ olamaz", "error"); return; }

                    const users2 = loadUsers();
                    const uu = users2.find(x => x.username === username);
                    if (!uu) { showToast?.("KullanÄ±cÄ± bulunamadÄ±", "error"); return; }

                    uu.pass = newPass;          // yeni ÅŸifre set
                    saveUsers(users2);
                    setUserPasswordOnSheet(username, newPass)
                        .then(() => syncUsersFromSheet({ silent: true }))
                        .catch(console.warn);


                    showToast?.("Åžifre gÃ¼ncellendi âœ…", "success");
                    renderUsersTable();
                }
            });

            // show/hide
            setTimeout(() => {
                document.getElementById("adminPwShow")?.addEventListener("change", (ev) => {
                    const inp = document.getElementById("adminPwNew");
                    if (inp) inp.type = ev.target.checked ? "text" : "password";
                });
            }, 0);

            return;
        }

        let newStatus = u.status || "pending";
        if (act === "approve") newStatus = "active";
        if (act === "passive") newStatus = "passive";
        if (act === "activate") newStatus = "active";

        u.status = newStatus;

        // Ã¶nce cache'i gÃ¼ncelle
        saveUsers(users);
        renderUsersTable();

        // sonra Google'a yaz ve tekrar sync Ã§ek
        setUserStatusOnSheet(username, newStatus)
            .then(() => syncUsersFromSheet({ silent: true }))
            .then(() => renderUsersTable())
            .catch(console.warn);

    });


        // Dashboard parÃ§alarÄ± (ÅŸu an dashboard = summary-section + action-row)
        const dashboardParts = [
            document.querySelector(".summary-section"),
            document.querySelector(".action-row"),
        ];

        const pages = {
            dashboard: null,
            siparisler: document.getElementById("page-siparisler"),
            raporlar: document.getElementById("page-raporlar"),
            ayarlar: document.getElementById("page-ayarlar"),
            profil: document.getElementById("pageProfil"),
            users: document.getElementById("page-users"),
            passive: document.getElementById("page-passive"), 
        };
        
        initAuthUI();
    applyPermissions();

            // ilk aÃ§Ä±lÄ±ÅŸta giriÅŸ yoksa direkt aÃ§
            
            if (!currentUser) openAuth()
            
            
            
        function closeAllAccordions() {
            document.querySelectorAll('details.acc[open]').forEach(d => d.open = false);
        }

        function closeAllDropMenus() {
            document.querySelectorAll('.drop-menu.open').forEach(m => m.classList.remove('open'));
        }
        // âœ… Ayarlar: aynÄ± anda sadece 1 accordion aÃ§Ä±k kalsÄ±n
            let _accGlobalListenersBound = false;

                function setupExclusiveAccordions() {
                    const accs = Array.from(document.querySelectorAll("details.acc"));

                    accs.forEach(acc => {
                        acc.addEventListener("toggle", () => {
                            if (!acc.open) return;
                            accs.forEach(other => { if (other !== acc) other.open = false; });
                        });
                    });

                    if (!_accGlobalListenersBound) {
                        _accGlobalListenersBound = true;

                        document.addEventListener("click", (e) => {
                            const inside = e.target.closest?.("#accountMenu, #btnAccount");
                            if (!inside) toggleAccountMenu(false);
                        });

                        document.addEventListener("keydown", (e) => {
                            if (e.key === "Escape") toggleAccountMenu(false);
                        });
                    }
                }


            // sayfa ilk aÃ§Ä±lÄ±rken aktif et
            setupExclusiveAccordions();
    // âœ… Uygulama aÃ§Ä±lÄ±r aÃ§Ä±lmaz users'Ä± Ã§ek
                // âœ… Uygulama aÃ§Ä±lÄ±r aÃ§Ä±lmaz users'Ä± Ã§ek
    async function bootUsers() {
        // session varsa: Ã¶nce users'Ä± sheetâ€™ten Ã§ekip status/role doÄŸrula
        const s = getSession?.();
        if (s?.username) {
            // âœ… Google entegrasyonu yoksa bekletme
            if (typeof syncUsersFromSheet !== "function" || typeof gsPost !== "function") {
                setBtnLoading(false, "GiriÅŸ Yap");
                setAuthMsg("Google baÄŸlantÄ±sÄ± tanÄ±mlÄ± deÄŸil. (Apps Script URL yok)", 1);
                return;
            }

            await syncUsersFromSheet({ silent: true });

            const u = loadUsers().find(x => x.username === s.username);
            if (!u || (u.status || "pending") !== "active") {
                clearSession?.();
                currentUser = null;
                openAuth();
                setAuthMsg("HesabÄ±n aktif deÄŸil veya bulunamadÄ±");
                return;
            }

            currentUser = { username: u.username, role: u.role, status: u.status };
            setSession(currentUser);
            updateUserChip();
            // âœ… Session doÄŸrulandÄ± -> aÃ§Ä±lÄ±ÅŸta verileri de Google'dan sessiz Ã§ek
try { await syncSettingsFromSheet?.(); } catch (e) { console.warn(e); }
try { await syncOrdersFromSheet?.({ silent: true }); } catch (e) { console.warn(e); }

// (istersen) dashboard/raporlarÄ± tazele
renderSummary?.();
renderOrders?.();
if (typeof renderDebtTable === "function") renderDebtTable();

        } else {
            // session yoksa: Googleâ€™a gitme, direkt login ekranÄ±nÄ± aÃ§
            openAuth();
        }
    }


                    window.addEventListener("DOMContentLoaded", bootUsers);

    async function syncSettingsFromSheet(opts = { silent: false }) {
        try {
            const res = await gsPost({ action: "getSettings" });
            if (!res?.ok) throw new Error(res?.message || "getSettings baÅŸarÄ±sÄ±z");

            const s = res.data || {};
            settings = {
                priceDamacana: Number(s.priceDamacana || 0),
                pricePet05: Number(s.pricePet05 || 0),
                firmaAdi: String(s.firmaAdi || "").trim(),
                whatsapp: String(s.whatsapp || "").trim()
            };

            saveSettings(settings); // ortak config offline da dursun
            // Admin ayarlardaysa inputlara da bas
            document.getElementById("inpPriceDamacana") && (document.getElementById("inpPriceDamacana").value = settings.priceDamacana || "");
            document.getElementById("inpPricePet05") && (document.getElementById("inpPricePet05").value = settings.pricePet05 || "");
            document.getElementById("inpFirmaAdi") && (document.getElementById("inpFirmaAdi").value = settings.firmaAdi || "");
            document.getElementById("inpWhatsapp") && (document.getElementById("inpWhatsapp").value = settings.whatsapp || "");

            renderSummary?.();
            renderOrders?.();

            if (!opts.silent) showToast?.("Firma ayarlarÄ± gÃ¼ncellendi âœ…", "success");
            return true;
        } catch (e) {
            console.warn("syncSettingsFromSheet", e);
            if (!opts.silent) showToast?.("Firma ayarlarÄ± Ã§ekilemedi", "error");
            return false;
        }
    }

        function showPage(key) {
        // âœ… giriÅŸ yoksa uygulamayÄ± kilitle
            if (!requireLoginOrOpenAuth()) return;
            // âœ… Ayarlar admin-only
            if (key === "ayarlar" && !isAdminActive()) {
                uiOpen({
                    title: "Yetki Yok â›”",
                    subtitle: "Ayarlar sadece admin",
                    body: "Bu sayfaya sadece admin girebilir.",
                    okText: "Tamam",
                    showCancel: false
                });
                key = "dashboard"; // geri gÃ¶nder
            }

            closeAllAccordions();
            closeAllDropMenus();
            window.currentPage = key;

            // nav active
            document.querySelectorAll(".nav-item").forEach(b => b.classList.remove("active"));
            document.querySelector(`.nav-item[data-page="${key}"]`)?.classList.add("active");

            // dashboard gÃ¶ster/gizle
            const showDash = (key === "dashboard");
            dashboardParts.forEach(el => { if (el) el.style.display = showDash ? "" : "none"; });

            // diÄŸer sayfalar
            Object.keys(pages).forEach(k => {
                if (k === "dashboard") return;
                const el = pages[k];
                if (!el) return;
                el.classList.toggle("hidden", k !== key);
            });

            if (key === "raporlar") renderReports();
            // âœ… Raporlar hariÃ§ sayfalarda yukarÄ±-aÅŸaÄŸÄ± kaydÄ±rmayÄ± kapat
            document.body.style.overflowY = (key === "raporlar") ? "auto" : "hidden";
            document.body.style.overscrollBehaviorY = "none";

            renderBugunTarih();

        }
        
// ===== AUTO REFRESH (admin + sadece Ã¶n planda) =====
let autoRefreshTimer = null;

// istersen sÃ¼reyi buradan yÃ¶net
const AUTO_REFRESH_MS = 180* 1000; // 1 dk (senin yorumun bu)
 // ÅžU AN 15*1000 yazmÄ±ÅŸsÄ±n; 1 dk istiyorsan bunu kullanacaÄŸÄ±z.

function startAutoRefresh() {


  stopAutoRefresh();

  autoRefreshTimer = setInterval(async () => {
    // âœ… login yoksa Ã§alÄ±ÅŸmasÄ±n
    if (!currentUser?.username) return;

    // âœ… sadece admin Ã§alÄ±ÅŸsÄ±n (user internet yemesin)
    if (!isAdminActive?.()) return;

    // âœ… sekme gÃ¶rÃ¼nmezse / homeâ€™a basÄ±ldÄ±ysa Ã§alÄ±ÅŸmasÄ±n
    if (document.hidden) return;

    // âœ… (opsiyonel) login ekranÄ±ndaysa zaten Ã§alÄ±ÅŸmasÄ±n
    if (document.body.classList.contains("is-locked")) return;

    try {
      await syncOrdersFromSheet?.();
      setOrdersLastSync?.(new Date());

      await syncPaymentsFromSheet?.();
      setPayLastSync?.(new Date());

      // UI gÃ¼ncelle
      renderOrders?.();
      renderSummary?.();
      if (typeof renderDebtTable === "function") renderDebtTable();
      renderPayHistory?.();

    } catch (e) {
      console.warn("AUTO REFRESH FAIL:", e);
    }
  }, AUTO_REFRESH_MS);
}
// ===== BACKGROUND PAUSE / RESUME =====
function pauseBackgroundWork(){
  stopAutoRefresh();
}

function resumeForegroundWork(){
  // login varsa ve adminse tekrar baÅŸlat
  if (!currentUser?.username) return;
  if (document.body.classList.contains("is-locked")) return;

  startAutoRefresh();
}

document.addEventListener("visibilitychange", () => {
  if (document.hidden) pauseBackgroundWork();
  else resumeForegroundWork();
});

// mobilde ekstra garanti
window.addEventListener("pagehide", pauseBackgroundWork);
window.addEventListener("focus", resumeForegroundWork);

function stopAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = null;
}


        document.querySelectorAll(".nav-item").forEach(btn => {
            btn.addEventListener("click", () => {
                const key = btn.dataset.page;

                if (!pages[key] && key !== "dashboard") {
                    showPage("dashboard");
                    return;
                }
                
                showPage(key);

                if (key === "profil") {
                    renderProfile();
                }

            });
        });

        // ilk aÃ§Ä±lÄ±ÅŸ
        
        showPage("dashboard");
        renderBugunTarih();
        renderProfile()

        /* ================== AYARLAR (localStorage) ================== */
        const SETTINGS_KEY = "suSiparis_settings_v1";
        /* ================== SÄ°PARÄ°Åž SÄ°STEMÄ° ================== */
        const ORDERS_KEY = "suSiparis_orders_v1";
        /* ================== Ã–DEME GEÃ‡MÄ°ÅžÄ° ================== */
        const PAYMENTS_KEY = "suSiparis_payments_v1";
        /* ================== YEDEKLEME (JSON Export/Import) ================== */
        const BACKUP_FILE_NAME = "su_siparis_backup.json";
        const BACKUP_VERSION = 1;


        function buildBackupObject() {
            return {
                version: BACKUP_VERSION,
                exportedAt: new Date().toISOString(),
                app: "su_siparis_takip",
                settings: loadSettings(),
                orders: loadOrders(),
                payments: loadPayments()
            };
        }
        /* ================== OTOMATÄ°K KAYIT DOSYASI (HANDLE) ================== */
        const BACKUP_HANDLE_DB = "suSiparisBackupDB_v1";
        const BACKUP_HANDLE_STORE = "handles";
        const BACKUP_HANDLE_KEY = "yedekFileHandle";
        const AUTO_BACKUP_LAST_OK_KEY = "autoBackupLastOkDate";

        function idbOpenBackup() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(BACKUP_HANDLE_DB, 1);
                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(BACKUP_HANDLE_STORE)) {
                        db.createObjectStore(BACKUP_HANDLE_STORE);
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function autoRefreshOrders() {
            console.log("â±ï¸ AUTO ORDERS REFRESH", new Date().toLocaleTimeString());

                await syncOrdersFromSheet();
                setOrdersLastSync(new Date());
            }

            async function autoRefreshPayments() {
                console.log("â±ï¸ AUTO PAYMENTS REFRESH", new Date().toLocaleTimeString());

                await syncPaymentsFromSheet();
                setPayLastSync(new Date());
            }

        async function idbSetBackup(key, value) {
            const db = await idbOpenBackup();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(BACKUP_HANDLE_STORE, "readwrite");
                tx.objectStore(BACKUP_HANDLE_STORE).put(value, key);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => reject(tx.error);
            });
        }

        async function idbGetBackup(key) {
            const db = await idbOpenBackup();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(BACKUP_HANDLE_STORE, "readonly");
                const req = tx.objectStore(BACKUP_HANDLE_STORE).get(key);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => reject(req.error);
            });
        }

        async function idbDelBackup(key) {
            const db = await idbOpenBackup();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(BACKUP_HANDLE_STORE, "readwrite");
                tx.objectStore(BACKUP_HANDLE_STORE).delete(key);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => reject(tx.error);
            });
        }

        async function pickBackupFileOnce() {
            if (!window.showSaveFilePicker) {
                uiOpen({
                    title: "Desteklenmiyor",
                    subtitle: "Bu tarayÄ±cÄ±/ortam tek dosyaya yazmayÄ± desteklemiyor.",
                    body: "Ã‡Ã¶zÃ¼m: Chrome/Edge ile aÃ§ ve tekrar dene. Destek yoksa sadece indirme yÃ¶ntemi Ã§alÄ±ÅŸÄ±r.",
                    okText: "Tamam",
                    showCancel: false
                });
                return;
            }

            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: "su_siparis_yedek.json",
                    types: [{ description: "JSON", accept: { "application/json": [".json"] } }],
                });

                await idbSetBackup(BACKUP_HANDLE_KEY, handle);
                showToast("Yedek dosyasÄ± seÃ§ildi âœ… ArtÄ±k aynÄ± dosyanÄ±n Ã¼stÃ¼ne yazÄ±lacak.", "success");
                await updateBackupFileStatus();
            } catch (e) {
                // iptal edilirse sessiz geÃ§
                console.warn("Dosya seÃ§imi iptal/baÅŸarÄ±sÄ±z:", e);
            }
        }

        async function writeBackupToPickedFile(jsonText) {
            const handle = await idbGetBackup(BACKUP_HANDLE_KEY);
            if (!handle) return false;

            try {
                // bazÄ± cihazlarda izin tekrar isteyebilir
                if (handle.requestPermission) {
                    const p = await handle.requestPermission({ mode: "readwrite" });
                    if (p !== "granted") return false;
                }

                const writable = await handle.createWritable();
                await writable.write(jsonText);
                await writable.close();
                localStorage.setItem(AUTO_BACKUP_LAST_OK_KEY, new Date().toISOString());
                return true;
                updateAutoBackupDot();

            } catch (e) {
                console.warn("SeÃ§ili dosyaya yazÄ±lamadÄ±:", e);
                return false;
            }
        }

        async function updateBackupFileStatus() {
            const el = document.getElementById("backupFileStatus");
            if (!el) return;
            const handle = await idbGetBackup(BACKUP_HANDLE_KEY);
            if (!handle) {
                el.textContent = "Dosya seÃ§ilmedi.";
                return;
            }
            // name her ortamda yok, o yÃ¼zden garanti metin:
            el.textContent = "SeÃ§ili âœ… GÃ¼nlÃ¼k otomatik yedek bu dosyanÄ±n Ã¼stÃ¼ne yazar.";
        }



        async function downloadBackupJson() {
            const dataObj = buildBackupObject();
            const json = JSON.stringify(dataObj, null, 2);
            // âœ… 0) EÄŸer Ayarlardan dosya seÃ§ildiyse, aynÄ± dosyanÄ±n Ã¼stÃ¼ne yaz
            const ok = await writeBackupToPickedFile(json);
            if (ok) {
                showToast("Yedek seÃ§ili dosyaya yazÄ±ldÄ± âœ…", "success");
                return;
            }


            // 1) File System Access API varsa: aynÄ± dosyanÄ±n Ã¼stÃ¼ne yazma ÅŸansÄ± (en iyi Ã§Ã¶zÃ¼m)
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: BACKUP_FILE_NAME,
                        types: [{
                            description: "JSON",
                            accept: { "application/json": [".json"] }
                        }]
                    });

                    const writable = await handle.createWritable();
                    await writable.write(json);
                    await writable.close();

                    uiOpen({
                        title: "Yedek AlÄ±ndÄ± âœ…",
                        subtitle: "Dosyaya kaydedildi",
                        body: `Dosya: ${BACKUP_FILE_NAME}\nTarih: ${new Date().toLocaleString("tr-TR")}`,
                        okText: "Tamam",
                        showCancel: false
                    });
                    showToast("Yedek indirildi âœ…", "success")
                    return;
                } catch (err) {
                    // kullanÄ±cÄ± vazgeÃ§tiyse sessiz geÃ§ebiliriz
                    if (String(err).includes("AbortError")) return;
                    // hata olduysa aÅŸaÄŸÄ±daki klasik indirmeye dÃ¼ÅŸ
                    console.warn("showSaveFilePicker hata, klasik indirmeye dÃ¼ÅŸÃ¼ldÃ¼:", err);
                }
            }

            // 2) Klasik indirme (bazÄ± cihazlarda aynÄ± isimle (1) ekleyebilir)
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = BACKUP_FILE_NAME;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1200);

            uiOpen({
                title: "Yedek Ä°ndirildi âœ…",
                subtitle: "Ä°ndirilenler klasÃ¶rÃ¼nÃ¼ kontrol et",
                body: `Dosya: ${BACKUP_FILE_NAME}\nNot: BazÄ± telefonlar aynÄ± isimde (1) ekleyebilir.`,
                okText: "Tamam",
                showCancel: false
            });
        }

        function applyBackupObject(obj) {
            if (!obj || typeof obj !== "object") throw new Error("GeÃ§ersiz JSON");

            const ver = Number(obj.version || 0);
            if (!ver) throw new Error("Yedek sÃ¼rÃ¼mÃ¼ bulunamadÄ±");

            const newSettings = obj.settings || {};
            const newOrders = Array.isArray(obj.orders) ? obj.orders : [];
            const newPayments = Array.isArray(obj.payments) ? obj.payments : [];

            // localStorageâ€™a bas
            saveSettings({
                priceDamacana: Number(newSettings.priceDamacana || 0),
                pricePet05: Number(newSettings.pricePet05 || 0),
                whatsapp: String(newSettings.whatsapp || "90"),
                firmaAdi: String(newSettings.firmaAdi || "ABDULLAH Ã–ZER")
            });
            saveOrders(newOrders);
            savePayments(newPayments);

            // RAM deÄŸiÅŸkenlerini de gÃ¼ncelle
            settings = loadSettings();
            orders = loadOrders();
            payments = loadPayments();

            // UI yenile
            renderSettings?.();
            renderOrders?.();
            renderSummary?.();
            if (typeof renderDebtTable === "function") renderDebtTable();
            if (typeof renderPayHistory === "function") renderPayHistory();
            if (typeof recomputePaidFromPayments === "function") recomputePaidFromPayments();
        }

        function importBackupFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const text = String(reader.result || "");
                        const obj = JSON.parse(text);
                        applyBackupObject(obj);
                        resolve(true);
                    } catch (e) {
                        reject(e);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        /* ================== GÃœNLÃœK OTOMATÄ°K YEDEK ================== */
        const AUTO_BACKUP_ASKED_KEY = "autoBackupAsked_v1";
        const AUTO_BACKUP_ENABLED_KEY = "autoBackupEnabled_v1"; // "1" aÃ§Ä±k
        const AUTO_BACKUP_LAST_YMD_KEY = "autoBackupLastYmd_v1";
        const AUTO_BACKUP_LAST_OK_AT_KEY = "autoBackupLastOkAt_v1"; // son baÅŸarÄ±lÄ± yedek zamanÄ±


        function ymdNow() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${day}`;
        }
        function updateLastBackupInfoUI() {
            const el = document.getElementById("backupLastInfo");
            if (!el) return;

            const iso = localStorage.getItem(AUTO_BACKUP_LAST_OK_AT_KEY);
            if (!iso) {
                el.textContent = "Son yedek: --";
                return;
            }

            const d = new Date(iso);
            el.textContent = `Son yedek: ${d.toLocaleString("tr-TR")}`;
        }


        function isAutoBackupEnabled() {
            return localStorage.getItem(AUTO_BACKUP_ENABLED_KEY) === "1";
        }

        // âœ… btnAccount'a daha Ã¶nce baÄŸlanan TÃœM event'leri sÄ±fÄ±rla ve yeniden baÄŸla
            (function rebindAccountChipFresh() {
                const oldBtn = document.getElementById("btnAccount");
                if (!oldBtn) return;

                // Butonu clone'la -> tÃ¼m eski listener'lar gider
                const newBtn = oldBtn.cloneNode(true);
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);

                // MenÃ¼ aÃ§/kapat yardÄ±mcÄ±
                function showAccountMenu(show) {
                    const m = document.getElementById("accountMenu");
                    if (!m) return;
                    m.classList.toggle("hidden", show === false ? true : (show === true ? false : m.classList.contains("hidden") ? false : true));
                }

                // Chip tÄ±klanÄ±nca: giriÅŸ yoksa login, varsa menÃ¼
                newBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!currentUser?.username) {
                        openAuth();
                        return;
                    }
                    // toggle
                    const m = document.getElementById("accountMenu");
                    if (!m) return;
                    m.classList.toggle("hidden");
                });

                // DÄ±ÅŸarÄ± tÄ±klayÄ±nca menÃ¼yÃ¼ kapat
                document.addEventListener("click", (e) => {
                    const menu = document.getElementById("accountMenu");
                    const btn = document.getElementById("btnAccount");

                    // MenÃ¼ veya buton iÃ§indeyse KAPATMA
                    if (menu && (menu.contains(e.target) || btn.contains(e.target))) return;

                    if (menu) menu.classList.add("hidden");
                });

            })();


        /* Buton baÄŸla */
        /* ================== Yedekleme MenÃ¼leri (JSON / EXCEL) ================== */
        function toggleMenu(menuId) {
            const el = document.getElementById(menuId);
            if (!el) return;
            // diÄŸer menÃ¼leri kapat
            ["menuJson", "menuExcel"].forEach(id => {
                if (id !== menuId) document.getElementById(id)?.classList.remove("open");
            });
            el.classList.toggle("open");
        }

        // dÄ±ÅŸarÄ± tÄ±klayÄ±nca menÃ¼ kapansÄ±n
        document.addEventListener("click", (e) => {
            const t = e.target;
            const insideDrop = t?.closest?.(".drop");
            if (!insideDrop) {
                document.getElementById("menuJson")?.classList.remove("open");
                document.getElementById("menuExcel")?.classList.remove("open");

            }
        });

        // MenÃ¼ aÃ§/kapat
        document.getElementById("btnDropJson")?.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu("menuJson");
        });
        document.getElementById("btnDropExcel")?.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu("menuExcel");
        });

        /* ---------- JSON Export/Import ---------- */
        document.getElementById("btnJsonExport")?.addEventListener("click", () => {
            document.getElementById("menuJson")?.classList.remove("open");
            downloadBackupJson();
        });

        document.getElementById("btnJsonImport")?.addEventListener("click", () => {
            document.getElementById("menuJson")?.classList.remove("open");
            document.getElementById("backupFileJson")?.click();
        });

        document.getElementById("backupFileJson")?.addEventListener("change", async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            try {
                await importBackupFromFile(file);
                uiOpen({
                    title: "Yedek YÃ¼klendi âœ…",
                    subtitle: "Veriler geri yÃ¼klendi",
                    body: `Dosya: ${file.name}\nTarih: ${new Date().toLocaleString("tr-TR")}`,
                    okText: "Tamam",
                    showCancel: false
                });
                showToast("Yedek YÃ¼klendi âœ…", "success");
            } catch (err) {
                uiOpen({
                    title: "Yedek YÃ¼klenemedi âŒ",
                    subtitle: "JSON formatÄ± hatalÄ± olabilir",
                    body: String(err),
                    okText: "Tamam",
                    showCancel: false
                });
                showToast("Yedek yÃ¼klenemedi âŒ", "error");
            } finally {
                e.target.value = "";
            }
        });
        document.getElementById("btnPickBackupFile")?.addEventListener("click", async () => {
            await pickBackupFileOnce();
        });

        document.getElementById("btnClearBackupFile")?.addEventListener("click", async () => {
            await idbDelBackup(BACKUP_HANDLE_KEY);
            showToast("Otomatik kayÄ±t dosyasÄ± sÄ±fÄ±rlandÄ±.", "info");
            await updateBackupFileStatus();
        });

        /* ---------- EXCEL (CSV) Export/Import ---------- */

        // CSV helper
        function isoToYMD(iso) {
            try {
                const d = new Date(iso);
                if (isNaN(d)) return "";
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, "0");
                const day = String(d.getDate()).padStart(2, "0");
                return `${y}-${m}-${day}`;
            } catch { return ""; }
        }

        function ymdToIso(ymd) {
            // "2026-01-19" -> ISO
            const d = new Date(ymd + "T00:00:00");
            return isNaN(d) ? new Date().toISOString() : d.toISOString();
        }

        function downloadCsvText(filename, text) {
            const csv = "\ufeff" + text; // âœ… Excel TR karakterler
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1200);
        }

        function buildOrdersReportCsv(filterFn) {
            const rows = [];
            rows.push(["Tarih", "ÃœrÃ¼n", "Adet", "BirimFiyat", "Tutar", "Ã–denenAdet", "KalanAdet", "Durum"].join(","));

            const list = orders.filter(o => !o.deletedAt);
            const filtered = (typeof filterFn === "function") ? list.filter(filterFn) : list;

            filtered
                .slice()
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(o => {
                    const qty = Number(o.qty || 0);
                    const paid = Number(o.paidQty || 0);
                    const unit = Number(o.unitPrice || 0);
                    const total = Number(o.total || (qty * unit));
                    const kalan = Math.max(0, qty - paid);
                    const urun = (o.product === "damacana") ? "DAMACANA" : "0,5L PET";
                    const durum = (paid >= qty) ? "TAMAMLANDI" : (paid > 0 ? "KISMÄ°" : "BEKLÄ°YOR");
                    rows.push([
                        csvEscape(isoToYMD(o.date)),
                        csvEscape(urun),
                        csvEscape(qty),
                        csvEscape(unit),
                        csvEscape(total),
                        csvEscape(paid),
                        csvEscape(kalan),
                        csvEscape(durum)
                    ].join(","));
                });

            return rows.join("\n");
        }

        function buildPaymentsReportCsv(filterFn) {
            const rows = [];
            rows.push(["Tarih", "Firma", "Adet", "Tutar", "Not"].join(","));

            const filtered = (typeof filterFn === "function") ? payments.filter(filterFn) : payments;

            filtered
                .slice()
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(p => {
                    rows.push([
                        csvEscape(isoToYMD(p.date)),
                        csvEscape(p.firma || settings?.firmaAdi || ""),
                        csvEscape(Number(p.qty || 0)),
                        csvEscape(Number(p.amount || 0)),
                        csvEscape(p.note || "")
                    ].join(","));
                });

            return rows.join("\n");
        }

        function csvEscape(v) {
            const s = String(v ?? "");
            if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
            return s;
        }

        function buildExcelCsvText(filterFn) {
            const s = loadSettings();
            const oAll = loadOrders();
            const pAll = loadPayments();

            const o = typeof filterFn === "function" ? oAll.filter(filterFn) : oAll;
            const p = typeof filterFn === "function" ? pAll.filter(filterFn) : pAll;

            const lines = [];

            // SETTINGS
            lines.push("SECTION,KEY,VALUE");
            lines.push(`SETTINGS,priceDamacana,${csvEscape(s.priceDamacana ?? 0)}`);
            lines.push(`SETTINGS,pricePet05,${csvEscape(s.pricePet05 ?? 0)}`);
            lines.push(`SETTINGS,whatsapp,${csvEscape(s.whatsapp ?? "")}`);
            lines.push(`SETTINGS,firmaAdi,${csvEscape(s.firmaAdi ?? "")}`);
            lines.push("");

            // ORDERS
            lines.push("SECTION,id,product,qty,paidQty,unitPrice,total,date");
            o.forEach(x => {
                lines.push([
                    "ORDERS",
                    csvEscape(x.id),
                    csvEscape(x.product),
                    csvEscape(x.qty),
                    csvEscape(x.paidQty ?? 0),
                    csvEscape(x.unitPrice ?? 0),
                    csvEscape(x.total ?? (Number(x.qty || 0) * Number(x.unitPrice || 0))),
                    csvEscape(x.date ?? "")
                ].join(","));
            });
            lines.push("");

            // PAYMENTS
            lines.push("SECTION,id,orderId,qty,amount,date");
            p.forEach(x => {
                lines.push([
                    "PAYMENTS",
                    csvEscape(x.id),
                    csvEscape(x.orderId),
                    csvEscape(x.qty ?? 0),
                    csvEscape(x.amount ?? 0),
                    csvEscape(x.date ?? "")
                ].join(","));
            });

            return lines.join("\n");
        }



        function downloadExcelCsv(filterFn, filename) {
            const csv = "\ufeff" + buildExcelCsvText(filterFn); // âœ… Excel TÃ¼rkÃ§e iÃ§in BOM
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename || "su_siparis_excel.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1200);

            showToast("Excel (CSV) dÄ±ÅŸa aktarÄ±ldÄ± âœ…", "success");
        }


        function parseCsvLine(line) {
            // basit CSV parser (tÄ±rnak destekli)
            const out = [];
            let cur = "", inQ = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (inQ) {
                    if (ch === '"' && line[i + 1] === '"') { cur += '"'; i++; }
                    else if (ch === '"') { inQ = false; }
                    else cur += ch;
                } else {
                    if (ch === '"') inQ = true;
                    else if (ch === ',') { out.push(cur); cur = ""; }
                    else cur += ch;
                }
            }
            out.push(cur);
            return out;
        }
        function makeRangeFilter(from, to) {
            const fromD = new Date(from + "T00:00:00");
            const toD = new Date(to + "T23:59:59");
            return (x) => {
                const d = new Date(x.date || "");
                return !isNaN(d) && d >= fromD && d <= toD;
            };
        }

        function askRangeAndRun(title, cb) {
            uiConfirm({
                title,
                subtitle: "BaÅŸlangÄ±Ã§ ve bitiÅŸ tarihini seÃ§",
                body: `
      <div class="field"><label>BaÅŸlangÄ±Ã§</label><input id="csvFrom" type="date"></div>
      <div class="field"><label>BitiÅŸ</label><input id="csvTo" type="date"></div>
    `,
                okText: "Devam",
                cancelText: "VazgeÃ§",
                onOk: () => {
                    const from = document.getElementById("csvFrom")?.value;
                    const to = document.getElementById("csvTo")?.value;
                    if (!from || !to) { showToast("Tarih seÃ§melisin", "error"); return; }
                    uiClose();
                    cb(from, to);
                }
            });
        }

        function loadPayments() {
                return []; // âœ… Google tek kaynak
            }

            function savePayments(list) {
                // âœ… no-op (localStorage kapalÄ±)
                perfInvalidate("payments changed");
            }

        /* ================== PERF CACHE (Ã–zet + Raporlar) ================== */
            /*
              AmaÃ§:
              - renderSummary / raporlar her seferinde orders Ã¼zerinde filter+reduce yapmasÄ±n
              - orders deÄŸiÅŸince cache sÄ±fÄ±rlansÄ±n, ihtiyaÃ§ olunca 1 kere hesaplanÄ±p saklansÄ±n
            */

            const perfCache = {
                // dashYear -> { toplamAdet, toplamSiparisTutari, odenenTutar, kalan, paidQtyAll }
                summaryByDashYear: new Map(),

                // rptYear -> months[12] = { qty,total,paid }
                yearStats: new Map(),

                dirty: true
            };

            function perfInvalidate(reason) {
                perfCache.dirty = true;
                perfCache.summaryByDashYear.clear();
                perfCache.yearStats.clear();
                // istersen debug:
                // console.log("perfInvalidate:", reason);
            }

            function perfKeyDashYear() {
                return (dashYear == null) ? "ALL" : String(dashYear);
            }

            function perfGetVisibleOrders() {
                // tek yerden "silinmeyen sipariÅŸler"
                return (orders || []).filter(o => !o.deletedAt);
            }

            // summary hesapla (dashboard yÄ±lÄ±na gÃ¶re)
            function perfComputeSummaryForDashYear() {
                    const key = perfKeyDashYear();

                    // cache temizse direkt dÃ¶n
                    if (!perfCache.dirty && perfCache.summaryByDashYear.has(key)) {
                        return perfCache.summaryByDashYear.get(key);
                    }

                    const visible = perfGetVisibleOrders();
                    const list = filterByDashYear(visible);

                    const toplamAdet = Number(list.reduce((s, o) => s + Number(o.qty || 0), 0)) || 0;

                    const toplamSiparisTutari = Number(list.reduce((s, o) => {
                        const qty = Number(o.qty || 0);
                        const unit = Number(o.unitPrice || 0);
                        return s + (qty * unit);
                    }, 0)) || 0;

                    const odenenTutar = Number(list.reduce((s, o) => {
                        const qty = Number(o.qty || 0);
                        const unit = Number(o.unitPrice || 0);
                        const paidQty = Math.min(qty, Number(o.paidQty || 0));
                        return s + (paidQty * unit);
                    }, 0)) || 0;

                    const kalan = Math.max(0, toplamSiparisTutari - odenenTutar);

                    const paidQtyAll = Number(list.reduce((s, o) => s + Number(o.paidQty || 0), 0)) || 0;

                    const out = { toplamAdet, toplamSiparisTutari, odenenTutar, kalan, paidQtyAll };

                    perfCache.summaryByDashYear.set(key, out);
                    perfCache.dirty = false;

                    return out;
                }


            /* Raporlar iÃ§in yÄ±llÄ±k ay istatistikleri: months[12] = {qty,total,paid}
               Not: burada da "silinmeyen sipariÅŸler" Ã¼zerinden hesaplÄ±yoruz. */
            function perfComputeYearStats(year) {
                if (!perfCache.dirty && perfCache.yearStats.has(year)) {
                    return perfCache.yearStats.get(year);
                }

                const months = Array.from({ length: 12 }, () => ({ qty: 0, total: 0, paid: 0 }));
                const visible = perfGetVisibleOrders();

                for (const o of visible) {
                    const d = new Date(o.date || "");
                    if (isNaN(d)) continue;
                    if (d.getFullYear() !== year) continue;

                    const m = d.getMonth(); // 0-11
                    const qty = Number(o.qty || 0);
                    const unit = Number(o.unitPrice || 0);
                    const paidQty = Math.min(qty, Number(o.paidQty || 0));

                    months[m].qty += qty;
                    months[m].total += qty * unit;
                    months[m].paid += paidQty * unit;
                }

                perfCache.yearStats.set(year, months);
                perfCache.dirty = false;
                return months;
            }

        let payments = loadPayments();
        let editingPaymentId = null;
        let rptMonthDetailOpen = false;
        let dashYear = new Date().getFullYear(); // baÅŸlangÄ±Ã§



        function renderDashYearLabel(shouldFocus = false) {
            const el = document.getElementById("dashYearText");
            if (!el) return;

            const nowYear = new Date().getFullYear();

            // yazÄ±
            el.textContent = (dashYear == null) ? "TÃ¼mÃ¼" : String(dashYear);

            // class reset
            el.classList.remove("is-selected", "is-current", "is-all");

            // her durumda seÃ§ili gÃ¶rÃ¼nsÃ¼n
            el.classList.add("is-selected");

            if (dashYear == null) {
                el.classList.add("is-all");
            } else if (dashYear === nowYear) {
                el.classList.add("is-current");
            }

            // istenirse focus (ilk aÃ§Ä±lÄ±ÅŸ + yÄ±l deÄŸiÅŸince)
            if (shouldFocus) {
                el.focus({ preventScroll: true });
            }
        }


        document.getElementById("btnDashYearPrev")?.addEventListener("click", () => {
            if (dashYear == null) dashYear = new Date().getFullYear();
            dashYear--;
            renderDashYearLabel(true);

            renderDashboard(); // sende dashboard gÃ¼ncelleyen fonksiyon adÄ± neyse o
        });

        document.getElementById("btnDashYearNext")?.addEventListener("click", () => {
            if (dashYear == null) dashYear = new Date().getFullYear();
            dashYear++;
            renderDashYearLabel(true);

            renderDashboard();
        });

        document.getElementById("btnDashYearAll")?.addEventListener("click", () => {
            dashYear = null;
            renderDashYearLabel(true);

            renderDashboard();
        });
        function renderDashboard() {
            // Dashboard = Ã¶zet + pil + saÄŸ kutular
            renderSummary();

            // BorÃ§ modalÄ± aÃ§Ä±ksa listeyi de yenileyelim
            const debtModal = document.getElementById("debtModal");
            if (debtModal && !debtModal.classList.contains("hidden")) {
                if (typeof renderDebtTable === "function") renderDebtTable();
            }
        }

        function getYearFromDateStr(s) {
            // s: "2026-01-19" veya "19.01.2026" olabilir
            if (!s) return null;
            if (s.includes("-")) return Number(s.slice(0, 4));
            const parts = s.split(".");
            if (parts.length === 3) return Number(parts[2]);
            return null;
        }

        function filterByDashYear(arr) {
            if (dashYear == null) return arr; // tÃ¼mÃ¼
            return arr.filter(x => getYearFromDateStr(x.date || x.tarih) === dashYear);
        }


        function fifoCostForQty(qtyWanted) {
            const list = getDebtItems(); // en eski Ã¼stte
            let remaining = Math.max(0, Number(qtyWanted || 0));
            let cost = 0;

            for (const o of list) {
                if (remaining <= 0) break;
                const take = Math.min(remaining, Number(o.remainingQty || 0));
                cost += take * Number(o.unitPrice || 0);
                remaining -= take;
            }
            return Number(cost || 0);
        }

        function fifoQtyForAmount(amount) {
            const list = getDebtItems();
            let money = Math.max(0, Number(amount || 0));
            let qty = 0;

            for (const o of list) {
                if (money <= 0) break;
                const unit = Number(o.unitPrice || 0);
                const canLeft = Number(o.remainingQty || 0);
                if (unit <= 0) continue;

                // bu sipariÅŸten alÄ±nabilecek adet
                const maxAffordable = Math.floor(money / unit);
                const take = Math.min(canLeft, maxAffordable);

                if (take > 0) {
                    qty += take;
                    money -= take * unit;
                }
            }
            return Number(qty || 0);
        }
        function getCurrentDebtTotals() {
            const list = getDebtItems();
            const totalQty = list.reduce((s, x) => s + Number(x.remainingQty || 0), 0);
            const totalTl = list.reduce((s, x) => s + Number(x.remainingTotal || 0), 0);
            return { totalQty, totalTl };
        }

        function getDebtAfterPay(qtyPay) {
            const now = getCurrentDebtTotals();
            const payQty = Math.max(0, Number(qtyPay || 0));
            const payTl = fifoCostForQty(payQty);
            return {
                afterQty: Math.max(0, now.totalQty - payQty),
                afterTl: Math.max(0, now.totalTl - payTl),
                payTl
            };
        }

        function renderPayAfterInfo(qtyPay) {
            const el = document.getElementById("payAfterInfo");
            if (!el) return;

            const now = getCurrentDebtTotals();
            if (!qtyPay || qtyPay < 1) {
                el.textContent = `Mevcut kalan borÃ§: ${now.totalQty} adet â€¢ ${now.totalTl.toFixed(2)} â‚º`;
                return;
            }

            const r = getDebtAfterPay(qtyPay);
            el.textContent =
                `Bu Ã¶deme (${qtyPay} adet â€¢ ${r.payTl.toFixed(2)} â‚º) sonrasÄ± kalan: ${r.afterQty} adet â€¢ ${r.afterTl.toFixed(2)} â‚º`;
        }

    // ===== Google Sheets (Apps Script) =====
    const GS_URL = "https://script.google.com/macros/s/AKfycby7aNR9Ef7TtuaYvBIYrkrRYFQUf1vR06JCiv3okMHMNKxjSxXA2te-Sq3Ksd_UdTYLFg/exec";

    async function gsPost(payload) {
            // âœ… CORS preflight yok: GET ile gÃ¶nderiyoruz
            const q = encodeURIComponent(JSON.stringify(payload));
             const url = `${GS_URL}?q=${q}&_=${Date.now()}`; // âœ… cache kÄ±r

            const res = await fetch(url, { method: "GET", cache: "no-store" });

            const txt = await res.text();

            // BazÄ± durumlarda Apps Script HTML dÃ¶nerse burada yakalarÄ±z
            try {
                return JSON.parse(txt);
            } catch (e) {
                console.warn("GS RAW:", txt);
                throw new Error("Google JSON dÃ¶nmedi (Deploy/izin/URL kontrol)");
            }
        }
        
        async function setSettingsOnSheet(s) {
                const payload = {
                    action: "setSettings",
                    priceDamacana: Number(s.priceDamacana || 0),
                    pricePet05: Number(s.pricePet05 || 0),
                    firmaAdi: String(s.firmaAdi || "").trim(),
                    whatsapp: String(s.whatsapp || "").trim(),
                    actor: currentUser?.username || ""
                };

                const res = await gsPost(payload);
                if (!res?.ok) throw new Error(res?.message || "setSettings baÅŸarÄ±sÄ±z");
                showToast("Google ayarlarÄ± gÃ¼ncellendi âœ…", "success");
                return true;
            }

        async function syncSettingsFromSheet() {
                try {
                    const res = await gsPost({ action: "getSettings" });
                    if (!res?.ok) throw new Error(res?.message || "getSettings baÅŸarÄ±sÄ±z");

                    // gelen 4 ayarÄ± normalize et
                    const s = {
                        priceDamacana: Number(res.data?.priceDamacana || 0),
                        pricePet05: Number(res.data?.pricePet05 || 0),
                        firmaAdi: String(res.data?.firmaAdi || "").trim(),
                        whatsapp: String(res.data?.whatsapp || "").trim()
                    };

                    // Uygulama ayarlarÄ±nÄ± gÃ¼ncelle
                    settings = s;
                    saveSettings(settings);          // offline iÃ§in localde kalsÄ±n (kullanÄ±cÄ± verisi deÄŸil, ortak config)

                    // EÄŸer admin Ayarlar sayfasÄ±nÄ± aÃ§tÄ±ysa inputlara bas
                    document.getElementById("inpPriceDamacana") && (document.getElementById("inpPriceDamacana").value = s.priceDamacana || "");
                    document.getElementById("inpPricePet05") && (document.getElementById("inpPricePet05").value = s.pricePet05 || "");
                    document.getElementById("inpFirmaAdi") && (document.getElementById("inpFirmaAdi").value = s.firmaAdi || "");
                    document.getElementById("inpWhatsapp") && (document.getElementById("inpWhatsapp").value = s.whatsapp || "");

                    // UIâ€™larÄ± gÃ¼ncelle (dashboard vb.)
                    renderSummary?.();
                    renderOrders?.();
                    return true;
                } catch (e) {
                    console.warn("syncSettingsFromSheet:", e);
                    return false;
                }
            }

        // ===== USERS -> Google Sheets =====
            async function addUserToSheet(u) {
                try {
                    const res = await gsPost({
                        action: "addUser",
                        username: String(u.username || ""),
                        password: String(u.pass || ""),     // sheet baÅŸlÄ±ÄŸÄ±n "password" ise bu doÄŸru
                        role: String(u.role || "user"),
                        status: String(u.status || "pending"),
                        createdAt: Number(u.createdAt || Date.now())
                    });

                    if (!res?.ok) throw new Error(res?.message || "addUser baÅŸarÄ±sÄ±z");
                    return true;
                } catch (e) {
                    console.warn("addUserToSheet hata:", e);
                    showToast?.("KullanÄ±cÄ± Google'a yazÄ±lamadÄ±", "error");
                    return false;
                }
            }


    function normalizeGsOrderToLocal(row) {
        // Sheet'ten gelen "orders" satÄ±rÄ±nÄ± bizim local order formatÄ±na Ã§evir
        const product = String(row.urun || "").toUpperCase().includes("DAMACANA") ? "damacana" : "pet05";
        return {
            id: Number(row.id || Date.now()),
            product,
            qty: Number(row.adet || 0),
            paidQty: Number(row.odenenAdet || 0),
            unitPrice: Number(row.birimFiyat || 0),
            total: Number(row.tutar || 0),
            date: String(row.tarih || "") ? (String(row.tarih).includes("T") ? String(row.tarih) : (String(row.tarih) + "T00:00:00.000Z")) : new Date().toISOString(),
            createdBy: row.createdBy || "",
            createdAt: row.createdAt || ""
        };
    }

    async function syncOrdersFromSheet(opts = {}) {
  const silent = !!opts.silent;
  try {
    const list = await gsPost({ action: "getOrders" });
    if (!Array.isArray(list)) throw new Error("Sheets'ten liste gelmedi");
    orders = list.map(normalizeGsOrderToLocal).filter(o => o.qty);
    saveOrders(orders);

    renderOrders?.();
    applyPermissions();
    renderSummary?.();
    if (typeof renderDebtTable === "function") renderDebtTable();

    if (!silent) showToast?.("Google ile eÅŸitlendi", "success");
  } catch (e) {
    console.warn(e);
    if (!silent) showToast?.("Google ile eÅŸitlenemedi (offline olabilir)", "error");
  }
}

    function normalizeGsPaymentRowToLocal(row) {
            // getPayments action'Ä± bizde satÄ±r array dÃ¶nÃ¼yor: [id,tarih,firma,adet,tutarGirilen,tutarFifo,not,createdBy,createdAt,dagitim,ozet,isActive?]
            // Sen M sÃ¼tununa isActive koyduÄŸun iÃ§in index 12 olabilir, ama getPayments filtreleyerek zaten aktifleri dÃ¶ndÃ¼rÃ¼yoruz.
            const id = Number(row[0] || 0);
            return {
                id,
                date: String(row[1] || ""),
                firma: String(row[2] || ""),
                qty: Number(row[3] || 0),
                amount: Number(row[4] || 0),   // tutarGirilen
                note: String(row[6] || ""),    // not
                dagitim: String(row[9] || "[]"),
                ozet: String(row[10] || "")
            };
        }

        async function syncPaymentsFromSheet() {
            try {
                const list = await gsPost({ action: "getPayments" });
                if (!Array.isArray(list)) throw new Error("Sheets'ten Ã¶deme listesi gelmedi");

                payments = list
                    .filter(row => row[11] === true || String(row[11]).toLowerCase() === "true") // L isActive
                    .map(normalizeGsPaymentRowToLocal)
                    .filter(p => p.id && p.qty);


                // âœ… ArtÄ±k localStorage'a yazmÄ±yoruz
                perfInvalidate("payments changed");
                recomputePaidFromPayments?.();
                renderPayHistory?.();

            } catch (e) {
                console.warn(e);
                showToast?.("Google'dan Ã¶demeler Ã§ekilemedi", "error");
            }
        }
        /* ================== GS-Users-Sync (Google tek kaynak) ================== */

            // âœ… RAM cache: loadUsers() hep burayÄ± dÃ¶ndÃ¼recek (sync ile dolar)
            var __usersCache = [];

            // KullanÄ±cÄ± satÄ±rÄ±nÄ± normalize et (Sheet objesi -> app objesi)
            function normalizeGsUserToLocal(u) {
                return {
                    id: Number(u.id || Date.now()),
                    username: String(u.username || "").trim(),
                    pass: String(u.pass ?? u.password ?? u.sifre ?? ""),
                    role: String(u.role || "user"),
                    status: String(u.status || "pending"), // active | passive | pending
                    createdAt: u.createdAt || Date.now()
                };
            }

            // âœ… Googleâ€™dan kullanÄ±cÄ±larÄ± Ã§ek
    // âœ… Googleâ€™dan kullanÄ±cÄ±larÄ± Ã§ek
    async function syncUsersFromSheet({ silent = false } = {}) {
        try {
            const res = await gsPost({ action: "getUsers" });

            // âœ… getUsers bazen array, bazen {ok,data/users} dÃ¶nebilir
            const list =
                Array.isArray(res) ? res :
                    (Array.isArray(res?.users) ? res.users :
                        (Array.isArray(res?.data) ? res.data :
                            (Array.isArray(res?.list) ? res.list : null)));

            if (!Array.isArray(list)) {
                console.warn("getUsers raw:", res);
                throw new Error("Sheets getUsers array dÃ¶nmedi");
            }

            __usersCache = list
                .map(normalizeGsUserToLocal)
                .filter(u => u.username);

            // UI yenilemeleri
            if (typeof renderUsersTable === "function") renderUsersTable();
            if (typeof renderPassiveUsers === "function") renderPassiveUsers();
            applyPermissions?.();

            if (!silent) showToast?.("KullanÄ±cÄ±lar Google'dan gÃ¼ncellendi âœ…", "success");
            return __usersCache;
        } catch (e) {
            console.warn("syncUsersFromSheet hata:", e);
            if (!silent) showToast?.("KullanÄ±cÄ±lar Google'dan Ã§ekilemedi", "error");
            return __usersCache;
        }
    }


            // âœ… Eski kodlar bozulmasÄ±n diye: loadUsers artÄ±k localStorage deÄŸil cache
            function loadUsers() {
                return Array.isArray(__usersCache) ? __usersCache : [];
            }

            // âœ… saveUsers: localStorage yazma yok. Cache gÃ¼ncelle + Googleâ€™a tam liste bas (fire&forget)
            function saveUsers(list) {
                __usersCache = Array.isArray(list) ? list : [];

                // fire & forget: UI donmasÄ±n
                gsPost({ action: "setUsers", users: __usersCache })
                    .then(() => showToast?.("KullanÄ±cÄ±lar Google'a yazÄ±ldÄ± âœ…", "success"))
                    .catch((e) => { console.warn(e); showToast?.("KullanÄ±cÄ±lar Google'a yazÄ±lamadÄ±", "error"); });
            }

            // Tekil iÅŸlemler: status / pass
            async function setUserStatusOnSheet(username, status) {
                return await gsPost({ action: "setUserStatus", username, status });
            }
            async function setUserPasswordOnSheet(username, pass) {
                return await gsPost({ action: "setUserPassword", username, pass });
            }


    async function pushOrderToSheet(localOrder) {
        // local -> sheet formatÄ±na Ã§evirip gÃ¶nder
        const urunText = (localOrder.product === "damacana") ? "DAMACANA" : "0,5L PET";
        return await gsPost({
            action: "addOrder",
            id: Number(localOrder.id),   // âœ… EKLENDÄ°: local id -> sheet id aynÄ± olsun
            tarih: String(localOrder.date || "").slice(0, 10),
            urun: urunText,
            adet: Number(localOrder.qty || 0),
            birimFiyat: Number(localOrder.unitPrice || 0),
            tutar: Number(localOrder.total || 0),
            odenenAdet: Number(localOrder.paidQty || 0),
            kalanAdet: Math.max(0, Number(localOrder.qty || 0) - Number(localOrder.paidQty || 0)),
            durum: (Number(localOrder.paidQty || 0) >= Number(localOrder.qty || 0)) ? "TAMAMLANDI" : "BEKLÄ°YOR",
            createdBy: currentUser?.username || "unknown"
        });

    }
    // âœ… Google Sheets: SipariÅŸ GÃ¼ncelle (ID'ye gÃ¶re satÄ±rÄ± gÃ¼nceller)
        async function updateOrderOnSheet(localOrder) {
            const urunText = (localOrder.product === "damacana") ? "DAMACANA" : "0,5L PET";
            return await gsPost({
                action: "updateOrder",
                id: Number(localOrder.id),
                tarih: String(localOrder.date || "").slice(0, 10),
                urun: urunText,
                adet: Number(localOrder.qty || 0),
                birimFiyat: Number(localOrder.unitPrice || 0),
                tutar: Number(localOrder.total || 0),
                odenenAdet: Number(localOrder.paidQty || 0),
                kalanAdet: Math.max(0, Number(localOrder.qty || 0) - Number(localOrder.paidQty || 0)),
                durum: (Number(localOrder.paidQty || 0) >= Number(localOrder.qty || 0)) ? "TAMAMLANDI" : "BEKLÄ°YOR",
                updatedBy: currentUser?.username || "unknown"
            });
        }

    async function archiveOrderOnSheet(id) {
            try {
                // sadece admin kullansÄ±n (UI zaten admin'e aÃ§Ä±k ama garanti olsun)
                if (!isAdminActive()) return;

                const res = await gsPost({
                    action: "archiveOrder",
                    id: Number(id),
                    actor: currentUser?.username || ""
                });

                if (res?.ok) {
                    showToast?.("Google'da arÅŸivlendi âœ…", "success");
                } else {
                    showToast?.("Google arÅŸivleme hatasÄ±: " + (res?.message || ""), "error");
                }
            } catch (e) {
                console.warn(e);
                showToast?.("Google arÅŸivleme baÅŸarÄ±sÄ±z (offline olabilir)", "error");
            }
        }
        async function applyPaymentOnSheet(p) {
                return await gsPost({
                    action: "applyPayment",
                    id: Number(p.id),
                    tarih: String(p.date || new Date().toISOString()),
                    firma: String(p.firma || ""),
                    adet: Number(p.qty || 0),
                    tutarGirilen: Number(p.amount || 0),
                    not: String(p.note || ""),
                    createdBy: currentUser?.username || "unknown"
                });
            }

        async function restoreOrderOnSheet(id) {
                try {
                    const res = await gsPost({
                        action: "restoreOrder",
                        id: Number(id)
                    });

                    if (!res?.ok) {
                        throw new Error(res?.message || "restoreOrder baÅŸarÄ±sÄ±z");
                    }
                    return true;
                } catch (e) {
                    console.warn("Google restore hatasÄ±:", e);
                    if (typeof showToast === "function") {
                        showToast("Google geri yÃ¼kleme hatasÄ±", "danger");
                    }
                    return false;
                }
            }
        // ===== PAYMENTS -> Google Sheets =====
            async function archivePaymentOnSheet(paymentId) {
                    return await gsPost({ action: "archivePayment", id: Number(paymentId) });
                }

                async function updatePaymentOnSheet(p) {
                    return await gsPost({
                        action: "updatePayment",
                        id: Number(p.id),
                        tarih: String(p.date || new Date().toISOString()),
                        firma: String(p.firma || ""),
                        adet: Number(p.qty || 0),
                        tutarGirilen: Number(p.amount || 0),
                        not: String(p.note || ""),
                        updatedBy: currentUser?.username || "unknown"
                    });
                }


            async function restorePaymentOnSheet(id) {
                try {
                    const res = await gsPost({
                        action: "restorePayment",
                        id: Number(id),
                        actor: currentUser?.username || ""
                    });
                    if (!res?.ok) throw new Error(res?.message || "restorePayment baÅŸarÄ±sÄ±z");
                    return true;
                } catch (e) {
                    console.warn("Google payment restore hatasÄ±:", e);
                    showToast?.("Google Ã¶deme geri yÃ¼kleme baÅŸarÄ±sÄ±z", "error");
                    return false;
                }
            }

            async function updatePaymentOnSheet(payload) {
                try {
                    const res = await gsPost({
                        action: "updatePayment",
                        ...payload,
                        actor: currentUser?.username || ""
                    });
                    if (!res?.ok) throw new Error(res?.message || "updatePayment baÅŸarÄ±sÄ±z");
                    return res;
                } catch (e) {
                    console.warn("Google payment update hatasÄ±:", e);
                    showToast?.("Google Ã¶deme gÃ¼ncelleme baÅŸarÄ±sÄ±z", "error");
                    return { ok: false, message: String(e) };
                }
            }


        function loadOrders() {
            try {
                const raw = localStorage.getItem(ORDERS_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch {
                return [];
            }
        }

        function saveOrders(list) {
            localStorage.setItem(ORDERS_KEY, JSON.stringify(list));
            perfInvalidate("orders changed");
        }
        const PAGE_SIZE = 10; /*tablo kaÃ§ adet gÃ¶rÃ¼nece*/
        let currentPage = 1;
        let orders = loadOrders();
        let editingOrderId = null;



        const defaultSettings = {
            priceDamacana: 0,
            pricePet05: 0,
            whatsapp: "90",
            firmaAdi: ""
        };


        function loadSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_KEY);
                if (!raw) return { ...defaultSettings };
                const obj = JSON.parse(raw);
                return {
                    priceDamacana: Number(obj.priceDamacana || 0),
                    pricePet05: Number(obj.pricePet05 || 0),
                    whatsapp: String(obj.whatsapp || "90"),
                    firmaAdi: String(obj.firmaAdi || ""),
                };

            } catch {
                return { ...defaultSettings };
            }
        }

        function saveSettings(s) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
        }

        let settings = loadSettings();

        function renderSettings() {
            const a = document.getElementById("inpPriceDamacana");
            const b = document.getElementById("inpPricePet05");
            const w = document.getElementById("inpWhatsapp");
            const f = document.getElementById("inpFirmaAdi");

            if (a) a.value = settings.priceDamacana;
            if (b) b.value = settings.pricePet05;
            if (w) w.value = settings.whatsapp;
            if (f) f.value = settings.firmaAdi || "ABDULLAH Ã–ZER";
            updateBackupFileStatus().catch(console.warn);
            updateLastBackupInfoUI();


        }

        function normalizeWhatsapp(raw) {
            // sadece rakam bÄ±rak
            const digits = String(raw || "").replace(/\D/g, "");
            // boÅŸsa default 90
            if (!digits) return "90";
            return digits;
        }

        document.getElementById("btnSaveSettings")?.addEventListener("click", async () => {
                settings = {
                    priceDamacana: Number(document.getElementById("inpPriceDamacana")?.value || 0),
                    pricePet05: Number(document.getElementById("inpPricePet05")?.value || 0),
                    whatsapp: normalizeWhatsapp(document.getElementById("inpWhatsapp")?.value),
                    firmaAdi: String(document.getElementById("inpFirmaAdi")?.value || "ABDULLAH Ã–ZER").trim()
                };

                saveSettings(settings);

                if (isAdminActive?.()) {
                    try {
                        await setSettingsOnSheet(settings); // âœ… TEK GÃ–NDERÄ°M
                    } catch (e) {
                        console.warn(e);
                        showToast("Google'a yazÄ±lamadÄ± âŒ", "error");
                    }
                }

                showToast("Ayarlar kaydedildi âœ…", "success");

                const info = document.getElementById("settingsInfo");
                if (info) {
                    info.textContent = "âœ… Ayarlar kaydedildi.";
                    setTimeout(() => {
                        const el = document.getElementById("settingsInfo");
                        if (el) el.textContent = "";
                    }, 1500);
                }
            });


        // ilk yÃ¼kleme: inputlarÄ± doldur
        renderSettings();
        // GiriÅŸ varsa online veriyi Ã§ek
           if (currentUser?.username) {
                syncOrdersFromSheet();
                syncPaymentsFromSheet();
                startAutoRefresh();
            }


        /* ================== YENÄ° SÄ°PARÄ°Åž MODAL ================== */
        const modal = document.getElementById("orderModal");
        function setTodayToDateInput() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");

            const input = document.getElementById("ordDate");
            if (input) input.value = `${yyyy}-${mm}-${dd}`;
        }
        function openModal() {
            if (!modal) return;
            modal.classList.remove("hidden");
            modal.setAttribute("aria-hidden", "false");

            if (editingOrderId == null) {
                resetOrderForm();
                setTodayToDateInput();
            }
        }


        function resetOrderForm() {
            const qtyEl = document.getElementById("ordQty");
            const prodEl = document.getElementById("ordProduct");
            const unitEl = document.getElementById("ordUnitPrice");
            const dateEl = document.getElementById("ordDate");
            const info = document.getElementById("orderInfo");

            if (qtyEl) qtyEl.value = "";
            if (prodEl) prodEl.value = "damacana";
            if (dateEl) dateEl.value = "";
            if (info) info.textContent = "";

            // Ã¼rÃ¼n + ayarlara gÃ¶re birim fiyatÄ± tekrar bas
            fillPriceFromSettings();

            // imleÃ§ adet kutusunda olsun
            setTimeout(() => qtyEl?.focus(), 0);
        }


        function closeModal() {
            if (!modal) return;
            modal.classList.add("hidden");
            modal.setAttribute("aria-hidden", "true");
            editingOrderId = null;
            const btn = document.getElementById("btnSendWhatsapp");
            if (btn) btn.textContent = "SipariÅŸi Kaydet";
            resetOrderForm(); // KAPANIRKEN SIFIRLA

        }


        function fillPriceFromSettings() {
            const product = document.getElementById("ordProduct")?.value;
            const priceInput = document.getElementById("ordUnitPrice");
            if (!priceInput) return;

            if (product === "damacana") priceInput.value = settings.priceDamacana || 0;
            if (product === "pet05") priceInput.value = settings.pricePet05 || 0;
        }

        // Yeni SipariÅŸ kartÄ±na basÄ±nca aÃ§
        document.querySelector(".card-order")?.addEventListener("click", () => {
                if (!canAddOrder()) {
                uiOpen({
                    title: "Yetki Yok â›”",
                    subtitle: "SipariÅŸ veremezsin",
                    body: "SipariÅŸ vermek iÃ§in hesabÄ±n 'aktif' olmalÄ± (admin onayÄ± gerekir).",
                    okText: "Tamam",
                    showCancel: false
                });
                return;
            }

                openModal();
            });



        // modal kapatma
        document.getElementById("closeModalBg")?.addEventListener("click", closeModal);
        document.getElementById("closeModalX")?.addEventListener("click", closeModal);

        // Ã¼rÃ¼n deÄŸiÅŸince fiyat otomatik gÃ¼ncellensin
        document.getElementById("ordProduct")?.addEventListener("change", fillPriceFromSettings);

        /* ================== WHATSAPP (APP Ã–NCELÄ°KLÄ° + FALLBACK) ================== */
        function buildWhatsappWebLink(phone, message) {
            const msg = encodeURIComponent(message);
            return `https://wa.me/${phone}?text=${msg}`;
        }

        function buildWhatsappDeepLink(phone, message) {
            const msg = encodeURIComponent(message);
            return `whatsapp://send?phone=${phone}&text=${msg}`;
        }

        function buildWhatsappIntentLink(phone, message) {
            const msg = encodeURIComponent(message);
            // Androidâ€™de WhatsApp appâ€™e daha agresif yÃ¶nlendirme
            return `intent://send?phone=${phone}&text=${msg}#Intent;scheme=whatsapp;package=com.whatsapp;end`;
        }

        function openWhatsApp(phone, message) {
            const ua = navigator.userAgent || "";
            const isAndroid = /Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);

            const web = buildWhatsappWebLink(phone, message);
            const deep = buildWhatsappDeepLink(phone, message);
            const intent = buildWhatsappIntentLink(phone, message);

            // Desktop: web yeni sekme
            if (!isAndroid && !isIOS) {
                window.open(web, "_blank");
                return;
            }

            // âœ… Mobil: sayfayÄ± TERK ETMEDEN deep link dene (hidden iframe)
            const iframe = document.createElement("iframe");
            iframe.style.display = "none";
            iframe.src = deep;
            document.body.appendChild(iframe);

            // Android'de intent daha saÄŸlam olabiliyor (bazÄ± cihazlarda)
            if (isAndroid) {
                setTimeout(() => {
                    const iframe2 = document.createElement("iframe");
                    iframe2.style.display = "none";
                    iframe2.src = intent;
                    document.body.appendChild(iframe2);
                    setTimeout(() => iframe2.remove(), 800);
                }, 150);
            }

            // âœ… Deep link Ã§alÄ±ÅŸmazsa: web'i yeni sekmede aÃ§ (ana sayfa aynÄ± kalsÄ±n)
            setTimeout(() => {
                window.open(web, "_blank");
            }, 1200);

            // temizlik
            setTimeout(() => iframe.remove(), 800);
        }


        document.getElementById("btnSendWhatsapp")?.addEventListener("click", () => {
            const info = document.getElementById("orderInfo");

            const qtyRaw = document.getElementById("ordQty")?.value;
            const qty = Number(qtyRaw);

            if (!qtyRaw || isNaN(qty) || qty < 1) {
                if (info) info.textContent = "â— LÃ¼tfen adet gir (en az 1).";
                showToast("LÃ¼tfen adet gir (en az 1).", "error");
                return;
            }

            // âœ… Birim fiyat ayarlarda tanÄ±mlÄ± mÄ±?
            const product = document.getElementById("ordProduct")?.value;
            const needSettingPrice = (product === "damacana")
                ? Number(settings.priceDamacana || 0)
                : Number(settings.pricePet05 || 0);

            if (!needSettingPrice || isNaN(needSettingPrice) || needSettingPrice <= 0) {
                if (info) info.textContent = "â— Birim fiyat ayarlarda tanÄ±mlÄ± deÄŸil. Ayarlardan birim fiyatÄ± gir.";
                showToast("Birim fiyat ayarlarda tanÄ±mlÄ± deÄŸil. Ayarlara yÃ¶nlendiriyorumâ€¦", "error");
                // Admin deÄŸilse ayarlara yÃ¶nlendirme yok
                if (!isAdminActive()) {
                    uiOpen({
                        title: "Birim fiyat tanÄ±mlÄ± deÄŸil",
                        subtitle: "Admin ayarlamalÄ±",
                        body: "SipariÅŸ verebilmek iÃ§in birim fiyatÄ±n admin tarafÄ±ndan Ayarlar'dan girilmesi gerekiyor.",
                        okText: "Tamam",
                        showCancel: false
                    });
                    return;
                }

                uiConfirm({
                    title: "Birim fiyat tanÄ±mlÄ± deÄŸil",
                    subtitle: "Ã–nce Ayarlarâ€™dan birim fiyatÄ± tanÄ±mlamalÄ±sÄ±n.",
                    body: "Ayarlar sayfasÄ±na gidelim mi?",
                    okText: "Ayarlar'a Git",
                    cancelText: "VazgeÃ§",
                    onOk: () => {
                        closeModal();
                        showPage("ayarlar");
                        setTimeout(() => {
                            if (product === "damacana") document.getElementById("inpPriceDamacana")?.focus();
                            else document.getElementById("inpPricePet05")?.focus();
                        }, 150);
                    }
                });

                return;
            }

            const unit = (product === "damacana")
                ? Number(settings.priceDamacana || 0)
                : Number(settings.pricePet05 || 0);

            // ekranda da ayar fiyatÄ±nÄ± gÃ¶sterelim
            const unitEl = document.getElementById("ordUnitPrice");
            if (unitEl) unitEl.value = String(unit);

            const productName = (product === "damacana") ? "Damacana" : "0,5L Pet ÅžiÅŸe";

            const dateVal = document.getElementById("ordDate")?.value; // YYYY-MM-DD
            const message = `${qty} adet ${productName} alabilir miyiz?`;

            // âœ… 1) Ã–nce kaydet (dÃ¼zenleme/yeni) â€” WhatsAppâ€™a bakmadan
            if (editingOrderId != null) {
                const idx = orders.findIndex(x => Number(x.id) === Number(editingOrderId));
                if (idx > -1) {
                    const orderDate = dateVal ? new Date(dateVal) : new Date();
                    const oldPaid = Number(orders[idx].paidQty || 0);
                    const newPaid = Math.min(oldPaid, qty);

                    orders[idx] = {
                        ...orders[idx],
                        product,
                        qty,
                        paidQty: newPaid,
                        unitPrice: unit,
                        total: qty * unit,
                        date: orderDate.toISOString()
                    };

                    saveOrders(orders);
                    console.log("UPDATE ->", orders[idx]);
                    updateOrderOnSheet(orders[idx]).catch(console.warn);

                    renderOrders();
                    renderSummary();
                    if (typeof renderDebtTable === "function") renderDebtTable();
                }

                editingOrderId = null;
                showToast("SipariÅŸ gÃ¼ncellendi âœ…", "success");
            } else {
                addOrder({
                    product,
                    qty,
                    unitPrice: unit,
                    date: dateVal
                });
                showToast("SipariÅŸ kaydedildi âœ…", "success");
            }

            // âœ… 2) Sonra â€œGÃ¶nderelim mi?â€ popupâ€™u aÃ§
            const phone = (settings.whatsapp || "").replace(/\D/g, "");

            uiConfirm({
                title: "Mesaj gÃ¶nderilsin mi?",
                subtitle: phone ? `WhatsApp no: ${phone}` : "WhatsApp no: (Ayarlar â†’ WhatsApp no gir)",
                body: message,
                okText: "WhatsAppâ€™ta AÃ§",
                cancelText: "VazgeÃ§",

                onOk: () => {
                    // GÃ¶nder'e basÄ±nca numara zorunlu
                    if (!phone || phone.length < 10) {
                        if (info) info.textContent = "â— WhatsApp numarasÄ± ayarlardan doÄŸru girilmeli (90 ile, boÅŸluksuz).";
                        showToast("WhatsApp numarasÄ± ayarlardan doÄŸru girilmeli (90 ile, boÅŸluksuz).", "error");
                        return; // popup aÃ§Ä±k kalsÄ±n
                    }

                    openWhatsApp(phone, message);

                    showToast("WhatsApp aÃ§Ä±lÄ±yorâ€¦", "info", 1400);
                    closeModal();

                    // âœ… SipariÅŸten hemen sonra: "Yedek indirilsin mi?" popup'u (sadece WhatsAppâ€™a gidince)
                    const niceDate = (dateVal || new Date().toISOString().slice(0, 10));
                    const pName = (product === "damacana") ? "Damacana" : "0,5L Pet ÅžiÅŸe";
                    const total2 = (qty * unit).toFixed(2);

                    uiConfirm({
                        title: "Yedek AlalÄ±m mÄ±? ðŸ“¦",
                        subtitle: "SipariÅŸ kaydedildi. Ä°ndirilenlerâ€™e JSON yedeÄŸi atalÄ±m mÄ±?",
                        body: `${niceDate} | ${qty} adet ${pName}\nTutar: ${total2} â‚º\n\nNot: Ä°ndirilenlerâ€™de aynÄ± dosya adÄ±na kaydedilir.`,
                        okText: "ðŸ“¥ Ä°ndir",
                        cancelText: "Sonra",
                        onOk: () => {
                            if (typeof downloadBackupJson === "function") downloadBackupJson();
                        }
                    });
                },

                onCancel: () => {
                    // VazgeÃ§: sipariÅŸ zaten kaydedildi -> sadece ekranÄ± kapat
                    if (info) info.textContent = "";
                    closeModal();
                }
            });
        });

        /* ================== EVRENSEL POPUP SÄ°STEMÄ° ================== */
        const uiDialog = document.getElementById("uiDialog");
        let uiOkAction = null;
        let uiCancelAction = null;

        function uiClose() {
            if (!uiDialog) return;

            // âœ… Kapatmadan Ã¶nce focus'u bÄ±rak (aria-hidden uyarÄ±sÄ±nÄ± keser)
            if (document.activeElement && uiDialog.contains(document.activeElement)) {
                document.activeElement.blur();
            }

            uiDialog.classList.add("hidden");
            uiDialog.setAttribute("aria-hidden", "true");

            // âœ… focus ve tÄ±klamayÄ± tamamen kilitle (modern Ã§Ã¶zÃ¼m)
            uiDialog.inert = true;

            uiOkAction = null;
            uiCancelAction = null;
        }


        function uiOpen({
            title = "Bilgi",
            subtitle = "",
            body = "",
            okText = "Tamam",
            cancelText = "VazgeÃ§",
            showCancel = true,
            onOk = null,
            onCancel = null
        } = {}) {
            document.getElementById("uiTitle").textContent = title;
            document.getElementById("uiSubtitle").textContent = subtitle;
            document.getElementById("uiBody").innerHTML = body;

            const okBtn = document.getElementById("uiOkBtn");
            const cancelBtn = document.getElementById("uiCancelBtn");

            okBtn.textContent = okText;
            cancelBtn.textContent = cancelText;
            cancelBtn.style.display = showCancel ? "" : "none";

            uiOkAction = onOk;
            uiCancelAction = onCancel;

            uiDialog.inert = false;
            uiDialog.classList.remove("hidden");
            uiDialog.setAttribute("aria-hidden", "false");

        }

        document.getElementById("uiCloseBg")?.addEventListener("click", () => {
            if (typeof uiCancelAction === "function") uiCancelAction();
            uiClose();
        });
        document.getElementById("uiCloseX")?.addEventListener("click", () => {
            if (typeof uiCancelAction === "function") uiCancelAction();
            uiClose();
        });
        document.getElementById("uiCancelBtn")?.addEventListener("click", () => {
            if (typeof uiCancelAction === "function") uiCancelAction();
            uiClose();
        });
        document.getElementById("uiOkBtn")?.addEventListener("click", (e) => {
            e.preventDefault();
            const act = uiOkAction;   // referansÄ± tut
            if (typeof act === "function") act(); // window.open burada, tÄ±klama anÄ±nda
            uiClose();
        });


        function uiConfirm({ title, subtitle = "", body = "", okText = "Tamam", cancelText = "VazgeÃ§", onOk, onCancel }) {
            uiOpen({ title, subtitle, body, okText, cancelText, showCancel: true, onOk, onCancel });

        }
        function doLogoutConfirm() {
                toggleAccountMenu(false);

                uiConfirm({
                    title: "Ã‡Ä±kÄ±ÅŸ yapÄ±lsÄ±n mÄ±?",
                    subtitle: currentUser?.username ? `${currentUser.username} hesabÄ±ndan Ã§Ä±kÄ±ÅŸ yapÄ±lacak.` : "",
                    body: "Devam edelim mi?",
                    okText: "Ã‡Ä±kÄ±ÅŸ",
                    cancelText: "VazgeÃ§",
                    onOk: () => {
                        uiClose();
                        clearSession();
                        currentUser = null;
                        location.reload();
                    }
                });
            }

        // Popup sistemi hazÄ±r â†’ artÄ±k otomatik yedek sorusunu gÃ¼venle aÃ§abiliriz

        function addOrder({ product, qty, unitPrice, date }) {
            const orderDate = date ? new Date(date) : new Date();

            const order = {
                id: Date.now(),
                product,
                qty,
                paidQty: 0,
                unitPrice,
                total: qty * unitPrice,
                date: orderDate.toISOString()

            };

            orders.push(order);
            currentPage = 1;

            saveOrders(orders);
            // Google Sheets'e de yaz (SADECE YENÄ° SÄ°PARÄ°ÅžTE)
            pushOrderToSheet(order).catch(console.warn);

            renderOrders();
            renderSummary();
        }

        function formatDateTR(iso) {
            try {
                return new Date(iso).toLocaleString("tr-TR");
            } catch {
                return iso || "";
            }
        }
        function formatMoneyTR(value) {
            const n = Number(value || 0);
            return n.toLocaleString("tr-TR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function requireAdmin(actionLabel = "Bu iÅŸlem") {
                if (typeof isAdminActive !== "function" || !isAdminActive()) {
                    uiOpen({
                        title: "Yetki Yok â›”",
                        subtitle: `${actionLabel} sadece admin yapabilir`,
                        body: "Bu hesabÄ±n bu iÅŸlemi yapmaya yetkisi yok.",
                        okText: "Tamam",
                        showCancel: false
                    });
                    showToast?.("Yetki yok (admin gerekir)", "error");
                    return false;
                }
                return true;
            }

        function renderOrders() {
            const host = document.getElementById("ordersList");
            const meta = document.getElementById("ordersMeta");
            const visibleOrders = orders.filter(o => !o.deletedAt);

            if (!host) return;

            if (meta) meta.textContent = `${visibleOrders.length} kayÄ±t`;


            if (visibleOrders.length === 0) {
                host.innerHTML = `<div style="padding:12px; color: rgba(156,163,175,0.95);">HenÃ¼z sipariÅŸ yok.</div>`;
                return;
            }
            // ---- sayfalama iÃ§in sÄ±ralÄ± liste ----
            const sorted = visibleOrders
                .slice()
                .sort((a, b) => (new Date(b.date) - new Date(a.date)) || ((b.id || 0) - (a.id || 0)));



            const totalPages = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));

            // currentPage sÄ±nÄ±r kontrol
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * PAGE_SIZE;
            const pageItems = sorted.slice(start, start + PAGE_SIZE);
            const canManage = isAdminActive();

            const rows = pageItems.map(o => {
                const paid = Number(o.paidQty || 0);
                const qty = Number(o.qty || 0);
                const unit = Number(o.unitPrice || 0);
                const total = Number(o.total || (qty * unit));
                const customer = (settings.firmaAdi || "ABDULLAH Ã–ZER");
                const note = (o.product === "damacana") ? "DAMACANA" : "0,5L PET";
                let statusIcon = "âŒ";          // hiÃ§ Ã¶denmediyse
                if (paid > 0 && paid < qty) statusIcon = "âš ï¸";   // kÄ±smi
                if (paid >= qty) statusIcon = "âœ…";              // tamamÄ± Ã¶dendi
                

                return `
                
                <tr>
                <td>${formatDateTR(o.date).split(" ")[0]}</td>
                <td class="td-num">${qty}</td>
                <td>
                <div class="paid-inline">
                    ${(paid >= qty)
                        ? `<span class="paid-chip ok">âœ… ${paid}/${qty}</span>`
                        : (paid > 0)
                            ? `<span class="paid-chip warn">âš ï¸ ${paid}/${qty}</span>`
                            : `<span class="paid-chip no">âŒ ${paid}/${qty}</span>`
                    }
            <div class="pbar">
            <div class="pbar-fill ${(paid >= qty) ? "ok" : (paid > 0 ? "warn" : "no")
                    }" style="width:${qty ? Math.min(100, (paid / qty) * 100) : 0}%"></div>
                    </div>
                </div>
                </td>

                </td>
                <td>${unit.toFixed(2)} â‚º</td>
                <td class="td-num">${total.toFixed(2)} â‚º</td>
                <td class="td-num">${note}</td>
                <td>${(o.createdBy || "-")}</td>
                <td class="td-right">
                    ${
                (typeof isAdminActive === "function" && isAdminActive())
                ? `<div class="icon-actions">
                <button class="ico-btn ico-edit" data-act="edit" data-id="${o.id}" title="DÃ¼zenle">âœï¸</button>
                <button class="ico-btn ico-del"  data-act="del"  data-id="${o.id}" title="Sil">ðŸ—‘ï¸</button>
                </div>`
                    : `<div class="icon-actions" style="opacity:.45; font-weight:700;">â€”</div>`
                    }
                    </td>


                    
               
                <td>${statusIcon}</td>
                </tr>
                `;
            }).join("");


            host.innerHTML = `
            
                <div class="orders-syncbar">
                <div>
                <div class="orders-sync-title">Google senkron</div>
                <div class="sync-meta" id="ordersLastSyncText">Son senkron: -</div>
                </div>

                <button id="btnRefresh" class="mini-refresh" title="Google'dan yenile">âŸ³</button>

            </div>

            <table class="orders-table">
                <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Adet</th>
                    <th>Ã–denen Adet</th>
                    <th>Birim (â‚º)</th>
                    <th>Toplam (â‚º)</th>
                    <th>Not</th>
                    <th>Kaydeden</th>
                    <th class="td-right">Ä°ÅŸlem</th>
                    <th>Durum</th>
                </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            `;

            // buton clickleri (event delegation)
            host.querySelectorAll("button[data-act]").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = Number(btn.dataset.id);
                    const act = btn.dataset.act
                    if (act === "edit") startEditOrder(id);
                    if (act === "del") deleteOrder(id);
                    
                });
            });
            
            // ---- pager gÃ¼ncelle ----
            const pagerInfo = document.getElementById("pageInfo");
            const prev = document.getElementById("btnPrevPage");
            const next = document.getElementById("btnNextPage");

            if (pagerInfo) pagerInfo.textContent = `Sayfa ${currentPage} / ${totalPages}`;
            if (prev) prev.disabled = (currentPage <= 1);
            if (next) next.disabled = (currentPage >= totalPages);
            // ðŸ”„ Yenile butonu (her render sonrasÄ± yeniden baÄŸla) âœ… spinner + saat + toast
            const btnRefresh = document.getElementById("btnRefresh");
            if (btnRefresh) {
                btnRefresh.onclick = async () => {
                    btnRefresh.classList.add("is-spinning");
                    try {
                        await syncOrdersFromSheet();
                        setOrdersLastSync(new Date());
                    } catch (e) {
                        console.warn(e);
                        showToast?.("Google ile eÅŸitlenemedi", "error");
                    } finally {
                        btnRefresh.classList.remove("is-spinning");
                    }
                };
            }
            
        }
        function renderOrdersTable() {
                const start = (ordersPage - 1) * ORDERS_PER_PAGE;
                const end = start + ORDERS_PER_PAGE;

                const pageOrders = orders.slice(start, end);

                document.getElementById("pageInfo").textContent =
                    `Sayfa ${ordersPage} / ${totalOrdersPages}`;
            }

        function deleteOrder(id, afterDelete) {
        if (!isAdminActive()) {
            
                showToast("Bu iÅŸlem sadece admin iÃ§indir.");
                return;
            }
            if (!requireAdmin("SipariÅŸ silme")) return;

            const o = orders.find(x => Number(x.id) === Number(id));
            if (!o) return;

            const name = (o.product === "damacana") ? "Damacana" : "0,5L Pet";
            const preview = `${name} | ${o.qty} adet | ${o.total} â‚º | ${formatDateTR(o.date)}`;

            uiConfirm({
                title: "SipariÅŸi Sil",
                subtitle: "Bu iÅŸlem geri alÄ±namaz",
                body: preview,
                okText: "Sil",
                cancelText: "VazgeÃ§",
                onOk: async () => {
                    // âœ… soft delete (Ã§Ã¶p kutusuna taÅŸÄ±)
                    const idx = orders.findIndex(x => Number(x.id) === Number(id));
                    if (idx === -1) return;

                    orders[idx].deletedAt = Date.now();
                    updateTrashBadge();

                    saveOrders(orders);
                    

                    // âœ… Google Sheets tarafÄ±nda da arÅŸivle
                    await archiveOrderOnSheet(id);

                    currentPage = 1;
                    renderOrders();
                   
                    renderSummary();

                    if (typeof afterDelete === "function") afterDelete();
                    if (typeof renderDebtTable === "function") renderDebtTable();
                    if (typeof showToast === "function")
                        showToast("SipariÅŸ Ã§Ã¶p kutusuna taÅŸÄ±ndÄ± ðŸ—‘ï¸", "info");
                }
            });
        }
        function applyPaymentFIFO(payQty) {
            let remaining = Number(payQty || 0);
            if (!remaining || remaining < 1) return;

            // orders dizisinin KENDÄ°SÄ°NÄ° tarihe gÃ¶re sÄ±rala (kopya yok)
            orders.sort((a, b) => new Date(a.date) - new Date(b.date));

            for (let i = 0; i < orders.length; i++) {
                if (remaining <= 0) break;

                const o = orders[i];
                const qty = Number(o.qty || 0);
                const paid = Number(o.paidQty || 0);
                const left = qty - paid;

                if (left <= 0) continue;

                const add = Math.min(left, remaining);
                o.paidQty = paid + add;
                remaining -= add;
            }

            saveOrders(orders);
            
            renderOrders();
            renderSummary();
        }
        function applyPaymentFIFOToOrders(ordersList, payQty) {
            let remaining = Number(payQty || 0);
            if (!remaining || remaining < 1) return;

            // en eski sipariÅŸten dÃ¼ÅŸ
            ordersList.sort((a, b) => new Date(a.date) - new Date(b.date));

            for (let i = 0; i < ordersList.length; i++) {
                if (remaining <= 0) break;

                const o = ordersList[i];
                const qty = Number(o.qty || 0);
                const paid = Number(o.paidQty || 0);
                const left = qty - paid;
                if (left <= 0) continue;

                const add = Math.min(left, remaining);
                o.paidQty = paid + add;
                remaining -= add;
            }
        }

        function recomputePaidFromPayments() {
            // 1) tÃ¼m sipariÅŸlerin paidQty'sini sÄ±fÄ±rla
            orders.forEach(o => { o.paidQty = 0; });

            // 2) Ã¶deme listesi: silinmeyen + en eski Ã¶nce
            const sortedPays = (payments || [])
                .filter(p => !p.deletedAt)
                .slice()
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            // 3) dashboard filtresine gÃ¶re uygulanacak sipariÅŸ listesi
            const visibleOrders = (orders || []).filter(o => !o.deletedAt);
            const targetOrders = visibleOrders; // her zaman tÃ¼mÃ¼ 

            // 4) her Ã¶demeyi FIFO ile seÃ§ili yÄ±l sipariÅŸlerine daÄŸÄ±t
            for (const p of sortedPays) {
                applyPaymentFIFOToOrders(targetOrders, Number(p.qty || 0));
            }

            // 5) kaydet + UI
            saveOrders(orders);
            
            renderOrders();
            renderSummary();
            if (typeof renderDebtTable === "function") renderDebtTable();
        }



        function toDateInputValue(iso) {
            try {
                const d = new Date(iso);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, "0");
                const dd = String(d.getDate()).padStart(2, "0");
                return `${yyyy}-${mm}-${dd}`;
            } catch {
                return "";
            }
        }

        function startEditOrder(id) {
            if (!requireAdmin("SipariÅŸ dÃ¼zenleme")) return;

            const o = orders.find(x => Number(x.id) === Number(id));
            if (!o) return;

            editingOrderId = Number(id);

            // modal alanlarÄ±nÄ± doldur
            document.getElementById("ordProduct").value = o.product;
            document.getElementById("ordQty").value = o.qty;
            document.getElementById("ordUnitPrice").value = o.unitPrice;

            const dateEl = document.getElementById("ordDate");
            if (dateEl) dateEl.value = toDateInputValue(o.date);

            // buton yazÄ±sÄ± "GÃ¼ncelle" olsun
            const btn = document.getElementById("btnSendWhatsapp");
            if (btn) btn.textContent = "GÃ¼ncelle";
            

            openModal();
        }

        /* ================== BORÃ‡ ALARM (Dashboard) ================== */
        let _lastDebtLevel = null; // "ok" | "warn" | "alarm"

        function playDebtAlarmBeeps(count = 3) {
            // 3 kere kÄ±sa bip (tarayÄ±cÄ± bazen sesi engelleyebilir)
            let i = 0;
            const tick = () => {
                i++;
                try {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (!AudioCtx) return;
                    const ctx = new AudioCtx();
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = "sine";
                    o.frequency.setValueAtTime(880, ctx.currentTime);
                    g.gain.setValueAtTime(0.0001, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.22, ctx.currentTime + 0.02);
                    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                    o.connect(g); g.connect(ctx.destination);
                    o.start(); o.stop(ctx.currentTime + 0.22);
                    setTimeout(() => { try { ctx.close(); } catch { } }, 300);
                } catch { }

                if (i < count) setTimeout(tick, 260);
            };
            tick();
        }

        function openPayAndFocus() {
            // Senin projende modal aÃ§an fonksiyon neyse onu Ã§aÄŸÄ±rÄ±yoruz.
            // (HazÄ±r dosyada openPayModal kullanÄ±ldÄ±; sende farklÄ±ysa aÅŸaÄŸÄ±yÄ± deÄŸiÅŸtir.)
            try { openPayModal?.(); } catch { }

            // modal aÃ§Ä±ldÄ±ktan sonra inputâ€™a focus
            setTimeout(() => {
                const inp =
                    document.querySelector("#payQty") ||
                    document.querySelector("#paymentQty") ||
                    document.querySelector("input[name='paymentQty']") ||
                    document.querySelector(".pay-modal input[type='number']") ||
                    document.querySelector("#modalPayment input");
                if (inp) inp.focus();
            }, 120);
        }

        function maybeShowDebtAlarm(level, kalanTl) {
  // âœ… sadece admin gÃ¶rsÃ¼n (EN BAÅžTA)
  if (!isAdminActive()) return;

  if (level !== "alarm") { _lastDebtLevel = level; return; }

  // seviye alarm'a yeni geÃ§tiyse 1 kere Ã§alÄ±ÅŸsÄ±n
  if (_lastDebtLevel === "alarm") return;
  _lastDebtLevel = "alarm";

  // aynÄ± yÄ±l filtresinde sayfa yenilenene kadar 1 kere popup
  const key = "debtAlarmShown:" + String(dashYear == null ? "ALL" : dashYear);
  if (sessionStorage.getItem(key) === "1") return;
  sessionStorage.setItem(key, "1");

  playDebtAlarmBeeps(3);

  if (typeof uiConfirm === "function") {
    uiConfirm({
      title: "ðŸš¨ BORÃ‡ ALARMI",
      subtitle: `Kalan borÃ§: ${formatMoneyTR(kalanTl)} â‚º`,
      body: "Kalan borÃ§ 4.000 â‚º Ã¼stÃ¼nde. Ä°stersen hemen kÄ±smi Ã¶deme girebilirsin.",
      okText: "Ã–deme Ekle",
      cancelText: "Kapat",
      onOk: openPayAndFocus
    });
  } else {
    const go = confirm(`BORÃ‡ ALARMI!\nKalan borÃ§: ${formatMoneyTR(kalanTl)} â‚º\n\nKÄ±smi Ã¶deme girmek ister misin?`);
    if (go) openPayAndFocus();
  }
}

        function renderSummary() {
                // âœ… PerformanslÄ± Ã¶zet: cacheâ€™ten oku
                const S = perfComputeSummaryForDashYear();

                // 1) Toplam sipariÅŸ adedi (seÃ§ili yÄ±l)
                const toplamAdet = S.toplamAdet;

                const toplamSiparisEl = document.getElementById("toplamSiparis");
                if (toplamSiparisEl) toplamSiparisEl.textContent = `${toplamAdet} Adet`;

                // 2) Toplam sipariÅŸ tutarÄ± (seÃ§ili yÄ±l)
                const toplamSiparisTutari = S.toplamSiparisTutari;

                // 3) Ã–denen tutar (seÃ§ili yÄ±l)
                const odenenTutar = S.odenenTutar;

                // 4) Kalan borÃ§
                const kalan = Math.max(0, toplamSiparisTutari - odenenTutar);

                // 5) âœ… UI yazdÄ±rma
                const elToplamBorc = document.getElementById("toplamBorc");
                if (elToplamBorc) elToplamBorc.textContent = formatMoneyTR(toplamSiparisTutari);

                const elSag = document.getElementById("toplamBorcSag");
                if (elSag) elSag.textContent = formatMoneyTR(toplamSiparisTutari);

                const elKalan = document.getElementById("kalanBorc");
                if (elKalan) elKalan.textContent = formatMoneyTR(kalan);

                // âœ… Kalan borÃ§ seviye rengi + alarm
                const debtCard = document.querySelector(".sum-item.danger");
                if (debtCard) debtCard.classList.remove("debt-ok", "debt-warn", "debt-alarm");

                let level = "ok";
                if (kalan >= 4000) level = "alarm";
                else if (kalan >= 3000) level = "warn";

                if (debtCard) debtCard.classList.add("debt-" + level);
                maybeShowDebtAlarm(level, kalan);

                // 6) âœ… Kalan borÃ§ pili (adet bazlÄ±)
                const paidQtyAll = Number(S.paidQtyAll || 0);


                const remainingQtyAll = Math.max(0, toplamAdet - paidQtyAll);
                const pct = toplamAdet > 0 ? Math.round((remainingQtyAll / toplamAdet) * 100) : 0;

                const batteryFillEl = document.getElementById("debtBatteryFill");
                const txt = document.getElementById("debtBatteryText");

                if (batteryFillEl) batteryFillEl.style.width = pct + "%";
                if (txt) txt.textContent = `${remainingQtyAll} adet kaldÄ± (${pct}%)`;

                // pil dolgusunu renklendir (class)
                if (batteryFillEl) {
                    batteryFillEl.classList.remove("ok", "warn", "alarm");
                    batteryFillEl.classList.add(level === "alarm" ? "alarm" : (level === "warn" ? "warn" : "ok"));
                }
            }
        function renderBugunTarih() {
            const el = document.getElementById("bugunTarih");
            if (!el) return;

            const d = new Date();
            const tarih = d.toLocaleDateString("tr-TR", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric"
            });

            el.textContent = tarih;
        }

        /* ================== RAPORLAR (AylÄ±k / YÄ±llÄ±k) ================== */
        let rptYear = new Date().getFullYear();
        let rptMonth = new Date().getMonth(); // 0-11
        let rptMode = "qty"; // "qty" | "total"
        let reportsBound = false;
        let rptAllYears = false;


        function ymFromIso(iso) {
            try {
                const d = new Date(iso);
                return { y: d.getFullYear(), m: d.getMonth() };
            } catch {
                return { y: 0, m: 0 };
            }
        }

        function calcYearStats(year) {
            // 12 ay iÃ§in: qty, total, paid (o ayÄ±n sipariÅŸleri Ã¼zerinden), remain
            const months = Array.from({ length: 12 }, () => ({
                qty: 0,
                total: 0,
                paid: 0,
                remain: 0
            }));

            // SipariÅŸleri yÄ±l/ay bazÄ±nda topla
            (orders || []).filter(o => !o.deletedAt).forEach(o => {
                const { y, m } = ymFromIso(o.date);
                if (y !== year) return;

                const qty = Number(o.qty || 0);
                const unit = Number(o.unitPrice || 0);
                const total = qty * unit;

                const paidQty = Math.min(qty, Number(o.paidQty || 0));
                const paid = paidQty * unit;

                months[m].qty += qty;
                months[m].total += total;
                months[m].paid += paid;
            });

            // remain hesapla
            months.forEach(x => {
                x.remain = Math.max(0, x.total - x.paid);
            });

            return months;
        }
        function calcAllYearsFromYearStats_() {
                // EÄŸer orders boÅŸsa hiÃ§ uÄŸraÅŸma
                if (typeof orders === "undefined" || !Array.isArray(orders) || orders.length === 0) {
                    return Array.from({ length: 12 }, () => ({ qty: 0, total: 0, paid: 0, remain: 0 }));
                }

                const out = Array.from({ length: 12 }, () => ({ qty: 0, total: 0, paid: 0, remain: 0 }));
                const years = getAvailableYears_();

                for (const y of years) {
                    const months = calcYearStats(y); // ðŸ”¥ senin Ã§alÄ±ÅŸan fonksiyon

                    for (let i = 0; i < 12; i++) {
                        out[i].qty += Number(months[i]?.qty || 0);
                        out[i].total += Number(months[i]?.total || 0);
                        out[i].paid += Number(months[i]?.paid || 0);
                        out[i].remain += Number(months[i]?.remain || 0);
                    }
                }

                return out;
            }

            function getAvailableYears_() {
                    const list = (typeof orders !== "undefined" && Array.isArray(orders)) ? orders : [];

                    const years = new Set();
                    for (const o of list) {
                        const d = new Date(o.tarih || o.date || o.Tarih);
                        if (!isNaN(d.getTime())) years.add(d.getFullYear());
                    }

                    return Array.from(years).sort((a, b) => a - b);
                }



        function setKpisFromMonth(stats) {
            const qtyEl = document.getElementById("rptKpiQty");
            const totalEl = document.getElementById("rptKpiTotal");
            const paidEl = document.getElementById("rptKpiPaid");
            const remEl = document.getElementById("rptKpiRemain");

            if (qtyEl) qtyEl.textContent = `${Math.round(stats.qty)} Adet`;
            if (totalEl) totalEl.textContent = `${formatMoneyTR(stats.total)} â‚º`;
            if (paidEl) paidEl.textContent = `${formatMoneyTR(stats.paid)} â‚º`;
            if (remEl) remEl.textContent = `${formatMoneyTR(stats.remain)} â‚º`;
        }

        function renderBars(yearMonths) {
            const host = document.getElementById("rptBarsHost");
            if (!host) return;

            const labels = ["Oca", "Åžub", "Mar", "Nis", "May", "Haz", "Tem", "AÄŸu", "Eyl", "Eki", "Kas", "Ara"];
            const values = yearMonths.map(m => (rptMode === "qty" ? m.qty : m.total));
            const maxV = Math.max(1, ...values);
            // ðŸ”¥ En yoÄŸun ay (adet bazlÄ±) index'i
            const bestIdx = yearMonths.reduce((best, m, i) => {
                return (m.qty || 0) > (yearMonths[best]?.qty || 0) ? i : best;
            }, 0);
            const hasAnyQty = yearMonths.some(m => (m.qty || 0) > 0);


            host.innerHTML = yearMonths.map((m, i) => {

                const val = (rptMode === "qty" ? m.qty : m.total);
                if (val === 0) return "";
                const pct = Math.round((val / maxV) * 100);
                const isActive = (i === rptMonth);
                const isBest = hasAnyQty && (i === bestIdx);


                const rightText = (rptMode === "qty")
                    ? `${Math.round(m.qty)}`
                    : `${formatMoneyTR(m.total)} â‚º`;

                return `
      <button
        class="mini-btn"
        data-rpt-month="${i}"
        style="
          width:100%;
          text-align:left;
          padding:12px;
          border-radius:16px;
          display:flex;
          align-items:center;
          gap:10px;
          justify-content:space-between;
          border:1px solid rgba(148,163,184,0.30);
          background: ${isActive ? "rgba(56,189,248,0.12)" : "rgba(15,23,42,0.45)"};
        "
      >
        <div style="min-width:38px; font-weight:900;">
        ${labels[i]}${isBest ? " ðŸ”¥" : ""}
        </div>


        <div style="flex:1; height:10px; border-radius:999px; background: rgba(148,163,184,0.22); overflow:hidden;">
          <div style="height:100%; width:${pct}%; border-radius:999px; background: ${isBest ? "rgba(250,204,21,0.95)" : "rgba(56,189,248,0.9)"};"></div>
        </div>

        <div style="min-width:92px; text-align:right; font-weight:900;">${rightText}</div>
      </button>
    `;
            }).join("");

            // bar click
            host.querySelectorAll("button[data-rpt-month]").forEach(btn => {
                btn.addEventListener("click", () => {
                    rptMonth = Number(btn.dataset.rptMonth);
                    const sel = document.getElementById("rptMonthSelect");
                    if (sel) sel.value = String(rptMonth);
                    renderReports(); // yeniden Ã§iz
                });
            });
        }

        function bindReportsUIOnce() {
            if (reportsBound) return;
            reportsBound = true;

            document.getElementById("rptYearPrev")?.addEventListener("click", () => {
                rptYear -= 1;
                renderReports();
            });

            document.getElementById("rptYearNext")?.addEventListener("click", () => {
                rptYear += 1;
                renderReports();
            });

            document.getElementById("rptMonthSelect")?.addEventListener("change", (e) => {
                rptMonth = Number(e.target.value || 0);
                renderReports();
            });

            document.getElementById("rptChartMode")?.addEventListener("change", (e) => {
                rptMode = String(e.target.value || "qty");
                renderReports();
            });
        }
        document.getElementById("rptToggleMonthDetail")?.addEventListener("click", () => {
            rptMonthDetailOpen = !rptMonthDetailOpen;
            renderReports();
        });
        const allBtn = document.getElementById("rptAllYearsBtn");
            if (allBtn && !allBtn.dataset.bound) {
                allBtn.dataset.bound = "1";
                allBtn.addEventListener("click", () => {
                    rptAllYears = !rptAllYears;
                    allBtn.classList.toggle("active", rptAllYears);

                    // TÃ¼mÃ¼ moduna geÃ§ince ay seÃ§imini Ocak'a Ã§ekmek istersen:
                    // rptMonth = 0;

                    renderReports();
                });
            }



        function renderReports() {
            bindReportsUIOnce();
            const prevBtn = document.getElementById("rptPrevYearBtn");
            const nextBtn = document.getElementById("rptNextYearBtn");

            if (prevBtn) prevBtn.disabled = rptAllYears;
            if (nextBtn) nextBtn.disabled = rptAllYears;

            // yÄ±l label
            const yearEl = document.getElementById("rptYearLabel");
            if (yearEl) yearEl.textContent = rptAllYears ? "TÃ¼m YÄ±llar" : String(rptYear);


            // ay select sync
            const monthSel = document.getElementById("rptMonthSelect");
            if (monthSel) monthSel.value = String(rptMonth);

            // hesapla
            const months = rptAllYears
                ? calcAllYearsFromYearStats_()
                : calcYearStats(rptYear);

            // ===== YÄ±llÄ±k Ã¶zet hesaplarÄ± =====
            const monthNames = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];

            const yearQty = months.reduce((s, m) => s + (m.qty || 0), 0);
            const yearTotal = months.reduce((s, m) => s + (m.total || 0), 0);
            const yearPaid = months.reduce((s, m) => s + (m.paid || 0), 0);
            const yearRemain = Math.max(0, yearTotal - yearPaid);

            // En yÃ¼ksek / en dÃ¼ÅŸÃ¼k ay (0 olan aylarÄ± "en dÃ¼ÅŸÃ¼k" hesabÄ±na sokmayalÄ±m)
            const nonZero = months
                .map((m, i) => ({ ...m, i }))
                .filter(x => (x.qty || 0) > 0);

            let bestText = "--";
            let worstText = "--";

            if (nonZero.length > 0) {
                const best = nonZero.reduce((a, b) => (b.qty > a.qty ? b : a));
                const worst = nonZero.reduce((a, b) => (b.qty < a.qty ? b : a));

                bestText = `${monthNames[best.i]} â€¢ ${Math.round(best.qty)} Adet`;
                worstText = `${monthNames[worst.i]} â€¢ ${Math.round(worst.qty)} Adet`;
            }

            // UI yazdÄ±r
            const yq = document.getElementById("rptYearTotalQty");
            const yr = document.getElementById("rptYearRemainMoney");
            const bestLine = document.getElementById("rptBestMonthLine");
            const yt = document.getElementById("rptYearTotalMoney");
            if (yt) yt.textContent = `${formatMoneyTR(yearTotal)} â‚º`;

            if (bestLine) {
                bestLine.textContent = (bestText !== "--")
                    ? (rptAllYears ? `TÃ¼m yÄ±llarda en yoÄŸun ay: ${bestText}` : `En yoÄŸun ay: ${bestText}`)
                    : (rptAllYears ? `HenÃ¼z veri yok.` : `Bu yÄ±l iÃ§in henÃ¼z veri yok.`);

            }



            if (yq) yq.textContent = `${Math.round(yearQty)} Adet`;
            if (yr) yr.textContent = `${formatMoneyTR(yearRemain)} â‚º`;



            // KPI
            setKpisFromMonth(months[rptMonth] || { qty: 0, total: 0, paid: 0, remain: 0 });
            // ===== Tek satÄ±r aylÄ±k Ã¶zet =====
            const oneLine = document.getElementById("rptMonthOneLine");
            if (oneLine) {
                const monthNames = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
                const m = months[rptMonth] || { qty: 0, total: 0, paid: 0, remain: 0 };
                const years = rptAllYears ? getAvailableYears_() : [rptYear];
                const yearText = rptAllYears
                    ? `${years[0]}-${years[years.length - 1]}`
                    : String(rptYear);

                oneLine.textContent =
                    `${monthNames[rptMonth]} ${yearText} â€¢ ` +
                    `${Math.round(m.qty)} Adet â€¢ ` +
                    `${formatMoneyTR(m.remain)} â‚º Kalan`;

            }
            const breakdownEl = document.getElementById("rptMonthYearBreakdown");
            if (breakdownEl) {
                if (rptAllYears) {
                    const monthNames = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
                    const mname = monthNames[rptMonth].toUpperCase();

                    const byYear = calcMonthByYearQty_(orders, rptMonth);

                    const years = Object.keys(byYear).map(Number).sort((a, b) => a - b);

                    let html = `<div class="title">${mname} AYI</div>`;
                    if (years.length === 0) {
                        html += `<div class="row"><span class="y">Veri yok</span><span class="v">0 adet</span></div>`;
                    } else {
                        // max / min bul
                        let maxY = null, minY = null;
                        let maxV = -Infinity, minV = Infinity;

                        for (const y of years) {
                            const v = Number(byYear[y] || 0);
                            if (v > maxV) { maxV = v; maxY = y; }
                            if (v < minV) { minV = v; minY = y; }
                        }

                        // satÄ±rlarÄ± yaz
                        for (const y of years) {
                            const v = Math.round(byYear[y] || 0);
                            const cls =
                                (y === maxY) ? "row max" :
                                    (y === minY) ? "row min" :
                                        "row";

                            html += `
    <div class="${cls}">
      <span class="y">${y}</span>
      <span class="v">${v} adet</span>
    </div>
  `;
                        }

                    }

                    breakdownEl.innerHTML = html;
                    breakdownEl.style.display = "block";
                } else {
                    breakdownEl.style.display = "none";
                    breakdownEl.innerHTML = "";
                }
            }


            // SeÃ§ili Ay KPI detaylarÄ±nÄ± aÃ§/kapat
            const grid = document.getElementById("rptMonthKpiGrid");
            const btn = document.getElementById("rptToggleMonthDetail");
            if (grid) grid.style.display = rptMonthDetailOpen ? "grid" : "none";
            if (btn) btn.textContent = rptMonthDetailOpen ? "Kapat" : "Detay";

            // grafik
            renderBars(months);
        }

   
    
        renderOrders();
        renderSummary();
        renderDashYearLabel(true);
        renderDashboard();
        renderBugunTarih();


        document.getElementById("btnPrevPage")?.addEventListener("click", () => {
                if (typeof currentPage !== "number") currentPage = 1;
                if (currentPage > 1) currentPage--;
                renderOrders();
            });

            document.getElementById("btnNextPage")?.addEventListener("click", () => {
                if (typeof currentPage !== "number") currentPage = 1;
                currentPage++;
                renderOrders(); // renderOrders iÃ§inde zaten totalPages'e gÃ¶re geri sÄ±nÄ±rlar
            });

    function calcMonthByYearQty_(list, monthIndex) {
            const map = {}; // {2023: 6, 2024: 5}

            for (const o of (Array.isArray(list) ? list : [])) {
                const raw = o.tarih ?? o.date ?? o.Tarih ?? o.t ?? "";
                const d = new Date(raw);
                if (isNaN(d.getTime())) continue;
                if (d.getMonth() !== monthIndex) continue;

                const y = d.getFullYear();
                map[y] = (map[y] || 0) + Number(o.adet || o.qty || 0);
            }

            return map;
        }



        /* ================== KALAN BORÃ‡ MODAL ================== */
        const debtModal = document.getElementById("debtModal");
        const debtHost = document.getElementById("debtTableHost");

        function openDebtModal() {
        if (!requireLoginOrOpenAuth()) return;
            if (!debtModal) return;
            renderDebtTable();
            debtModal.classList.remove("hidden");
            debtModal.setAttribute("aria-hidden", "false");
        }

        function closeDebtModal() {
            if (!debtModal) return;
            debtModal.classList.add("hidden");
            debtModal.setAttribute("aria-hidden", "true");
        }

        /* Kalan BorÃ§ kartÄ±na tÄ±klayÄ±nca aÃ§ */
        document.querySelector(".sum-item.danger")?.addEventListener("click", openDebtModal);

        document.getElementById("closeDebtBg")?.addEventListener("click", closeDebtModal);
        document.getElementById("closeDebtX")?.addEventListener("click", closeDebtModal);

        /* BorÃ§ satÄ±rlarÄ±: kalan adet > 0 olan sipariÅŸler (en eski Ã¼stte) */
        function getDebtItems() {
            return orders
                .filter(o => !o.deletedAt)
                .slice()
                .map(o => {
                    const qty = Number(o.qty || 0);
                    const paid = Number(o.paidQty || 0);
                    const remainingQty = Math.max(0, qty - paid);
                    const unit = Number(o.unitPrice || 0);
                    return { ...o, remainingQty, unit, remainingTotal: remainingQty * unit };
                })
                .filter(x => x.remainingQty > 0)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

        }

        function formatDateShortTR(iso) {
            try {
                const d = new Date(iso);
                const dd = String(d.getDate()).padStart(2, "0");
                const mm = String(d.getMonth() + 1).padStart(2, "0");
                const yy = d.getFullYear();
                return `${dd}.${mm}.${yy}`;
            } catch { return ""; }
        }

        function renderDebtTable() {
            if (!debtHost) return;

            const list = getDebtItems(); // FIFO mantÄ±ÄŸÄ± iÃ§in dokunmuyoruz

            // âœ… SADECE TABLODA GÃ–STERÄ°M: en yeni sipariÅŸ Ã¼stte
            const displayList = list
                .slice()
                .sort((a, b) => (new Date(b.date) - new Date(a.date)) || ((b.id || 0) - (a.id || 0)));


            const totalQty = list.reduce((s, x) => s + Number(x.remainingQty || 0), 0);
            const totalTl = list.reduce((s, x) => s + Number(x.remainingTotal || 0), 0);

            const totalsEl = document.getElementById("debtTotals");
            if (totalsEl) totalsEl.textContent = `${totalQty} adet â€¢ ${formatMoneyTR(totalTl)} â‚º`;

            if (list.length === 0) {
                debtHost.innerHTML = `<div style="padding:12px; color: rgba(156,163,175,95);">Kalan borÃ§ yok ðŸŽ‰</div>`;
                return;
            }

            const rows = displayList.map(o => `

    <tr>
      <td>${formatDateShortTR(o.date)}</td>
      <td style="text-align:right;">${o.remainingQty}</td>
      <td style="text-align:right;">${formatMoneyTR(Number(o.unitPrice || 0))} â‚º</td>
      <td style="text-align:right;">${formatMoneyTR(o.remainingQty * Number(o.unitPrice || 0))} â‚º</td>
      <td style="text-align:right; white-space:nowrap;">
        <button class="ico-btn ico-edit" data-debt-act="edit" data-id="${o.id}">âœï¸</button>
        <button class="ico-btn ico-del"  data-debt-act="del"  data-id="${o.id}">ðŸ—‘ï¸</button>
      </td>
    </tr>
  `).join("");

            // âœ… debtTableHost zaten class="table-wrap" olduÄŸu iÃ§in sadece table basÄ±yoruz
            debtHost.innerHTML = `
    <table class="debt-table compact">
      <thead>
        <tr>
          <th>Tarih</th>
          <th style="text-align:right;">Kalan</th>
          <th style="text-align:right;">Birim</th>
          <th style="text-align:right;">Tutar</th>
          <th style="text-align:right;">Ä°ÅŸlem</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;

            /* edit/sil */
            debtHost.querySelectorAll("button[data-debt-act]").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = Number(btn.dataset.id);
                    const act = btn.dataset.debtAct;

                    if (act === "del") {
                        deleteOrder(id, () => {
                            showToast("SipariÅŸ Silindi âŒ", "error");
                            renderDebtTable();
                        });
                    }

                    if (act === "edit") {
                        startEditOrder(id);
                        closeDebtModal();
                    }
                });
            });
        }


        /* ===== WhatsApp mesajÄ± (2. gÃ¶rseldeki gibi) ===== */
        function pad(str, len) {
            str = String(str);
            return str.length >= len ? str : (str + " ".repeat(len - str.length));
        }

        function buildDebtWhatsappMessage(list) {
            // Mobilde satÄ±r taÅŸmamasÄ± iÃ§in "kompakt" format
            // Ã–r: 16.01  6x120=720â‚º

            const rows = list.map(o => {
                const d = formatDateShortTR(o.date);     // 16.01.2026
                const tarih = d.slice(0, 5);             // 16.01 (kÄ±salt)
                const adet = Number(o.remainingQty || 0);
                const birim = Number(o.unitPrice || 0);
                const tutar = adet * birim;

                // .00 istemiyorsan 0 yapabilirsin, ÅŸimdilik sade:
                const birimTxt = (Math.round(birim * 100) / 100).toString();
                const tutarTxt = (Math.round(tutar * 100) / 100).toString();

                return `${tarih}  ${adet}x${birimTxt}=${tutarTxt}â‚º`;
            });

            const totalQty = list.reduce((s, x) => s + Number(x.remainingQty || 0), 0);
            const totalTl = list.reduce((s, x) => s + (Number(x.remainingQty || 0) * Number(x.unitPrice || 0)), 0);

            return "```" + "\n"
                + "KALAN BORCLAR\n"
                + rows.join("\n") + "\n"
                + "----------------\n"
                + `TOPLAM: ${totalQty} adet | ${Math.round(totalTl * 100) / 100}â‚º\n`
                + "```";
        }


        document.getElementById("btnDebtWhatsapp")?.addEventListener("click", () => {
            const phone = (settings.whatsapp || "").replace(/\D/g, "");
            if (!phone || phone.length < 10) {
                uiOpen({ title: "Hata", subtitle: "WhatsApp numarasÄ± yok", body: "Ayarlarâ€™dan 90 ile baÅŸlayacak ÅŸekilde kaydet.", okText: "Tamam", showCancel: false });
                return;
            }

            const list = getDebtItems();
            if (list.length === 0) {
                uiOpen({ title: "Bilgi", subtitle: "Kalan borÃ§ yok", body: "GÃ¶nderilecek liste bulunamadÄ±.", okText: "Tamam", showCancel: false });
                return;
            }

            const message = buildDebtWhatsappMessage(list);
            openWhatsApp(phone, message)
        });
        function getTrashItems() {
            const o = (orders || []).filter(x => x.deletedAt).map(x => ({ type: "order", item: x }));
            const p = (payments || []).filter(x => x.deletedAt).map(x => ({ type: "payment", item: x }));
            // en son silinen Ã¼stte
            return [...o, ...p].sort((a, b) => Number(b.item.deletedAt || 0) - Number(a.item.deletedAt || 0));
        }

        function updateTrashBadge() {
            const n = getTrashItems().length;
            const el = document.getElementById("trashBadgeInline");
            if (el) el.textContent = n > 0 ? `(${n})` : "";
        }


        function openTrash() {
            const m = document.getElementById("trashModal");
            if (!m) return;
            renderTrash();
            m.classList.remove("hidden");
            m.setAttribute("aria-hidden", "false");
        }

        function closeTrash() {
            const m = document.getElementById("trashModal");
            if (!m) return;
            m.classList.add("hidden");
            m.setAttribute("aria-hidden", "true");
        }

        function restoreTrash(type, id) {
            if (type === "order") {
                const idx = (orders || []).findIndex(x => Number(x.id) === Number(id));
                if (idx > -1) {
                    delete orders[idx].deletedAt;
                    saveOrders(orders);
                    restoreOrderOnSheet?.(id);
                    syncOrdersFromSheet?.();
        
                    renderOrders?.(); renderSummary?.();
                    if (typeof renderDebtTable === "function") renderDebtTable();
                }
            }
            if (type === "payment") {
                const idx = (payments || []).findIndex(x => Number(x.id) === Number(id));
                if (idx > -1) {
                    delete payments[idx].deletedAt;
                    savePayments(payments);
                    restorePaymentOnSheet?.(id);
                    syncOrdersFromSheet?.();

                    recomputePaidFromPayments?.();
                    renderPayHistory?.();
                    renderOrders?.(); renderSummary?.();
                    if (typeof renderDebtTable === "function") renderDebtTable();
                }
            }
            showToast("Geri yÃ¼klendi âœ…", "success");
            renderTrash();
            updateTrashBadge();
        }

        function purgeTrash(type, id) {
            if (type === "order") {
                orders = (orders || []).filter(x => Number(x.id) !== Number(id));
                saveOrders(orders);
                renderOrders?.(); renderSummary?.();
                if (typeof renderDebtTable === "function") renderDebtTable();
            }
            if (type === "payment") {
                payments = (payments || []).filter(x => Number(x.id) !== Number(id));
                savePayments(payments);
                autoBackupIfNeeded("Ã–deme iÅŸlendi").catch(console.warn);

                recomputePaidFromPayments?.();
                renderPayHistory?.();
                renderOrders?.(); renderSummary?.();
                if (typeof renderDebtTable === "function") renderDebtTable();
            }
            showToast("KalÄ±cÄ± silindi.", "info");
            renderTrash();
            updateTrashBadge();
        }

        function renderTrash() {
            const host = document.getElementById("trashHost");
            if (!host) return;

            const list = getTrashItems();
            if (list.length === 0) {
                host.innerHTML = `<div style="padding:12px; color: rgba(156,163,175,.95);">Ã‡Ã¶p kutusu boÅŸ.</div>`;
                return;
            }

            host.innerHTML = list.map(x => {
                const it = x.item;
                const when = new Date(it.deletedAt || Date.now()).toLocaleString("tr-TR");
                if (x.type === "order") {
                    const name = (it.product === "damacana") ? "Damacana" : "0,5L Pet";
                    const qty = Number(it.qty || 0);
                    const total = Number(it.total || 0);
                    const sipTarih = formatDateTR(it.date);

                    return `
                            <div class="trash-row">
                            <div style="min-width:0;">
                                <div class="trash-pill">SipariÅŸ</div>
                                <div class="trash-meta">${name} â€¢ ${qty} adet â€¢ ${formatMoneyTR(total)} â‚º</div>
                                <div class="trash-sub">SipariÅŸ: ${sipTarih}<br>Silinme: ${when}</div>
                            </div>
                            <div class="trash-actions">
                                <button class="mini-btn edit" data-tr-restore="${it.id}" data-tr-type="order">Geri YÃ¼kle</button>
                                <button class="mini-btn del" data-tr-purge="${it.id}" data-tr-type="order">KalÄ±cÄ± Sil</button>
                            </div>
                            </div>`;
                } else {
                    const line = `${formatDateTR(it.date).split(" ")[0]} | ${Number(it.qty || 0)} adet | ${Number(it.amount || 0).toFixed(2)} â‚º`;
                    const note = `Not: ${it.note || "-"}`;
                    return `
                            <div class="trash-row">
                                <div>
                                <div class="trash-pill">Ã–deme</div>
                                <div class="trash-meta">${line}</div>
                                <div class="trash-sub">${note}\nSilinme: ${when}</div>
                                </div>
                                <div class="trash-actions">
                                <button class="mini-btn edit" data-tr-restore="${it.id}" data-tr-type="payment">Geri YÃ¼kle</button>
                                <button class="mini-btn del" data-tr-purge="${it.id}" data-tr-type="payment">KalÄ±cÄ± Sil</button>
                                </div>
                            </div>`;
                }
            }).join("");

            host.querySelectorAll("button[data-tr-restore]").forEach(b => {
                b.addEventListener("click", () => restoreTrash(b.dataset.trType, b.dataset.trRestore));
            });
            host.querySelectorAll("button[data-tr-purge]").forEach(b => {
                b.addEventListener("click", () => purgeTrash(b.dataset.trType, b.dataset.trPurge));
            });
        }

        document.getElementById("btnOpenTrash")?.addEventListener("click", openTrash);
        document.getElementById("trashBg")?.addEventListener("click", closeTrash);
        document.getElementById("trashX")?.addEventListener("click", closeTrash);
        document.getElementById("btnTrashClose")?.addEventListener("click", closeTrash);

        document.getElementById("btnTrashEmpty")?.addEventListener("click", () => {
            uiConfirm({
                title: "Ã‡Ã¶p Kutusu Temizlensin mi?",
                subtitle: "Bu iÅŸlem geri alÄ±namaz",
                body: "Ã‡Ã¶p kutusundaki tÃ¼m sipariÅŸ ve Ã¶demeler kalÄ±cÄ± silinecek.",
                okText: "Evet, Temizle",
                cancelText: "VazgeÃ§",
                onOk: () => {
                    orders = (orders || []).filter(x => !x.deletedAt);
                    payments = (payments || []).filter(x => !x.deletedAt);
                    saveOrders(orders);
                    savePayments(payments);

                    recomputePaidFromPayments?.();
                    renderOrders?.(); renderSummary?.();
                    renderPayHistory?.();
                    if (typeof renderDebtTable === "function") renderDebtTable();
                    renderTrash();
                    updateTrashBadge();
                    showToast("Ã‡Ã¶p kutusu temizlendi âœ…", "success");
                }
            });
        });

        // sayfa aÃ§Ä±lÄ±ÅŸÄ±nda sayaÃ§ gÃ¼ncellensin
        updateTrashBadge();
    document.querySelector(".card-settings")?.addEventListener("click", () => {
        if (!canAccessSettings()) {
            alert("Ayarlar sadece admin.");
            return;
        }
        openSettings?.();
    });

        /* ================== Ã–DEME MODALI (KÄ±smi Ã–deme) ================== */
        const payModal = document.getElementById("payModal");

        function setTodayToPayDate() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const el = document.getElementById("payDate");
            if (el) el.value = `${yyyy}-${mm}-${dd}`;
        }

        function openPayModal() {
            if (!payModal) return;
            setTodayToPayDate();

            const q = document.getElementById("payQty");
            const a = document.getElementById("payAmount");
            const n = document.getElementById("payNote");
            const info = document.getElementById("payCalcInfo");

            if (q) q.value = "";
            if (a) a.value = "";
            if (n) n.value = "";
            if (info) info.textContent = "";

            renderPayHistory();
            payModal.classList.remove("hidden");
            payModal.setAttribute("aria-hidden", "false");

            setTimeout(() => q?.focus(), 0);
            renderPayAfterInfo(0);

        }
        function startEditPayment(id) {
            const p = payments.find(x => Number(x.id) === Number(id));
            if (!p) return;

            editingPaymentId = Number(id);
            openPayModal();

            // alanlarÄ± doldur
            const dateEl = document.getElementById("payDate");
            if (dateEl) {
                // date input iÃ§in yyyy-mm-dd
                const d = new Date(p.date);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, "0");
                const dd = String(d.getDate()).padStart(2, "0");
                dateEl.value = `${yyyy}-${mm}-${dd}`;
            }

            const qtyEl = document.getElementById("payQty");
            const amtEl = document.getElementById("payAmount");
            const noteEl = document.getElementById("payNote");

            if (qtyEl) qtyEl.value = Number(p.qty || 0);
            if (amtEl) amtEl.value = Number(p.amount || 0).toFixed(2);
            if (noteEl) noteEl.value = p.note || "";

            // buton yazÄ±sÄ±
            const btn = document.getElementById("btnPayApply");
            if (btn) btn.textContent = "GÃ¼ncelle";

            // canlÄ± Ã¶zetleri bas
            renderPayAfterInfo(Number(p.qty || 0));
        }
        function deletePayment(id) {
            const p = payments.find(x => Number(x.id) === Number(id));
            if (!p) return;

            const preview =
                `${formatDateTR(p.date).split(" ")[0]} | ${Number(p.qty || 0)} adet | ${Number(p.amount || 0).toFixed(2)} â‚º
` +
                `Not: ${p.note || "-"}`;

            uiConfirm({
                title: "Ã–demeyi Sil",
                subtitle: "Ã–deme Ã§Ã¶p kutusuna taÅŸÄ±nacak (istersen sonra kalÄ±cÄ± silebilirsin)",
                body: preview,
                okText: "Ã‡Ã¶pe TaÅŸÄ±",
                cancelText: "VazgeÃ§",
                onOk: () => {
                    const idx = payments.findIndex(x => Number(x.id) === Number(id));
                    if (idx === -1) return;

                    payments[idx].deletedAt = Date.now();
                    archivePaymentOnSheet(id);      // Google'da pasife Ã§ek + dagitim geri al
                    syncOrdersFromSheet?.();        // 1 dk beklemeden hemen gÃ¼nceli Ã§ek
                    savePayments(payments);


                    // âœ… Ã¶nce Ã¶deme tablosundan dÃ¼ÅŸsÃ¼n, sonra tÃ¼m hesaplar gÃ¼ncellensin
                    renderPayHistory();
                    recomputePaidFromPayments();
                    renderOrders?.();
                    renderSummary?.();
                    if (typeof renderDebtTable === "function") renderDebtTable();
                    updateTrashBadge?.();

                    showToast("Ã–deme Ã§Ã¶p kutusuna taÅŸÄ±ndÄ± ðŸ—‘ï¸", "info");
                }
            });
        }

        function closePayModal() {
            if (!payModal) return;
            payModal.classList.add("hidden");
            payModal.setAttribute("aria-hidden", "true");
            editingPaymentId = null;
            const btn = document.getElementById("btnPayApply");
            if (btn) btn.textContent = "Ã–deme Yap";
        }

        document.querySelector(".card-payment")?.addEventListener("click", openPayModal);
        document.getElementById("closePayBg")?.addEventListener("click", closePayModal);
        document.getElementById("closePayX")?.addEventListener("click", closePayModal);
        document.getElementById("btnPayCancel")?.addEventListener("click", closePayModal);

        let payLock = false;

        // Adet deÄŸiÅŸince -> tutar hesapla
        document.getElementById("payQty")?.addEventListener("input", () => {
            if (payLock) return;
            payLock = true;

            const qty = Number(document.getElementById("payQty")?.value || 0);
            const cost = fifoCostForQty(qty);

            const amountEl = document.getElementById("payAmount");
            if (amountEl) amountEl.value = (qty > 0 ? cost.toFixed(2) : "");

            const info = document.getElementById("payCalcInfo");
            if (info) {
                const maxPossible = getDebtItems().reduce((s, x) => s + Number(x.remainingQty || 0), 0);
                info.textContent = qty > 0
                    ? `FIFOâ€™ya gÃ¶re ${qty} adet = ${cost.toFixed(2)} â‚º`
                    : `Kalan borÃ§: ${maxPossible} adet`;
            }
            renderPayAfterInfo(qty);

            payLock = false;
        });

        // Tutar deÄŸiÅŸince -> adet hesapla
        document.getElementById("payAmount")?.addEventListener("input", () => {
            if (payLock) return;
            payLock = true;

            const amount = Number(document.getElementById("payAmount")?.value || 0);
            const qty = fifoQtyForAmount(amount);
            const exact = fifoCostForQty(qty);

            const qtyEl = document.getElementById("payQty");
            if (qtyEl) qtyEl.value = (amount > 0 ? qty : "");

            const info = document.getElementById("payCalcInfo");
            if (info) {
                info.textContent = amount > 0
                    ? `FIFOâ€™ya gÃ¶re ${amount.toFixed(2)} â‚º â†’ ${qty} adet (uygulanacak: ${exact.toFixed(2)} â‚º)`
                    : "";
            }
            renderPayAfterInfo(qty);

            payLock = false;
        });

        function renderPayHistory() {
            const host = document.getElementById("payHistoryHost");
            if (!host) return;

            // âœ… sadece silinmeyen Ã¶demeler gÃ¶rÃ¼nsÃ¼n
            const visiblePayments = (payments || []).filter(p => !p.deletedAt);

            if (!visiblePayments.length) {
                host.innerHTML = `<div style="padding:12px; color: rgba(156,163,175,.95);">HenÃ¼z Ã¶deme yok.</div>`;
                return;
            }

            // âœ… en yeni en Ã¼stte
            const sorted = visiblePayments.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            const rows = sorted.map(p => `
        <tr class="pay-row" data-pay-id="${p.id}">
            <td>${formatDateTR(p.date).split(" ")[0]}</td>
            <td>${p.firma || ""}</td>
            <td class="td-num">${Number(p.qty || 0)}</td>
            <td class="td-num">${Number(p.amount || 0).toFixed(2)} â‚º</td>
            <td class="note">${p.note || ""}</td>
            <td class="td-right">
            <button class="ico-btn ico-del" data-pay-del="${p.id}" title="Sil">ðŸ—‘ï¸</button>
            </td>
        </tr>
        `).join("");

            host.innerHTML = `
    <table class="pay-table">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Firma</th>
          <th>Adet</th>
          <th>Tutar</th>
          <th>Not</th><th class="td-right">Ä°ÅŸlem</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

            // satÄ±ra tÄ±klayÄ±nca dÃ¼zenle
            host.querySelectorAll("tr.pay-row").forEach(tr => {
                tr.addEventListener("click", (e) => {
                    // Ã§Ã¶p ikonuna basÄ±ldÄ±ysa satÄ±r click Ã§alÄ±ÅŸmasÄ±n
                    if (e.target && e.target.matches("button[data-pay-del]")) return;
                    const id = Number(tr.dataset.payId);
                    startEditPayment(id);
                });
            });

            // Ã§Ã¶p ikonuna tÄ±klayÄ±nca sil (Ã§Ã¶p kutusuna taÅŸÄ±)
            host.querySelectorAll("button[data-pay-del]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                   const pid = Number(btn.dataset.payDel);
                    deletePayment(pid); // UI anÄ±nda
                    archivePaymentOnSheet(pid)
                        .then(() => syncPaymentsFromSheet())
                        .catch(console.warn);
                });
            });
        }


        document.getElementById("btnPayApply")?.addEventListener("click", () => {
            const qty = Number(document.getElementById("payQty")?.value || 0);
            if (!qty || qty < 1) {
                const info = document.getElementById("payCalcInfo");
                if (info) info.textContent = "â— LÃ¼tfen geÃ§erli bir adet gir.";
                return;
            }

            const dateVal = document.getElementById("payDate")?.value;
            const dateIso = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();

            const amount = fifoCostForQty(qty);
            const note = String(document.getElementById("payNote")?.value || "").trim();



            // 2) Ã¶deme geÃ§miÅŸine kaydet
            const firma = (settings?.firmaAdi || "").trim();

            if (editingPaymentId != null) {
                const idx = payments.findIndex(x => Number(x.id) === Number(editingPaymentId));
                if (idx > -1) {
                    payments[idx] = {
                        ...payments[idx],
                        date: dateIso,
                        firma,
                        qty,
                        amount: Number(document.getElementById("payAmount")?.value || amount), // kullanÄ±cÄ± deÄŸiÅŸtirdiyse
                        note
                    };
                    updatePaymentOnSheet(payments[pIdx]).catch(console.warn);

                    savePayments(payments);
                    updatePaymentOnSheet({
                        id: Number(editingPaymentId),
                        tarih: String(dateVal || "").trim(),                 // yyyy-mm-dd input
                        firma,
                        adet: Number(qty || 0),
                        tutarGirilen: Number(document.getElementById("payAmount")?.value || amount),
                        not: note
                    });
                    syncOrdersFromSheet?.();

                    recomputePaidFromPayments();
                    renderPayHistory();
                    editingPaymentId = null;

                    const btn = document.getElementById("btnPayApply");
                    if (btn) btn.textContent = "Uygula";
                    showToast("Ã–deme gÃ¼ncellendi âœ…", "success");

                    closePayModal();
                    return;
                }
            }
            // 1) sipariÅŸ borÃ§larÄ±ndan dÃ¼ÅŸ (mevcut sistem)
            applyPaymentFIFO(qty);
            // yeni Ã¶deme
            payments.push({
                id: Date.now(),
                date: dateIso,
                firma,
                qty,
                amount: Number(document.getElementById("payAmount")?.value || amount),
                note
            });
            applyPaymentOnSheet(payments[payments.length - 1]).catch(console.warn);
            syncPaymentsFromSheet();

            savePayments(payments);
            
            recomputePaidFromPayments();
            renderPayHistory();
            showToast(`Ã–deme iÅŸlendi âœ… (${qty} adet)`, "success");

            closePayModal();
        });
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
                if (sessionStorage.getItem("fromWhatsapp") === "1") {
                    sessionStorage.removeItem("fromWhatsapp");

                    // ðŸ‘‰ burada ne istiyorsan yapabilirsin
                    handleBackFromWhatsapp();
                }
            }
        });
        function handleBackFromWhatsapp() {
            // aÃ§Ä±k popup varsa kapat
            document.querySelectorAll(".modal, .popup").forEach(p => p.remove());

            showToast("WhatsApp mesajÄ± gÃ¶nderildi âœ…", "success");
            showToast("Geri hoÅŸ geldin ðŸ‘‹", "info");
        }
        // ðŸ”¤ TÃ¼rkÃ§e karakterleri koruyarak bÃ¼yÃ¼k harfe Ã§evir
        function toTurkishUpper(str) {
            return str
                .replace(/i/g, "Ä°")
                .replace(/Ä±/g, "I")
                .replace(/ÄŸ/g, "Äž")
                .replace(/Ã¼/g, "Ãœ")
                .replace(/ÅŸ/g, "Åž")
                .replace(/Ã¶/g, "Ã–")
                .replace(/Ã§/g, "Ã‡")
                .toUpperCase();
        }
        document.addEventListener("input", (e) => {
            const el = e.target;

            // âŒ number, tel, email, password vs. DOKUNMA
            if (el.tagName === "INPUT") {
                if (["number", "tel", "email", "password", "date", "time"].includes(el.type)) {
                    return;
                }
            }

            // âœ… SADECE text, search ve textarea
            if (
                (el.tagName === "INPUT" && (el.type === "text" || el.type === "search")) ||
                el.tagName === "TEXTAREA"
            ) {
                const pos = el.selectionStart;
                el.value = toTurkishUpper(el.value);
                el.setSelectionRange(pos, pos);
            }
        });

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                
            }
        });
        function initPayTabs() {
            const tabs = document.getElementById("payTabs");
            const tabPay = document.getElementById("tabPay");
            const tabHistory = document.getElementById("tabHistory");
            if (!tabs || !tabPay || !tabHistory) return;

            function setTab(which) {
                tabPay.classList.toggle("hidden", which !== "pay");
                tabHistory.classList.toggle("hidden", which !== "history");

                tabs.querySelectorAll(".tab-btn").forEach(btn => {
                    btn.classList.toggle("active", btn.dataset.tab === which);
                });
            }

            tabs.addEventListener("click", (e) => {
                const btn = e.target.closest(".tab-btn");
                if (!btn) return;
                setTab(btn.dataset.tab);
            });

            // default
            setTab("pay");
        }

        // Sayfa aÃ§Ä±lÄ±nca 1 kere kur
        document.addEventListener("DOMContentLoaded", initPayTabs);
    document.getElementById("btnPayRefresh")?.addEventListener("click", async () => {
            try {
                await syncPaymentsFromSheet();
                showToast?.("Google ile eÅŸitlendi", "success");
            } catch (e) {
                console.warn(e);
                showToast?.("Google ile eÅŸitlenemdi", "error");
            }
        });
        

       // âœ… TEK formatHHMM (iki yerde tekrar etmeye gerek yok)
        function formatHHMM(d) {
            const hh = String(d.getHours()).padStart(2, "0");
            const mm = String(d.getMinutes()).padStart(2, "0");
            return `${hh}:${mm}`;
        }

        // âœ… Ã–DEME: Son senkron yazÄ±sÄ±
        function setPayLastSync(dateObj) {
            const el = document.getElementById("payLastSync");
            if (!el) return;
            el.textContent = `Son senkron: ${formatHHMM(dateObj)}`;
        }

        // âœ… SÄ°PARÄ°Åž: Son senkron yazÄ±sÄ±
        function setOrdersLastSync(dateObj) {
            const el = document.getElementById("ordersLastSyncText");
            if (!el) return;
            el.textContent = `Son senkron: ${formatHHMM(dateObj)}`;
        }

        // âœ… Ã–DEME mini refresh (TEK handler)
        document.getElementById("btnPayRefresh")?.addEventListener("click", async () => {
            const btn = document.getElementById("btnPayRefresh");
            if (!btn) return;

            btn.classList.add("is-spinning");
            try {
                await syncPaymentsFromSheet();
                setPayLastSync(new Date());
                showToast?.("Google ile eÅŸitlendi", "success");
            } catch (e) {
                console.warn(e);
                showToast?.("Google ile eÅŸitlenemedi", "error");
            } finally {
                btn.classList.remove("is-spinning");
            }
        });

        
        // ===== SeÃ§ili Ay Ã–zeti Detay AÃ§ / Kapa =====
        (function () {
            const btn = document.getElementById("btnMonthDetailsToggle");
            const wrap = document.getElementById("monthDetailsWrap");
            if (!btn || !wrap) return;

            // default kapalÄ±
            wrap.classList.add("is-hidden");
            btn.setAttribute("aria-expanded", "false");

            btn.addEventListener("click", () => {
                const kapali = wrap.classList.toggle("is-hidden");
                btn.setAttribute("aria-expanded", String(!kapali));
                btn.textContent = kapali ? "Detay" : "Detay â–²";
            });
        })();

        document.addEventListener("click", (e) => {
            // drop menÃ¼ler: butona veya menÃ¼nÃ¼n iÃ§ine tÄ±klanmadÄ±ysa kapat
            const clickedInsideDrop = e.target.closest(".drop");
            if (!clickedInsideDrop) closeAllDropMenus();

            // accordion: summary/acc iÃ§i deÄŸilse kapat
            const clickedInsideAcc = e.target.closest("details.acc");
            if (!clickedInsideAcc) closeAllAccordions();
        });
// ===============================
// AUTO LOGOUT (inactivity timeout)
// ===============================
const IDLE_LIMIT_MS = 300 * 1000; // 5 dakika
let _idleTimer = null;

function startIdleTimer(){
  stopIdleTimer();
  _idleTimer = setTimeout(() => {
    // sÃ¼re doldu: oturumu kapat
    autoLogoutDueToIdle();
  }, IDLE_LIMIT_MS);
}

function stopIdleTimer(){
  if (_idleTimer) clearTimeout(_idleTimer);
  _idleTimer = null;
}

function bumpIdleTimer(){
  // kullanÄ±cÄ± etkileÅŸimi geldi
  if (!currentUser) return;              // login yoksa takip etme
  if (document.body.classList.contains("is-locked")) return; // login ekranÄ±ndaysa takip etme
  startIdleTimer();
}

function autoLogoutDueToIdle(){
  // âœ… login ekranÄ±na dÃ¶n + session temizle
  try{
    // UI mesajÄ± (varsa)
    setAuthMsg?.("Oturum sÃ¼resi doldu. Tekrar giriÅŸ yapÄ±n.", 0);

    // session temizle (senin fonksiyonlarÄ±n)
    clearSession?.();          // varsa
  }catch(e){}

  // currentUser sÄ±fÄ±rla
  currentUser = null;

  // âœ… appâ€™i kilitle (login modali aÃ§Ä±lÄ±r)
  setAppLocked(true);

  // âœ… arka plan verisini temizlemek istersen (opsiyonel):
  // clearLocalCachesForView();

  // login ekranÄ± aÃ§
  openAuth?.();
  openAuth();

  // timerâ€™Ä± durdur (login ekranÄ±nda boÅŸuna Ã§alÄ±ÅŸmasÄ±n)
  stopIdleTimer();
}

// KullanÄ±cÄ±nÄ±n â€œhareketâ€ sayÄ±lacak aksiyonlarÄ±
["mousemove","mousedown","keydown","touchstart","scroll","click"].forEach(evt => {
  document.addEventListener(evt, bumpIdleTimer, { passive: true });
});
// ===============================
// BACKGROUND MODE: sync pause/resume
// ===============================
let bgPaused = false;
let __syncIntervals = [];        // setInterval id'leri burada toplayacaÄŸÄ±z
let __inflightAbort = null;      // fetch iptal iÃ§in (opsiyonel)

function registerInterval(id){
  if (id) __syncIntervals.push(id);
  return id;
}

function stopAllSyncIntervals(){
  __syncIntervals.forEach(id => { try { clearInterval(id); } catch(e){} });
  __syncIntervals = [];
}

// EÄŸer fetch ile GS sync yapÄ±yorsan iptal edebilmek iÃ§in (opsiyonel)
function makeAbortController(){
  try{
    if (__inflightAbort) __inflightAbort.abort();
  }catch(e){}
  __inflightAbort = new AbortController();
  return __inflightAbort;
}

function pauseBackgroundWork(){
  if (bgPaused) return;
  bgPaused = true;

  // âœ… AUTO REFRESHâ€™i de durdur
  stopAutoRefresh();

  // mevcut sistemin intervalâ€™larÄ±nÄ± da durdur
  stopAllSyncIntervals();

  try{ inflightAbort?.abort(); }catch(e){}
}


function resumeForegroundWork(){
  if (!bgPaused) return;
  bgPaused = false;

  if (!currentUser?.username) return;

  if (document.hidden) return;
  if (document.body.classList.contains("is-locked")) return;

  startAutoRefresh();
}


// Sekme gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸince yakala
document.addEventListener("visibilitychange", () => {
  if (document.hidden) pauseBackgroundWork();
  else resumeForegroundWork();
});

// Mobilde ekstra garanti: sayfa arkaplana giderken de yakalar
window.addEventListener("pagehide", pauseBackgroundWork);
window.addEventListener("freeze", pauseBackgroundWork);   // bazÄ± browserlar destekler
window.addEventListener("focus", resumeForegroundWork);
window.addEventListener("blur", () => {
  // blur bazen false-positive, yine de istersen kapat:
  // pauseBackgroundWork();
});


    </script>
    <!-- Toast Container -->
    <div id="toastHost"></div>

</body>

</html>